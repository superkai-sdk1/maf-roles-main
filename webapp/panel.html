<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Maf roles control panel</title>
    <script>
        // Cache-busting: уникальный параметр для каждой загрузки страницы
        window.__v = Date.now();

        // Раннее применение темы из localStorage (до рендеринга) — предотвращает мигание дефолтной темы
        (function() {
            try {
                var colorSchemes = {
                    'purple': { accent: '#a855f7', gradient: 'linear-gradient(135deg, #1a1625 0%, #2d1b47 25%, #1f1a3a 50%, #2a1f45 75%, #1a1625 100%)' },
                    'blue': { accent: '#4fc3f7', gradient: 'linear-gradient(135deg, #0e1a2e 0%, #1b2844 25%, #142235 50%, #1f2d47 75%, #0e1a2e 100%)' },
                    'green': { accent: '#6fe7b7', gradient: 'linear-gradient(135deg, #0b1f14 0%, #183326 25%, #13251e 50%, #1d382b 75%, #0b1f14 100%)' },
                    'red': { accent: '#e63946', gradient: 'linear-gradient(135deg, #2b1017 0%, #4a1e28 25%, #381a21 50%, #4a2631 75%, #2b1017 100%)' },
                    'orange': { accent: '#ffb347', gradient: 'linear-gradient(135deg, #2a1a0e 0%, #453218 25%, #3a2816 50%, #453a1f 75%, #2a1a0e 100%)' },
                    'pink': { accent: '#ff6fcb', gradient: 'linear-gradient(135deg, #2b1224 0%, #4a1f41 25%, #381d34 50%, #4a2746 75%, #2b1224 100%)' },
                    'yellow': { accent: '#ffe066', gradient: 'linear-gradient(135deg, #29240e 0%, #443f18 25%, #393416 50%, #44431f 75%, #29240e 100%)' },
                    'teal': { accent: '#1de9b6', gradient: 'linear-gradient(135deg, #0e2925 0%, #194440 25%, #163934 50%, #1f4446 75%, #0e2925 100%)' },
                    'gold': { accent: '#ffd700', gradient: 'linear-gradient(135deg, #291e09 0%, #443a14 25%, #393111 50%, #443f1b 75%, #291e09 100%)' },
                    'silver': { accent: '#b0c4de', gradient: 'linear-gradient(135deg, #1b1d1f 0%, #34393e 25%, #292d31 50%, #393f44 75%, #1b1d1f 100%)' },
                    'aqua': { accent: '#00eaff', gradient: 'linear-gradient(135deg, #092329 0%, #143f49 25%, #113439 50%, #1b444f 75%, #092329 100%)' },
                    'lime': { accent: '#cddc39', gradient: 'linear-gradient(135deg, #19290e 0%, #2f4418 25%, #24391b 50%, #33441f 75%, #19290e 100%)' },
                    'violet': { accent: '#9f5afd', gradient: 'linear-gradient(135deg, #1e1324 0%, #342441 25%, #291d34 50%, #392746 75%, #1e1324 100%)' },
                    'brown': { accent: '#a0522d', gradient: 'linear-gradient(135deg, #1e130f 0%, #39271f 25%, #2e2019 50%, #3f2f24 75%, #1e130f 100%)' },
                    'black': { accent: '#222', gradient: 'linear-gradient(135deg, #090909 0%, #191919 25%, #141414 50%, #1f1f1f 75%, #090909 100%)' },
                    'mint': { accent: '#98ff98', gradient: 'linear-gradient(135deg, #0e2919 0%, #19442f 25%, #143729 50%, #1f443f 75%, #0e2919 100%)' },
                    'peach': { accent: '#ffb07c', gradient: 'linear-gradient(135deg, #291714 0%, #492f29 25%, #37251f 50%, #493731 75%, #291714 100%)' },
                    'sky': { accent: '#87ceeb', gradient: 'linear-gradient(135deg, #111f29 0%, #243746 25%, #192e39 50%, #243f4f 75%, #111f29 100%)' },
                    'rose': { accent: '#ff007f', gradient: 'linear-gradient(135deg, #290e19 0%, #491e34 25%, #371624 50%, #49243f 75%, #290e19 100%)' },
                    'olive': { accent: '#808000', gradient: 'linear-gradient(135deg, #19190e 0%, #322f18 25%, #272716 50%, #34341f 75%, #19190e 100%)' },
                    'navy': { accent: '#001f54', gradient: 'linear-gradient(135deg, #090e19 0%, #141f29 25%, #0f1721 50%, #19242f 75%, #090e19 100%)' },
                    'coral': { accent: '#ff7f50', gradient: 'linear-gradient(135deg, #29150e 0%, #492c18 25%, #372316 50%, #49341f 75%, #29150e 100%)' },
                    'sand': { accent: '#ffe4b5', gradient: 'linear-gradient(135deg, #292319 0%, #443f39 25%, #39342f 50%, #444439 75%, #292319 100%)' },
                    'plum': { accent: '#8e4585', gradient: 'linear-gradient(135deg, #1e1119 0%, #341f29 25%, #291921 50%, #39242f 75%, #1e1119 100%)' },
                    'ice': { accent: '#b2f7ef', gradient: 'linear-gradient(135deg, #142229 0%, #243f46 25%, #193439 50%, #24444f 75%, #142229 100%)' },
                    'fire': { accent: '#ff512f', gradient: 'linear-gradient(135deg, #290e09 0%, #491e14 25%, #371611 50%, #49241b 75%, #290e09 100%)' },
                    'forest': { accent: '#228b22', gradient: 'linear-gradient(135deg, #09190e 0%, #142918 25%, #112116 50%, #192f1f 75%, #09190e 100%)' },
                    'steel': { accent: '#4682b4', gradient: 'linear-gradient(135deg, #14171f 0%, #242c34 25%, #1e2429 50%, #29343f 75%, #14171f 100%)' },
                    'ruby': { accent: '#e0115f', gradient: 'linear-gradient(135deg, #290914 0%, #491424 25%, #37111e 50%, #49192f 75%, #290914 100%)' },
                    'amber': { accent: '#ffbf00', gradient: 'linear-gradient(135deg, #291e09 0%, #443414 25%, #392c11 50%, #443f1b 75%, #291e09 100%)' }
                };
                var bgThemes = {
                    'ultradark': '#020208', 'dark': '#060612', 'default': '#040410',
                    'light': '#f5f6fa', 'ultralight': '#ffffff'
                };
                var savedColor = localStorage.getItem('maf_color_scheme');
                var savedBg = localStorage.getItem('maf_bg_theme');
                if (savedColor && colorSchemes[savedColor]) {
                    document.documentElement.style.setProperty('--maf-accent-color', colorSchemes[savedColor].accent);
                    document.documentElement.style.setProperty('--maf-gradient-bg', colorSchemes[savedColor].gradient);
                }
                if (savedBg && bgThemes[savedBg]) {
                    document.documentElement.style.setProperty('--maf-bg-main', bgThemes[savedBg]);
                }
            } catch(e) {}
        })();

        // Обработка ошибок Telegram WebApp
        window.addEventListener('error', (e) => {
            if (e.filename && e.filename.includes('telegram-web-app.js')) {
                console.warn('⚠️ Ошибка в Telegram WebApp скрипте (игнорируется):', e.message);
                e.preventDefault();
            }
        });
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js" onerror="console.warn('⚠️ Не удалось загрузить Telegram WebApp скрипт')"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script>
        // Динамическая загрузка локальных CSS с cache-busting
        [
            '../assets/font-akrobat/css.css',
            '../assets/flex.css',
            './styles-panel.css',
            './login/auth.css'
        ].forEach(function(href) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href + '?v=' + window.__v;
            document.head.appendChild(link);
        });
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css">
    
    <!-- Стили для отключения зума и адаптации под Telegram Mini Apps -->
    <style>
        /* Глобальный сброс box-sizing для предсказуемых размеров */
        *, *:before, *:after {
            box-sizing: border-box;
        }

        /* Отключение зума и жестов */
        * {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
        }
        
        /* Разрешаем выделение текста в input полях */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        
        /* Предотвращение зума при двойном тапе */
        body {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        /* Telegram Mini Apps специфичные стили */
        .tg-app {
            height: 100vh; /* Fallback */
            height: var(--tg-viewport-height, 100vh);
            overflow: hidden;
        }

        /* Исправление для кликабельности убитых игроков на тач-устройствах */
        .player-inactive {
            pointer-events: auto;
            cursor: pointer;
        }
        
        /* Адаптация под безопасные зоны */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* --- GRID DASHBOARD STYLES FOR SCORES --- */
        .scores-list {
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            box-sizing: border-box;
            padding-top: 84px;
            padding-left: 16px;
            padding-right: 16px;
        }

        .score-card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(16px) saturate(140%);
            -webkit-backdrop-filter: blur(16px) saturate(140%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 18px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
            position: relative;
        }

        .score-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none;
        }

        .score-card.highlighted {
            background: rgba(var(--maf-accent-color-rgb, 168,85,247), 0.10);
            border-color: rgba(var(--maf-accent-color-rgb, 168,85,247), 0.30);
            box-shadow: 0 0 0 1px rgba(var(--maf-accent-color-rgb, 168,85,247),0.2), 0 8px 32px rgba(var(--maf-accent-color-rgb, 168,85,247),0.12);
            transform: scale(1.01);
            z-index: 10;
        }

        /* Top-3 elevated gradient cards */
        .score-card.top-gold {
            background: linear-gradient(135deg, rgba(255,215,0,0.10) 0%, rgba(255,215,0,0.03) 100%);
            border-color: rgba(255,215,0,0.35);
            box-shadow: 0 0 20px rgba(255,215,0,0.12), inset 0 1px 0 rgba(255,215,0,0.15);
            transform: translateY(-2px);
        }
        .score-card.top-silver {
            background: linear-gradient(135deg, rgba(192,192,192,0.08) 0%, rgba(192,192,192,0.02) 100%);
            border-color: rgba(192,192,192,0.30);
            box-shadow: 0 0 16px rgba(192,192,192,0.10), inset 0 1px 0 rgba(192,192,192,0.12);
            transform: translateY(-1px);
        }
        .score-card.top-bronze {
            background: linear-gradient(135deg, rgba(205,127,50,0.08) 0%, rgba(205,127,50,0.02) 100%);
            border-color: rgba(205,127,50,0.30);
            box-shadow: 0 0 14px rgba(205,127,50,0.10), inset 0 1px 0 rgba(205,127,50,0.12);
        }
        .score-card:not(.highlighted):not(.top-gold):not(.top-silver):not(.top-bronze):active {
            background: rgba(255,255,255,0.10);
        }

        .score-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            background: transparent;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .score-card.highlighted .score-header {
            background: linear-gradient(90deg, rgba(168,85,247,0.08) 0%, transparent 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .score-content {
            padding: 12px;
            background: rgba(0,0,0,0.20);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            width: 100%;
            position: relative;
            z-index: 1;
        }

        /* GRID LAYOUT */
        .score-dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            width: 100%;
        }

        .dashboard-cell {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 80px;
            width: 100%;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .dashboard-cell::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none;
        }

        .dashboard-cell.full-width {
            grid-column: 1 / -1;
            min-height: auto;
        }

        .cell-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
        }

        /* Opinion & Protocol Lists */
        .info-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-grow: 1;
            width: 100%;
        }

        .info-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85em;
            padding: 5px 10px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .info-text-mini {
            font-size: 0.9em;
            font-style: italic;
            color: #ccc;
            line-height: 1.4;
            padding: 4px;
            word-wrap: break-word;
        }

        /* Inputs */
        .math-input-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .math-input {
            width: 100%;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.08);
            color: #fff;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            font-family: 'Roboto Mono', monospace;
            font-size: 1.2em;
            font-weight: bold;
            outline: none;
            transition: all 0.2s;
            min-width: 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .math-input:focus {
            border-color: var(--maf-accent-color);
            background: rgba(0,0,0,0.35);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 0 2px var(--maf-accent-color);
        }

        .math-input.positive { color: #30d158; }
        .math-input.negative { color: #ff453a; }

        /* Status & Total */
        .status-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .total-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100%;
        }

        .total-value {
            font-size: 2em;
            font-weight: 900;
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
            color: #fff;
            text-shadow: 0 0 32px rgba(var(--maf-accent-color-rgb, 168,85,247),0.6), 0 0 8px rgba(var(--maf-accent-color-rgb, 168,85,247),0.25);
            line-height: 1;
        }

        .win-badge {
            font-size: 0.7em;
            background: rgba(255, 214, 10, 0.10);
            color: #ffd60a;
            padding: 3px 8px;
            border-radius: 8px;
            margin-top: 4px;
            white-space: nowrap;
            border: 1px solid rgba(255,214,10,0.20);
            font-weight: 700;
            text-shadow: 0 0 8px rgba(255,214,10,0.3);
        }

        /* Common Elements */
        .role-tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.72em;
            margin-left: 10px;
            font-weight: 800;
            text-transform: uppercase;
            white-space: nowrap;
            letter-spacing: 0.5px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .role-tag.peace {
            background: rgba(144,202,249,0.10); color: #90caf9;
            border: 1px solid rgba(144,202,249,0.20);
            box-shadow: 0 0 12px rgba(144,202,249,0.15);
        }
        .role-tag.sheriff {
            background: rgba(255,213,79,0.10); color: #ffd54f;
            border: 1px solid rgba(255,213,79,0.25);
            box-shadow: 0 0 12px rgba(255,213,79,0.18);
        }
        .role-tag.mafia {
            background: rgba(255,82,82,0.10); color: #ff5252;
            border: 1px solid rgba(255,82,82,0.25);
            box-shadow: 0 0 12px rgba(255,82,82,0.18);
        }
        .role-tag.don {
            background: rgba(206,147,216,0.10); color: #ce93d8;
            border: 1px solid rgba(206,147,216,0.25);
            box-shadow: 0 0 12px rgba(206,147,216,0.18);
        }

        /* City Mafia red roles */
        .role-tag.detective, .role-tag.jailer, .role-tag.prostitute, .role-tag.bodyguard,
        .role-tag.sleepwalker, .role-tag.journalist, .role-tag.doctor, .role-tag.priest,
        .role-tag.judge, .role-tag.kamikaze, .role-tag.immortal, .role-tag.beauty {
            background: rgba(76,175,80,0.10); color: #81c784;
            border: 1px solid rgba(76,175,80,0.25);
            box-shadow: 0 0 12px rgba(76,175,80,0.18);
        }

        /* City Mafia black roles */
        .role-tag.maniac, .role-tag.oyabun, .role-tag.yakuza, .role-tag.ripper,
        .role-tag.swindler, .role-tag.thief, .role-tag.snitch, .role-tag.fangirl, .role-tag.lawyer {
            background: rgba(255,82,82,0.10); color: #ff5252;
            border: 1px solid rgba(255,82,82,0.25);
            box-shadow: 0 0 12px rgba(255,82,82,0.18);
        }

        .player-num-badge {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 0.9em;
            color: #aaa;
            flex-shrink: 0;
        }

        .score-card.highlighted .player-num-badge {
            background: var(--maf-accent-color);
            color: #000;
        }

        .check-icon { color: #30d158; margin-left: 4px; }
        .cross-icon { color: #ff453a; margin-left: 4px; }

        .self-kill-status {
            color: #ff453a;
            font-weight: bold;
            font-size: 0.85em;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 69, 58, 0.5);
            animation: pulse-red 2s infinite;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            width: 100%;
        }

        @keyframes pulse-red {
            0% { text-shadow: 0 0 5px rgba(255, 69, 58, 0.3); opacity: 0.8; }
            50% { text-shadow: 0 0 15px rgba(255, 69, 58, 0.7); opacity: 1; }
            100% { text-shadow: 0 0 5px rgba(255, 69, 58, 0.3); opacity: 0.8; }
        }

        .empty-data {
            font-size: 0.8em;
            color: rgba(255,255,255,0.25);
            text-align: center;
            margin-top: auto;
            margin-bottom: auto;
        }

        /* ===== CYBER-GLASS DASHBOARD (funky summary) ===== */
        .dash-hero {
            display: flex; gap: 8px; margin-bottom: 10px;
        }
        .dash-hero-main {
            flex: 1.3;
            background: linear-gradient(135deg, rgba(var(--maf-accent-color-rgb, 168,85,247),0.12) 0%, rgba(var(--maf-accent-color-rgb, 168,85,247),0.04) 100%);
            border: 1px solid rgba(var(--maf-accent-color-rgb, 168,85,247),0.30);
            border-radius: 16px; padding: 16px 12px;
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
            box-shadow: 0 0 30px rgba(var(--maf-accent-color-rgb, 168,85,247),0.20), 0 0 80px rgba(var(--maf-accent-color-rgb, 168,85,247),0.06), inset 0 1px 0 rgba(255,255,255,0.10);
        }
        .dash-hero-main::before {
            content: ''; position: absolute; inset: 0; border-radius: 16px;
            background: linear-gradient(180deg, rgba(var(--maf-accent-color-rgb, 168,85,247),0.10) 0%, transparent 60%);
            pointer-events: none;
        }
        .dash-hero-label {
            font-size: 0.6em; text-transform: uppercase; letter-spacing: 1.5px;
            color: rgba(var(--maf-accent-color-rgb, 168,85,247),0.75); font-weight: 700; margin-bottom: 6px;
            display: flex; align-items: center; gap: 5px; position: relative; z-index: 1;
        }
        .dash-hero-value {
            font-size: 2.4em; font-weight: 900; color: #fff; line-height: 1;
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
            text-shadow: 0 0 32px rgba(var(--maf-accent-color-rgb, 168,85,247),0.6), 0 0 8px rgba(var(--maf-accent-color-rgb, 168,85,247),0.25);
            position: relative; z-index: 1;
        }
        .dash-hero-side {
            flex: 1;
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; padding: 14px 10px;
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .dash-hero-side::before {
            content: ''; position: absolute; inset: 0; border-radius: 16px;
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, transparent 50%);
            pointer-events: none;
        }
        .dash-hero-side-label {
            font-size: 0.6em; text-transform: uppercase; letter-spacing: 1.2px;
            color: rgba(255,255,255,0.45); font-weight: 700; margin-bottom: 4px;
            display: flex; align-items: center; gap: 5px; position: relative; z-index: 1;
        }
        .dash-hero-side-value {
            font-size: 1.6em; font-weight: 800; color: #fff; position: relative; z-index: 1;
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
        }
        .dash-misc-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .dash-misc-cell {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px; padding: 12px 10px;
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .dash-misc-cell::before {
            content: ''; position: absolute; inset: 0; border-radius: 14px;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        .dash-misc-label {
            font-size: 0.6em; text-transform: uppercase; letter-spacing: 1px;
            color: rgba(255,255,255,0.45); font-weight: 700; margin-bottom: 4px;
            display: flex; align-items: center; gap: 5px; position: relative; z-index: 1;
        }
        .dash-misc-value {
            font-size: 1.3em; font-weight: 800; color: #fff; position: relative; z-index: 1;
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
        }
        .dash-roles { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .dash-role-group {
            border-radius: 16px; padding: 12px 10px;
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            display: flex; flex-direction: column; gap: 8px;
            position: relative; overflow: hidden;
        }
        .dash-role-group::before {
            content: ''; position: absolute; inset: 0; border-radius: 16px;
            pointer-events: none;
        }
        .dash-role-group.peace-group {
            background: rgba(255,82,82,0.05); border: 1px solid rgba(255,82,82,0.15);
        }
        .dash-role-group.peace-group::before {
            background: linear-gradient(180deg, rgba(255,82,82,0.06) 0%, transparent 50%);
        }
        .dash-role-group.mafia-group {
            background: rgba(206,147,216,0.05); border: 1px solid rgba(206,147,216,0.15);
        }
        .dash-role-group.mafia-group::before {
            background: linear-gradient(180deg, rgba(206,147,216,0.06) 0%, transparent 50%);
        }
        .dash-group-title {
            font-size: 0.6em; text-transform: uppercase; letter-spacing: 1.5px;
            font-weight: 800; position: relative; z-index: 1;
            display: flex; align-items: center; gap: 5px;
        }
        .peace-group .dash-group-title { color: rgba(255,82,82,0.8); }
        .mafia-group .dash-group-title { color: rgba(206,147,216,0.8); }
        .dash-role-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px; padding: 10px; position: relative; z-index: 1;
            transition: opacity 0.3s;
        }
        .dash-role-card.inactive { opacity: 0.35; }
        .dash-role-name {
            font-size: 0.65em; text-transform: uppercase; letter-spacing: 1px;
            font-weight: 700; margin-bottom: 6px;
            display: flex; align-items: center; gap: 5px;
        }
        .dash-role-stats { display: flex; align-items: baseline; gap: 8px; margin-bottom: 6px; }
        .dash-role-played {
            font-size: 1.4em; font-weight: 800; color: #fff; line-height: 1;
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
        }
        .dash-role-wins { font-size: 0.75em; font-weight: 600; color: rgba(255,255,255,0.4); }
        .dash-progress { width: 100%; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.08); overflow: hidden; }
        .dash-progress-fill {
            height: 100%; border-radius: 2px;
            transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .dash-progress-fill.green { background: linear-gradient(90deg, #30d158, #34c759); box-shadow: 0 0 8px rgba(48,209,88,0.5); }
        .dash-progress-fill.red { background: linear-gradient(90deg, #ef5350, #ef9a9a); box-shadow: 0 0 8px rgba(239,83,80,0.4); }
        .dash-progress-fill.purple { background: linear-gradient(90deg, #9c64ff, #ce93d8); box-shadow: 0 0 8px rgba(156,100,255,0.4); }
        .dash-progress-fill.gold { background: linear-gradient(90deg, #ffd54f, #ffb300); box-shadow: 0 0 8px rgba(255,213,79,0.4); }
        .dash-icon { width: 14px; height: 14px; flex-shrink: 0; }
        .dash-icon-lg { width: 16px; height: 16px; flex-shrink: 0; }
        .dash-discipline {
            display: flex; align-items: center; justify-content: center; gap: 0;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px; padding: 10px 14px;
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            position: relative; overflow: hidden;
        }
        .dash-discipline::before {
            content: ''; position: absolute; inset: 0; border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 50%);
            pointer-events: none;
        }
        .dash-disc-item {
            display: flex; align-items: center; gap: 5px;
            font-size: 0.75em; font-weight: 600; color: rgba(255,255,255,0.4);
            position: relative; z-index: 1;
        }
        .dash-disc-item .disc-val {
            font-weight: 800; color: rgba(255,255,255,0.7);
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
        }
        .dash-disc-dot { width: 3px; height: 3px; border-radius: 50%; background: rgba(255,255,255,0.15); margin: 0 10px; flex-shrink: 0; }
        .dash-winrate-label {
            font-size: 0.6em; font-weight: 600; color: rgba(255,255,255,0.4);
            text-align: right; margin-bottom: 2px; position: relative; z-index: 1;
            font-family: 'SF Mono', 'Cascadia Code', 'Roboto Mono', monospace;
        }

        /* --- REVEAL BUTTON STYLE --- */
        .reveal-btn {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.6);
            padding: 6px 16px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 60px;
            text-align: center;
            outline: none;
        }

        .reveal-btn:active {
            transform: scale(0.92);
        }

        .reveal-btn.active {
            background: rgba(48, 209, 88, 0.15);
            border-color: rgba(48,209,88,0.35);
            color: #30d158;
            box-shadow: 0 0 12px rgba(48, 209, 88, 0.15);
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 380px) {
            .score-content {
                padding: 8px;
            }
            .score-dashboard-grid {
                gap: 6px;
            }
            .dashboard-cell {
                padding: 8px 6px;
                min-height: 70px;
            }
            .cell-label {
                font-size: 0.65em;
                margin-bottom: 6px;
            }
            .math-input {
                font-size: 1em;
                padding: 6px;
            }
            .total-value {
                font-size: 1.6em;
            }
            .role-tag {
                margin-left: 6px;
                padding: 2px 6px;
                font-size: 0.7em;
            }
            .info-item {
                font-size: 0.8em;
                padding: 3px 6px;
            }
            .reveal-btn {
                padding: 4px 10px;
                font-size: 0.85em;
                min-width: 50px;
            }
            .dash-hero { flex-direction: column; }
            .dash-hero-main { flex: none; }
            .dash-hero-side { flex: none; }
            .dash-hero-value { font-size: 1.8em; }
            .dash-hero-side-value { font-size: 1.3em; }
            .dash-roles { grid-template-columns: 1fr; }
            .dash-role-played { font-size: 1.2em; }
        }
    </style>
</head>
<body>
<script>
// Инициализация Telegram Web App
if (window.Telegram && window.Telegram.WebApp) {
    const tg = window.Telegram.WebApp;
    
    // 1. Базовое расширение (для всех версий)
    tg.expand();
    
    // 2. Попытка включить настоящий полноэкранный режим (Bot API 8.0+)
    if (typeof tg.requestFullscreen === 'function') {
        tg.requestFullscreen();
    }
    
    // 3. Отключаем вертикальные свайпы для предотвращения закрытия
    if (typeof tg.disableVerticalSwipes === 'function') {
        tg.disableVerticalSwipes();
    }
    
    // Устанавливаем цвет хедера и фона
    tg.setHeaderColor('#0c0a1e');
    tg.setBackgroundColor('#0c0a1e');

    // Добавляем класс для Telegram приложения
    document.body.classList.add('tg-app');
    
    // Функция обновления высоты вьюпорта
    function updateViewportHeight() {
        // Используем tg.viewportStableHeight если доступно, иначе viewportHeight
        const vh = tg.viewportStableHeight || tg.viewportHeight;
        if (vh) {
            document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
        }
    }
    
    // Слушаем изменение размера вьюпорта
    tg.onEvent('viewportChanged', updateViewportHeight);
    
    // Инициализация высоты с небольшой задержкой для надежности
    updateViewportHeight();
    setTimeout(updateViewportHeight, 100);
    
    // Показываем, что приложение готово
    tg.ready();
    
    // Включаем подтверждение закрытия
    tg.enableClosingConfirmation();
    
    // Глобальная функция для тактильного отклика
    window.haptic = {
        impact: (style = 'light') => {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style);
        },
        notification: (type = 'success') => {
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(type);
        },
        selection: () => {
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }
    };
    
    // Функции для работы с сессиями
    window.sessionManager = {
        // Ключ для хранения данных сессии
        SESSION_KEY: 'maf_panel_session_data',
        
        // Сохранение данных сессии
        saveSession: function(data) {
            try {
                const sessionData = {
                    ...data,
                    timestamp: Date.now()
                };
                
                // Сохраняем в localStorage
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                
                // Также сохраняем в Telegram CloudStorage если доступно
                if (tg.CloudStorage) {
                    tg.CloudStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                }
            } catch (error) {
                console.error('Ошибка сохранения сессии:', error);
            }
        },
        
        // Получение данных сессии
        getSession: function() {
            try {
                const localData = localStorage.getItem(this.SESSION_KEY);
                if (localData) {
                    return JSON.parse(localData);
                }
                return null;
            } catch (error) {
                console.error('Ошибка загрузки сессии:', error);
                return null;
            }
        },
        
        // Проверка валидности сессии (3 часа)
        isSessionValid: function(sessionData) {
            if (!sessionData || !sessionData.timestamp) {
                return false;
            }
            
            const now = Date.now();
            const sessionTime = sessionData.timestamp;
            const threeHours = 3 * 60 * 60 * 1000; // 3 часа в миллисекундах
            
            return (now - sessionTime) < threeHours;
        },
        
        // Проверка, есть ли значимые данные в сессии
        hasSignificantData: function(sessionData) {
            if (!sessionData) return false;
            
            // Проверяем, что есть комната И (турнир ИЛИ ручной режим с игроками)
            return sessionData.roomId && (
                sessionData.tournamentId || 
                (sessionData.manualMode && sessionData.manualPlayers && sessionData.manualPlayers.length > 0)
            );
        },
        
        // Очистка сессии
        clearSession: function() {
            try {
                localStorage.removeItem(this.SESSION_KEY);
                if (tg.CloudStorage) {
                    tg.CloudStorage.removeItem(this.SESSION_KEY);
                }
            } catch (error) {
                console.error('Ошибка очистки сессии:', error);
            }
        }
    };
} else {
    // Заглушка для haptic, если не в Telegram
    window.haptic = {
        impact: () => {},
        notification: () => {},
        selection: () => {}
    };
}
</script>
<script>
// ── Защита от случайных нажатий при скролле ──
// Если палец сдвинулся более чем на 10px — это скролл, а не тап.
// В этом случае подавляем click-событие, чтобы кнопки не срабатывали.
(function() {
    var SCROLL_THRESHOLD = 10; // px — порог смещения, после которого считаем жест скроллом
    var touchStartX = 0;
    var touchStartY = 0;
    var isScrolling = false;

    document.addEventListener('touchstart', function(e) {
        var touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        isScrolling = false;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
        if (isScrolling) return;
        var touch = e.touches[0];
        var dx = Math.abs(touch.clientX - touchStartX);
        var dy = Math.abs(touch.clientY - touchStartY);
        if (dx > SCROLL_THRESHOLD || dy > SCROLL_THRESHOLD) {
            isScrolling = true;
        }
    }, { passive: true });

    document.addEventListener('click', function(e) {
        if (isScrolling) {
            e.preventDefault();
            e.stopPropagation();
            isScrolling = false;
        }
    }, true); // capturing phase — перехватываем до того, как Vue обработает
})();
</script>
<script>document.write('<script src="./login/auth.js?v=' + window.__v + '"><\/script>');</script>

<!-- Экран загрузки — скрывает всё до полной инициализации -->
<div id="maf-splash" style="position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#040410;transition:opacity .35s ease;pointer-events:all;">
    <svg width="56" height="56" viewBox="0 0 48 48" fill="none" style="margin-bottom:18px;">
        <circle cx="24" cy="24" r="24" fill="rgba(168,85,247,0.13)"/>
        <path d="M34.5 13.5L13.5 22.5L20.5 25L25.5 34.5L34.5 13.5Z" stroke="#a855f7" stroke-width="2" stroke-linejoin="round" fill="rgba(168,85,247,0.08)"/>
    </svg>
    <div style="width:36px;height:36px;border:3px solid rgba(168,85,247,0.15);border-top-color:#a855f7;border-radius:50%;animation:maf-spin .7s linear infinite;"></div>
    <style>@keyframes maf-spin{to{transform:rotate(360deg)}}</style>
</div>

<div id="app" :class="{ 'obs-cef': isObs }">
    <!-- Баннер о неактивной панели -->
    <div v-if="!isActivePanel && activePanelId && roomId" class="top-banner">
        <b>Внимание!</b> В этой комнате уже есть активная панель.<br>
        <button @click="activateThisPanel(); window.haptic.impact('medium');">
            Сделать эту панель главной
        </button>
    </div>
    
    <div :class="{ 'content-shifted': (!isActivePanel && activePanelId && roomId) }">
        <!-- Главное меню с историей игр (полноэкранный интерфейс) -->
        <div v-if="showMainMenu" class="main-menu-screen">
            <div class="main-menu-container">
                <div class="main-menu-header">
                    <div class="main-menu-logo">
                        <i class="mdi mdi-cards-playing-outline"></i>
                    </div>
                    <h1 class="main-menu-title">MafBoard</h1>
                    <p class="main-menu-subtitle">Панель управления мафией</p>
                </div>

                <!-- Список игр -->
                <div v-if="sessionsList && sessionsList.length > 0" class="main-menu-history">
                    <div class="main-menu-history-title">
                        <i class="fa fa-history" style="margin-right: 6px; opacity: 0.6;"></i>
                        {{ activeHistoryTab === 'active' ? 'Активные игры' : 'История игр' }}
                        <span class="main-menu-history-count">
                            {{ activeHistoryTab === 'active' ? getActiveSessions().length : getHistorySessions().length }}
                        </span>
                    </div>

                    <div class="main-menu-sessions-list">
                        <template v-for="group in (activeHistoryTab === 'active' ? getGroupedActiveSessions() : getGroupedHistorySessions())">

                            <!-- Турнирная карточка (группа) -->
                            <div v-if="group.isTournament" :key="'tg-'+group.tournamentId" class="tournament-group-card">
                                <div class="tournament-group-header" @click="toggleTournamentExpanded(group.tournamentId); window.haptic.selection();">
                                    <div class="tournament-group-icon">
                                        <i :class="group.isFunky ? 'mdi mdi-cards-playing-outline' : 'mdi mdi-trophy-outline'"></i>
                                    </div>
                                    <div class="tournament-group-info">
                                        <div class="tournament-group-name">{{ group.tournamentName }}</div>
                                        <div class="tournament-group-meta">
                                            <!-- GoMafia: Стол X · Игра N из M -->
                                            <template v-if="!group.isFunky">
                                                <span v-if="group.tableSelected" class="tournament-game-count">Стол {{ group.tableSelected }}</span>
                                                <span class="tournament-game-count">Игра {{ group.lastStartedGameNumber }}<template v-if="group.totalGamesInTournament"> из {{ group.totalGamesInTournament }}</template></span>
                                            </template>
                                            <!-- Фанки: Игра N · X/Y завершено -->
                                            <template v-else>
                                                <span class="tournament-game-count">Игра {{ group.lastStartedGameNumber }}</span>
                                                <span class="tournament-game-count">{{ group.finishedGamesCount }}/{{ group.gamesCount }} завершено</span>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="tournament-group-chevron" :class="{ expanded: isTournamentExpanded(group.tournamentId) }">
                                        <i class="mdi mdi-chevron-down"></i>
                                    </div>
                                </div>

                                <!-- Раскрытое содержимое турнира -->
                                <div v-if="isTournamentExpanded(group.tournamentId)" class="tournament-group-body">
                                    <div class="tournament-games-list">
                                        <div v-for="session in group.sessions" :key="session.sessionId"
                                             class="tournament-game-row"
                                             :class="{ finished: session.gameFinished || (session.winnerTeam && session.gameFinished === undefined), active: !(session.gameFinished || (session.winnerTeam && session.gameFinished === undefined)) }"
                                             @click="openSession(session.sessionId); window.haptic.impact('light');">
                                            <div class="tournament-game-num">
                                                <span class="game-num-label">Игра {{ session.gameSelected || '?' }}</span>
                                            </div>
                                            <div class="tournament-game-result">
                                                <span class="result-dot"
                                                    :class="{
                                                        'dot-red': session.gameFinished && session.winnerTeam === 'civilians',
                                                        'dot-dark': session.gameFinished && session.winnerTeam === 'mafia',
                                                        'dot-white': session.gameFinished && session.winnerTeam === 'draw',
                                                        'dot-orange': session.winnerTeam && !session.gameFinished && session.gameFinished !== undefined,
                                                        'dot-green': !session.winnerTeam && !session.gameFinished
                                                    }"></span>
                                                {{ getGameResultText(session) }}
                                            </div>
                                            <div class="tournament-game-time">
                                                {{ formatSessionTime(session.timestamp) }}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Кнопки действий турнира -->
                                    <div class="tournament-actions" v-if="activeHistoryTab === 'active'">
                                        <button class="tournament-action-btn next-game-btn"
                                                :class="{ disabled: group.hasActiveGame }"
                                                :disabled="group.hasActiveGame"
                                                @click.stop="startNextTournamentGame(group.tournamentId, group.sessions[group.sessions.length - 1].tableSelected || 1); window.haptic.impact('medium');">
                                            <i class="mdi mdi-plus-circle-outline" style="margin-right: 6px;"></i>
                                            {{ group.hasActiveGame ? 'Завершите текущую' : 'Новая игра' }}
                                        </button>
                                        <button class="tournament-action-btn summary-btn"
                                                @click.stop="funkyBuildSummary(group.tournamentId); window.haptic.impact('medium');">
                                            <i class="mdi mdi-chart-bar" style="margin-right: 6px;"></i>
                                            Подвести итоги
                                        </button>
                                        <button class="tournament-action-btn finish-tournament-btn"
                                                @click.stop="finishTournament(group.tournamentId); window.haptic.notification('success');">
                                            <i class="mdi mdi-flag-checkered" style="margin-right: 6px;"></i>
                                            Завершить турнир
                                        </button>
                                    </div>
                                    <!-- Кнопка итогов в истории -->
                                    <div class="tournament-actions" v-if="activeHistoryTab === 'history'">
                                        <button class="tournament-action-btn summary-btn"
                                                @click.stop="funkyBuildSummary(group.tournamentId); window.haptic.impact('medium');">
                                            <i class="mdi mdi-chart-bar" style="margin-right: 6px;"></i>
                                            Посмотреть итоги
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Обычная карточка (не турнир) -->
                            <div v-else :key="group.sessions[0].sessionId"
                                 class="main-menu-session-card"
                                 @click="openSession(group.sessions[0].sessionId); window.haptic.impact('light');">

                                <div class="session-card-header">
                                    <div class="session-card-name">{{ getSessionDisplayName(group.sessions[0]) }}</div>
                                    <div class="session-card-time">{{ formatSessionTime(group.sessions[0].timestamp) }}</div>
                                </div>

                                <div class="session-card-details">
                                    <span class="session-card-status">
                                        <span class="result-dot"
                                            :class="{
                                                'dot-red': (group.sessions[0].gameFinished || (group.sessions[0].winnerTeam && group.sessions[0].gameFinished === undefined)) && group.sessions[0].winnerTeam === 'civilians',
                                                'dot-dark': (group.sessions[0].gameFinished || (group.sessions[0].winnerTeam && group.sessions[0].gameFinished === undefined)) && group.sessions[0].winnerTeam === 'mafia',
                                                'dot-white': (group.sessions[0].gameFinished || (group.sessions[0].winnerTeam && group.sessions[0].gameFinished === undefined)) && group.sessions[0].winnerTeam === 'draw',
                                                'dot-orange': group.sessions[0].winnerTeam && !group.sessions[0].gameFinished && group.sessions[0].gameFinished !== undefined,
                                                'dot-green': !group.sessions[0].winnerTeam && !group.sessions[0].gameFinished
                                            }"></span>
                                        {{ getSessionStatusText(group.sessions[0]) }}
                                    </span>
                                    <span v-if="getSessionModeText(group.sessions[0])" class="session-card-mode">{{ getSessionModeText(group.sessions[0]) }}</span>
                                    <span class="session-card-room">{{ getSessionRoomText(group.sessions[0]) }}</span>
                                </div>

                                <button v-if="activeHistoryTab === 'active'" class="session-card-delete"
                                        @click.stop="deleteSession(group.sessions[0].sessionId); window.haptic.impact('light');"
                                        title="Удалить">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </template>

                        <!-- Пустое состояние для текущей вкладки -->
                        <div v-if="(activeHistoryTab === 'active' ? getGroupedActiveSessions() : getGroupedHistorySessions()).length === 0" class="main-menu-empty-tab">
                            <div class="main-menu-empty-text">Нет {{ activeHistoryTab === 'active' ? 'активных' : 'завершенных' }} игр</div>
                        </div>
                    </div>
                </div>

                <!-- Пустое состояние (если вообще нет сессий) -->
                <div v-else class="main-menu-empty">
                    <div class="main-menu-empty-icon">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="rgba(168, 85, 247, 0.3)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="8" cy="8" r="1.2"/><circle cx="16" cy="8" r="1.2"/><circle cx="8" cy="16" r="1.2"/><circle cx="16" cy="16" r="1.2"/><circle cx="12" cy="12" r="1.2"/></svg>
                    </div>
                    <div class="main-menu-empty-text">Нет сохранённых игр</div>
                    <div class="main-menu-empty-hint">
                        Создайте новую игру — она сохранится автоматически
                    </div>
                </div>
            </div>
        </div>

        <!-- Экран Профиль (полноэкранный) -->
        <div v-if="showProfileScreen" class="fullscreen-page">
            <div class="fullscreen-page-container">
                <div class="fullscreen-page-header">
                    <h1 class="fullscreen-page-title">Профиль</h1>
                </div>

                <div class="profile-avatar-section">
                    <div class="profile-avatar" :style="judgeAvatarUrl ? {backgroundImage: 'url(' + judgeAvatarUrl + ')'} : {}">
                        <i v-if="!judgeAvatarUrl" class="fa fa-user profile-avatar-placeholder"></i>
                    </div>
                    <div class="profile-avatar-hint">Аватар из Telegram</div>
                </div>

                <div class="profile-field">
                    <label class="profile-field-label">Никнейм</label>
                    <input type="text" class="profile-field-input" v-model="judgeNickname" placeholder="Введите никнейм" maxlength="50">
                    <div class="profile-field-hint">Отображается при отправке результатов игры в Телеграм</div>
                </div>

                <button class="glass-btn w-full btn-primary mt-20" @click="saveJudgeNickname(); window.haptic.notification('success');">
                    <i class="fa fa-check" style="margin-right: 8px;"></i>
                    Сохранить
                </button>
            </div>
        </div>

        <!-- Экран Темы (полноэкранный) -->
        <div v-if="showThemesScreen" class="fullscreen-page">
            <div class="fullscreen-page-container">
                <div class="fullscreen-page-header">
                    <h1 class="fullscreen-page-title">Темы</h1>
                </div>

                <div class="text-center text-secondary font-bold text-large mb-10" style="letter-spacing:.02em;">
                    {{ colorSchemes.find(s=>s.key===selectedColorScheme)?.name || '' }}
                </div>
                <div class="theme-grid">
                    <div v-for="scheme in colorSchemes"
                         :key="scheme.key"
                         :title="scheme.name"
                         class="theme-preview-item"
                         @click="applyColorSchemeGlobal(scheme.key); window.haptic.selection();"
                         :style="{
                            border: selectedColorScheme === scheme.key ? '4px solid #fff' : '2px solid var(--maf-accent-color)',
                            background: scheme.preview,
                            outline: selectedColorScheme === scheme.key ? '3px solid ' + scheme.accent : 'none',
                            outlineOffset: selectedColorScheme === scheme.key ? '2px' : '0'
                         }">
                        <span>{{scheme.icon || '★'}}</span>
                        <span v-if="selectedColorScheme === scheme.key" class="check">✔</span>
                    </div>
                </div>

                <div class="text-center text-secondary font-bold text-large" style="margin:24px 0 12px 0;">
                    Фон панели
                </div>
                <div class="theme-grid">
                    <div v-for="theme in backgroundThemes"
                         :key="theme.key"
                         :title="theme.name"
                         class="theme-preview-item"
                         @click="applyBackgroundThemeGlobal(theme.key); window.haptic.selection();"
                         :style="{
                            border: selectedBackgroundTheme === theme.key ? '4px solid #fff' : '2px solid var(--maf-accent-color)',
                            background: theme.bgMain,
                            outline: selectedBackgroundTheme === theme.key ? '3px solid var(--maf-accent-color)' : 'none',
                            outlineOffset: selectedBackgroundTheme === theme.key ? '2px' : '0'
                         }">
                        <span>{{theme.icon}}</span>
                        <span v-if="selectedBackgroundTheme === theme.key" class="check">✔</span>
                    </div>
                </div>

                <button class="theme-save-btn" @click="showThemesScreen = false; activeHistoryTab = 'active'; window.haptic.notification('success');">
                    <i class="mdi mdi-check-circle-outline" style="margin-right: 8px; font-size: 1.2em;"></i>
                    Сохранить
                </button>
            </div>
        </div>

        <!-- ============ ЭКРАН НОВОЙ ИГРЫ (единый) ============ -->
        <div v-if="showModal && !showMainMenu && !showGameTableModal" class="modal">
            <div class="modal-content ng-modal-content">

                <!-- ─── Шаг 1: Выбор режима ─── -->
                <template v-if="newGameStep === 'modes'">
                    <h2>Новая сессия</h2>

                    <div class="ng-cards">
                        <!-- GoMafia -->
                        <div class="ng-card" @click="newGameStep = 'gomafia'; window.haptic.selection();">
                            <img class="ng-card-icon" src="./icon/gomafia.png" alt="GoMafia" />
                            <div class="ng-card-body">
                                <div class="ng-card-title">GoMafia</div>
                                <div class="ng-card-desc">Турнирный режим</div>
                            </div>
                            <i class="mdi mdi-chevron-right ng-card-arrow"></i>
                        </div>

                        <!-- Миникап (скоро) -->
                        <div class="ng-card ng-card-soon">
                            <div class="ng-card-icon-placeholder"><i class="mdi mdi-trophy-variant-outline"></i></div>
                            <div class="ng-card-body">
                                <div class="ng-card-title">Миникап</div>
                                <div class="ng-card-desc">Мини-турниры</div>
                            </div>
                            <span class="ng-soon-badge">скоро</span>
                        </div>

                        <!-- Фанки -->
                        <div class="ng-card" @click="startFunkyMode(); window.haptic.impact('medium');">
                            <div class="ng-card-icon-placeholder"><i class="mdi mdi-cards-playing-outline"></i></div>
                            <div class="ng-card-body">
                                <div class="ng-card-title">Фанки</div>
                                <div class="ng-card-desc">Свободная игра</div>
                            </div>
                            <i class="mdi mdi-chevron-right ng-card-arrow"></i>
                        </div>

                        <!-- Городская мафия -->
                        <div class="ng-card" @click="startCityMode(); window.haptic.impact('medium');">
                            <div class="ng-card-icon-placeholder"><i class="mdi mdi-city-variant-outline"></i></div>
                            <div class="ng-card-body">
                                <div class="ng-card-title">Городская мафия</div>
                                <div class="ng-card-desc">Городские игры</div>
                            </div>
                            <i class="mdi mdi-chevron-right ng-card-arrow"></i>
                        </div>
                    </div>

                    <button class="glass-btn w-full mt-16" style="opacity: 0.5; font-size: 0.9em;" @click="showModal = false; returnToMainMenu(); window.haptic.impact('light');">
                        <i class="fa fa-arrow-left" style="margin-right:8px;"></i>
                        Назад в главное меню
                    </button>
                </template>

                <!-- ─── Шаг 2: GoMafia — выбор способа ─── -->
                <template v-if="newGameStep === 'gomafia'">
                    <div class="ng-step-header">
                        <img src="./icon/gomafia.png" alt="GoMafia" class="ng-step-logo" />
                        <div>
                            <h2 class="ng-step-title">GoMafia</h2>
                            <div class="ng-step-subtitle">Выберите турнир</div>
                        </div>
                    </div>

                    <div class="ng-cards">
                        <!-- Выбрать из списка -->
                        <div class="ng-card" @click="openTournamentBrowser(); window.haptic.impact('medium');">
                            <div class="ng-card-icon-placeholder" style="background: rgba(168,85,247,0.12);"><i class="mdi mdi-format-list-bulleted" style="color: var(--accent-color);"></i></div>
                            <div class="ng-card-body">
                                <div class="ng-card-title">Выбрать из списка</div>
                                <div class="ng-card-desc">Турниры с gomafia.pro</div>
                            </div>
                            <i class="mdi mdi-chevron-right ng-card-arrow"></i>
                        </div>

                        <!-- Ввести номер -->
                        <div class="ng-id-input-card">
                            <div class="ng-id-row">
                                <div class="ng-card-icon-placeholder" style="background: rgba(255,215,0,0.1);"><i class="mdi mdi-trophy-outline" style="color: #ffd700;"></i></div>
                                <input
                                    type="text"
                                    inputmode="numeric"
                                    pattern="[0-9]*"
                                    v-model="tournamentId"
                                    placeholder="Номер турнира"
                                    class="ng-id-input"
                                    @keydown.enter="loadTournament(); window.haptic.impact('medium');"
                                    @input="tournamentId = tournamentId.replace(/[^0-9]/g, '')"
                                >
                            </div>
                            <button class="glass-btn w-full btn-primary ng-load-btn" :disabled="!tournamentId" @click="loadTournament(); window.haptic.impact('medium');">
                                <i class="mdi mdi-download" style="margin-right:6px;"></i> Загрузить турнир
                            </button>
                        </div>
                    </div>

                    <button class="glass-btn w-full mt-16" style="opacity: 0.5; font-size: 0.9em;" @click="newGameStep = 'modes'; window.haptic.impact('light');">
                        <i class="fa fa-arrow-left" style="margin-right:8px;"></i>
                        Назад
                    </button>
                </template>

                <!-- ─── Шаг Фанки: ввод игроков ─── -->
                <template v-if="newGameStep === 'funky'">
                    <div class="ng-step-header">
                        <div class="ng-card-icon-placeholder" style="background: rgba(168,85,247,0.12); width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <i class="mdi mdi-cards-playing-outline" style="color: var(--maf-accent-color, #a855f7); font-size:1.3em;"></i>
                        </div>
                        <div>
                            <h2 class="ng-step-title">Фанки</h2>
                            <div class="ng-step-subtitle">{{ mainInfoText }} · Игра {{ funkyGameNumber }}</div>
                        </div>
                    </div>

                    <div class="funky-players-list">
                        <div v-for="(player, index) in funkyPlayers" :key="'fp-'+index" class="funky-player-slot" :class="{ filled: player !== null }">
                            <div class="funky-player-num">{{ index + 1 }}</div>

                            <div class="funky-player-input-wrap" v-if="player === null">
                                <input
                                    type="text"
                                    class="funky-player-input"
                                    :data-index="index"
                                    :value="funkyPlayerInputs[index]"
                                    :placeholder="'Игрок ' + (index + 1)"
                                    @input="$set(funkyPlayerInputs, index, $event.target.value); funkyOnInput(index)"
                                    @focus="funkyActiveInput = index"
                                    @keydown.enter="funkySetManualPlayer(index)"
                                    autocomplete="off"
                                >
                                <!-- Индикатор загрузки -->
                                <div v-if="funkyActiveInput === index && funkySearchLoading" class="funky-search-loading">
                                    <i class="mdi mdi-loading mdi-spin"></i> Поиск...
                                </div>
                                <!-- Результаты поиска -->
                                <div v-if="funkyActiveInput === index && funkySearchResults.length > 0 && !funkySearchLoading" class="funky-search-dropdown">
                                    <div v-for="result in funkySearchResults" :key="result.login"
                                         class="funky-search-item"
                                         @mousedown.prevent="funkySelectPlayer(index, result); window.haptic && window.haptic.selection();"
                                         @touchstart.prevent="funkySelectPlayer(index, result); window.haptic && window.haptic.selection();">
                                        <div class="funky-search-avatar" :style="result.avatar_link ? {backgroundImage: 'url(' + result.avatar_link + ')'} : {}">
                                            <i v-if="!result.avatar_link" class="mdi mdi-account" style="opacity:0.4;"></i>
                                        </div>
                                        <div class="funky-search-info">
                                            <div class="funky-search-name">{{ result.login }}</div>
                                            <div v-if="result.title" class="funky-search-title">{{ result.title }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Выбранный игрок -->
                            <div class="funky-player-selected" v-else>
                                <div class="funky-selected-avatar" :style="player.avatar_link ? {backgroundImage: 'url(' + player.avatar_link + ')'} : {}">
                                    <i v-if="!player.avatar_link" class="mdi mdi-account" style="opacity:0.4; font-size:1.2em;"></i>
                                </div>
                                <div class="funky-selected-name">{{ player.login }}</div>
                                <button class="funky-clear-btn" @click.stop="funkyClearPlayer(index); window.haptic.impact('light');">
                                    <i class="mdi mdi-close"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="funky-filled-counter">
                        {{ funkyPlayers.filter(p => p !== null).length }} / 10 игроков
                    </div>

                    <div class="funky-actions-container">
                        <button class="glass-btn funky-shuffle-btn"
                                :disabled="!funkyAllPlayersFilled()"
                                @click="funkyShufflePlayers(); window.haptic.impact('medium');">
                            <i class="mdi mdi-shuffle-variant" style="margin-right:8px;"></i>
                            Рассадить
                        </button>
                        <div class="game-actions-row">
                            <button class="glass-btn funky-back-btn" @click="newGameStep = 'modes'; returnToMainMenu(); window.haptic.impact('light');">
                                <i class="fa fa-arrow-left" style="margin-right:6px;"></i>
                                <span>Назад</span>
                            </button>
                            <button class="glass-btn game-finish-btn"
                                    :disabled="!funkyAllPlayersFilled()"
                                    @click="funkyConfirmPlayers(); window.haptic.notification('success');">
                                <i class="mdi mdi-check-circle-outline" style="margin-right:6px;"></i>
                                <span>Начать игру</span>
                            </button>
                        </div>
                    </div>
                </template>

                <!-- ─── Шаг City: Городская мафия ─── -->
                <template v-if="newGameStep === 'city'">
                    <div class="ng-step-header">
                        <div class="ng-card-icon-placeholder" style="background: rgba(168,85,247,0.12); width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <i class="mdi mdi-city-variant-outline" style="color: var(--maf-accent-color, #a855f7); font-size:1.3em;"></i>
                        </div>
                        <div>
                            <h2 class="ng-step-title">Городская мафия</h2>
                            <div class="ng-step-subtitle">{{ mainInfoText }}</div>
                        </div>
                    </div>

                    <!-- ШАГ 1: Количество игроков -->
                    <div v-if="cityStep === 'count'" class="city-step-content">
                        <div class="city-count-label">Сколько игроков?</div>
                        <div class="city-count-input-wrap">
                            <input
                                type="text"
                                inputmode="numeric"
                                pattern="[0-9]*"
                                v-model="cityPlayersCount"
                                placeholder="10"
                                class="city-count-input"
                                maxlength="2"
                                @input="cityPlayersCount = parseInt(String(cityPlayersCount).replace(/[^0-9]/g, '')) || 8"
                            >
                            <span class="city-count-hint">от 8 до 30</span>
                        </div>
                        <button class="glass-btn btn-primary w-full mt-16"
                                :disabled="!cityPlayersCount || cityPlayersCount < 8 || cityPlayersCount > 30"
                                @click="citySetPlayersCount(cityPlayersCount); window.haptic.impact('medium');">
                            <i class="mdi mdi-arrow-right" style="margin-right:6px;"></i> Дальше
                        </button>
                        <button class="glass-btn w-full mt-16" style="opacity: 0.5; font-size: 0.9em;" @click="newGameStep = 'modes'; window.haptic.impact('light');">
                            <i class="fa fa-arrow-left" style="margin-right:8px;"></i> Назад
                        </button>
                    </div>

                    <!-- ШАГ 2: Конфигуратор ролей (только для 17+) -->
                    <div v-if="cityStep === 'roles_config'" class="city-step-content">
                        <div class="city-roles-config-title">Дополнительные роли</div>
                        <div class="city-roles-config-hint">Базовые роли: Дон, 3 Мафии, Маньяк, Шериф, Доктор, Камикадзе, Бессмертный, Красотка.<br>Включите дополнительные роли. Остальные — мирные.</div>

                        <div class="city-roles-toggles">
                            <div v-for="roleKey in CITY_OPTIONAL_ROLES()" :key="'toggle-'+roleKey" class="city-role-toggle-row">
                                <div class="city-role-toggle-info">
                                    <span class="city-role-toggle-label" :class="{ 'city-role-red': CITY_ROLES_ALL()[roleKey].team === 'red', 'city-role-black': CITY_ROLES_ALL()[roleKey].team === 'black' }">
                                        {{ CITY_ROLES_ALL()[roleKey].label }}
                                    </span>
                                    <span class="city-role-toggle-team">{{ CITY_ROLES_ALL()[roleKey].team === 'red' ? '🔴' : '⚫' }}</span>
                                </div>
                                <label class="city-toggle-switch">
                                    <input type="checkbox" :checked="cityRoleToggles[roleKey]" @change="cityToggleRole(roleKey); window.haptic.selection();">
                                    <span class="city-toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="city-roles-count-info">
                            Ролей: {{ getCityActiveRoles().filter(r => r !== 'peace').length }} · Мирных: {{ getCityActiveRoles().filter(r => r === 'peace').length }} · Всего: {{ cityPlayersCount }}
                        </div>

                        <button class="glass-btn btn-primary w-full mt-16"
                                @click="cityConfirmRolesConfig(); window.haptic.impact('medium');">
                            <i class="mdi mdi-arrow-right" style="margin-right:6px;"></i> Дальше
                        </button>
                        <button class="glass-btn w-full mt-16" style="opacity: 0.5; font-size: 0.9em;" @click="cityStep = 'count'; window.haptic.impact('light');">
                            <i class="fa fa-arrow-left" style="margin-right:8px;"></i> Назад
                        </button>
                    </div>

                    <!-- ШАГ 3: Ввод игроков -->
                    <div v-if="cityStep === 'players'" class="city-step-content">
                        <div class="funky-players-list">
                            <div v-for="(player, index) in cityPlayers" :key="'cp-'+index" class="funky-player-slot" :class="{ filled: player !== null }">
                                <div class="funky-player-num">{{ index + 1 }}</div>

                                <div class="funky-player-input-wrap" v-if="player === null">
                                    <input
                                        type="text"
                                        class="funky-player-input city-player-input"
                                        :data-index="index"
                                        :value="cityPlayerInputs[index]"
                                        :placeholder="'Игрок ' + (index + 1)"
                                        @input="$set(cityPlayerInputs, index, $event.target.value); cityOnInput(index)"
                                        @focus="cityActiveInput = index"
                                        @keydown.enter="citySetManualPlayer(index)"
                                    >
                                    <!-- Результаты поиска -->
                                    <div v-if="cityActiveInput === index && (citySearchResults.length > 0 || citySearchLoading)" class="funky-search-dropdown">
                                        <div v-if="citySearchLoading" class="funky-search-loading">
                                            <i class="fa fa-spinner fa-spin"></i> Поиск...
                                        </div>
                                        <div v-for="result in citySearchResults" :key="'csr-'+result.login"
                                             class="funky-search-result"
                                             @mousedown.prevent="citySelectPlayer(index, result); window.haptic.impact('light');">
                                            <div class="funky-search-avatar" :style="result.avatar_link ? {backgroundImage: 'url('+result.avatar_link+')'} : {}"></div>
                                            <div class="funky-search-info">
                                                <div class="funky-search-name">{{ result.login }}</div>
                                                <div v-if="result.title" class="funky-search-title">{{ result.title }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="funky-player-filled" v-else>
                                    <div class="funky-player-avatar" :style="player.avatar_link ? {backgroundImage: 'url('+player.avatar_link+')'} : {}"></div>
                                    <div class="funky-player-name">{{ player.login }}</div>
                                    <button class="funky-player-clear" @click="cityClearPlayer(index); window.haptic.impact('light');">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="funky-bottom-actions">
                            <button class="glass-btn funky-shuffle-btn"
                                    :disabled="!cityAllPlayersFilled()"
                                    @click="cityShufflePlayers(); window.haptic.impact('medium');">
                                <i class="mdi mdi-shuffle-variant" style="margin-right:6px;"></i>
                                <span>Рассадить</span>
                            </button>
                            <button class="glass-btn funky-back-btn"
                                    @click="cityStep = (cityPlayersCount >= 17 ? 'roles_config' : 'count'); window.haptic.impact('light');">
                                <i class="fa fa-arrow-left" style="margin-right:6px;"></i>
                                <span>Назад</span>
                            </button>
                            <button class="glass-btn game-finish-btn"
                                    :disabled="!cityAllPlayersFilled()"
                                    @click="cityGoToRolesAssign(); window.haptic.impact('medium');">
                                <i class="mdi mdi-arrow-right" style="margin-right:6px;"></i>
                                <span>Продолжить</span>
                            </button>
                        </div>
                    </div>

                    <!-- ШАГ 4: Раздача ролей -->
                    <div v-if="cityStep === 'roles_assign'" class="city-step-content">
                        <div class="city-roles-assign-header">
                            <span>Раздача ролей</span>
                            <button class="glass-btn city-auto-btn" @click="cityAutoAssignRoles(); window.haptic.impact('medium');">
                                <i class="mdi mdi-shuffle-variant" style="margin-right:4px;"></i> Раздать роли
                            </button>
                        </div>

                        <div class="city-roles-assign-list">
                            <div v-for="(player, index) in cityPlayers" :key="'cra-'+index" class="city-role-assign-row">
                                <div class="funky-player-num">{{ index + 1 }}</div>
                                <div class="funky-player-avatar" :style="player && player.avatar_link ? {backgroundImage: 'url('+player.avatar_link+')'} : {}"></div>
                                <div class="city-role-assign-name">{{ player ? player.login : '' }}</div>
                                <select class="city-role-select"
                                        :value="cityAssignedRoles[index] || ''"
                                        @change="citySetPlayerRole(index, $event.target.value); window.haptic.selection();">
                                    <option value="">— Роль —</option>
                                    <option v-for="r in cityGetAvailableRoles(index)" :key="'ro-'+r.id" :value="r.id"
                                            :selected="cityAssignedRoles[index] === r.id">
                                        {{ r.label }} {{ r.team === 'black' ? '⚫' : '🔴' }}
                                    </option>
                                    <option v-if="cityAssignedRoles[index] && !cityGetAvailableRoles(index).find(r => r.id === cityAssignedRoles[index])"
                                            :value="cityAssignedRoles[index]" selected>
                                        {{ getCityRoleLabel(cityAssignedRoles[index]) }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="funky-bottom-actions">
                            <button class="glass-btn funky-back-btn"
                                    @click="cityStep = 'players'; window.haptic.impact('light');">
                                <i class="fa fa-arrow-left" style="margin-right:6px;"></i>
                                <span>Назад</span>
                            </button>
                            <button class="glass-btn game-finish-btn"
                                    :disabled="!cityValidateRoles()"
                                    @click="cityConfirmPlayers(); window.haptic.notification('success');">
                                <i class="mdi mdi-check-circle-outline" style="margin-right:6px;"></i>
                                <span>Начать игру</span>
                            </button>
                        </div>
                    </div>
                </template>

            </div>
        </div>

        <!-- ============ Модальное окно списка турниров GoMafia ============ -->
        <div v-if="showTournamentBrowser" class="modal tb-modal">
            <div class="modal-content tb-modal-content">

                <!-- Заголовок -->
                <div class="tb-header">
                    <div class="tb-header-icon">
                        <img src="./icon/gomafia.png" alt="GoMafia" />
                    </div>
                    <div class="tb-header-text">
                        <h2 class="tb-title">Турниры</h2>
                        <div class="tb-subtitle">gomafia.pro</div>
                    </div>
                </div>

                <!-- Поиск -->
                <div class="tb-search-wrap">
                    <i class="fa fa-search tb-search-icon"></i>
                    <input
                        class="tb-search-input"
                        type="text"
                        placeholder="Поиск турнира..."
                        :value="tournamentsFilters.search"
                        @input="onTournamentSearchInput($event.target.value)"
                    >
                    <button v-if="tournamentsFilters.search" class="tb-search-clear" @click="applyTournamentFilter('search', '')">
                        <i class="fa fa-times"></i>
                    </button>
                </div>

                <!-- Фильтры -->
                <div class="tb-filters">
                    <div class="tb-filter-row">
                        <div class="tb-chip" :class="{ active: !tournamentsFilters.period }" @click="applyTournamentFilter('period', ''); window.haptic.selection();">
                            <i class="mdi mdi-clock-outline"></i><span>Ближайшие</span>
                        </div>
                        <div class="tb-chip" :class="{ active: tournamentsFilters.period === 'past' }" @click="applyTournamentFilter('period', 'past'); window.haptic.selection();">
                            <i class="mdi mdi-history"></i><span>Прошедшие</span>
                        </div>
                    </div>
                    <div class="tb-filter-row">
                        <div class="tb-chip" :class="{ active: !tournamentsFilters.type }" @click="applyTournamentFilter('type', ''); window.haptic.selection();"><span>Все</span></div>
                        <div class="tb-chip" :class="{ active: tournamentsFilters.type === 'offline' }" @click="applyTournamentFilter('type', 'offline'); window.haptic.selection();"><i class="mdi mdi-map-marker-outline"></i><span>Офлайн</span></div>
                        <div class="tb-chip" :class="{ active: tournamentsFilters.type === 'online' }" @click="applyTournamentFilter('type', 'online'); window.haptic.selection();"><i class="mdi mdi-wifi"></i><span>Онлайн</span></div>
                        <div class="tb-chip tb-chip-star" :class="{ active: tournamentsFilters.fsm === 'fsm' }" @click="applyTournamentFilter('fsm', tournamentsFilters.fsm === 'fsm' ? '' : 'fsm'); window.haptic.selection();"><i class="mdi mdi-star-outline"></i><span>ФСМ</span></div>
                    </div>
                </div>

                <!-- Список турниров -->
                <div class="tb-list-scroll">
                    <div v-if="tournamentsLoading && tournamentsList.length === 0" class="tb-state">
                        <div class="tb-spinner"></div>
                        <span>Загрузка турниров...</span>
                    </div>

                    <div v-else-if="tournamentsError" class="tb-state">
                        <i class="mdi mdi-alert-circle-outline" style="font-size: 2em; color: var(--status-error);"></i>
                        <span>{{ tournamentsError }}</span>
                        <button class="glass-btn btn-small mt-10" @click="fetchTournaments()"><i class="fa fa-redo" style="margin-right: 6px;"></i> Повторить</button>
                    </div>

                    <div v-else-if="!tournamentsLoading && tournamentsList.length === 0" class="tb-state">
                        <i class="mdi mdi-trophy-broken" style="font-size: 2em; opacity: 0.35;"></i>
                        <span>Турниры не найдены</span>
                    </div>

                    <template v-else>
                        <div class="tb-card"
                             v-for="(t, idx) in tournamentsList"
                             :key="t.id || t.tournamentId || idx"
                             :class="{ 'tb-card-disabled': !isTournamentSeatingReady(t) }"
                             @click="isTournamentSeatingReady(t) ? selectTournamentFromBrowser(t) : null; window.haptic.impact(isTournamentSeatingReady(t) ? 'medium' : 'light');">

                            <div class="tb-card-top">
                                <div class="tb-card-name">{{ t.name || t.title || ('Турнир #' + (t.id || t.tournamentId)) }}</div>
                                <!-- Бейдж рассадки -->
                                <div v-if="isTournamentSeatingReady(t)" class="tb-badge tb-badge-seating">
                                    <i class="mdi mdi-check-circle" style="margin-right:3px;"></i>Рассадка
                                </div>
                                <div v-else class="tb-badge tb-badge-no-seating">
                                    Нет рассадки
                                </div>
                            </div>

                            <div class="tb-card-meta">
                                <span v-if="formatTournamentDate(t)"><i class="mdi mdi-calendar-outline"></i> {{ formatTournamentDate(t) }}</span>
                                <span v-if="getTournamentCity(t)"><i class="mdi mdi-map-marker-outline"></i> {{ getTournamentCity(t) }}</span>
                                <span v-if="getTournamentPlayersCount(t)"><i class="mdi mdi-account-group-outline"></i> {{ getTournamentPlayersCount(t) }}</span>
                                <span v-if="t.id || t.tournamentId" style="opacity:.5;">#{{ t.id || t.tournamentId }}</span>
                            </div>

                            <div v-if="!isTournamentSeatingReady(t)" class="tb-card-no-seating-hint">
                                Рассадка пока не готова
                            </div>
                        </div>

                        <button v-if="tournamentsHasMore" class="glass-btn w-full tb-load-more" @click="loadMoreTournaments(); window.haptic.impact('light');" :disabled="tournamentsLoading">
                            <template v-if="tournamentsLoading"><span class="tb-spinner-sm"></span> Загрузка...</template>
                            <template v-else><i class="mdi mdi-chevron-down"></i> Загрузить ещё</template>
                        </button>

                        <div v-if="tournamentsLoading && tournamentsList.length > 0" class="tb-loading-bottom">
                            <span class="tb-spinner-sm"></span>
                        </div>
                    </template>
                </div>

                <button class="glass-btn w-full mt-10" style="opacity: 0.5; font-size: 0.9em;" @click="closeTournamentBrowser(); window.haptic.impact('light');">
                    <i class="fa fa-arrow-left" style="margin-right:8px;"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Модальное окно выбора игры и стола -->
        <div v-if="showGameTableModal && !showMainMenu" class="modal">
            <div class="modal-content">
                <h2 style="margin-bottom: 4px;">
                    <i class="mdi mdi-table-furniture" style="margin-right: 8px; color: var(--maf-accent-color, #a855f7);"></i>
                    Выбор игры
                </h2>
                <div v-if="tournamentName" class="text-secondary" style="font-size: 0.85em; margin-bottom: 16px; text-align: center;">
                    {{ tournamentName }}
                </div>

                <!-- Выбор игры (только доступные/несыгранные) -->
                <div class="selection-card" style="cursor: pointer; background: rgba(255,255,255,0.03); position: relative; overflow: hidden;">
                    <div class="selection-icon">
                        <i class="mdi mdi-gamepad-variant-outline" style="color: #ffd700;"></i>
                    </div>
                    <div class="selection-info" style="flex-grow: 1;">
                        <div style="font-size: 0.75em; color: rgba(255,255,255,0.5); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Игра</div>
                        <div style="font-size: 1.2em; font-weight: 700; color: #fff;">Игра {{ gameSelected }}</div>
                    </div>
                    <i class="mdi mdi-chevron-down" style="color: rgba(255,255,255,0.4); font-size: 1.4em;"></i>
                    <select
                        v-model.number="gameSelected"
                        @change="onGameSelectChange($event)"
                        style="position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; font-size: 16px;">
                        <option v-for="game in availableGames" :value="game.gameNum" style="background: #1a1640; color: #fff;">
                            Игра {{ game.gameNum }}
                        </option>
                    </select>
                </div>

                <!-- Выбор стола (заблокирован если стол зафиксирован из предыдущих игр) -->
                <div v-if="_lockedTableNum" class="selection-card mt-10" style="cursor: default; background: rgba(255,255,255,0.03); opacity: 0.7;">
                    <div class="selection-icon">
                        <i class="mdi mdi-table-chair" style="color: var(--maf-accent-color, #a855f7);"></i>
                    </div>
                    <div class="selection-info">
                        <div style="font-weight: 700; font-size: 1em;">Стол {{ _lockedTableNum }}</div>
                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.4);">Стол зафиксирован из первой игры</div>
                    </div>
                    <i class="mdi mdi-lock-outline" style="color: rgba(255,255,255,0.25); font-size: 1.2em;"></i>
                </div>

                <!-- Выбор стола (свободный выбор — только для первой игры) -->
                <template v-else>
                    <div v-if="gameSelectedObject && gameSelectedObject.length > 1" class="selection-card mt-10" style="cursor: pointer; background: rgba(255,255,255,0.03); position: relative; overflow: hidden;">
                        <div class="selection-icon">
                            <i class="mdi mdi-table-chair" style="color: var(--maf-accent-color, #a855f7);"></i>
                        </div>
                        <div class="selection-info" style="flex-grow: 1;">
                            <div style="font-size: 0.75em; color: rgba(255,255,255,0.5); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Стол</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #fff;">Стол {{ tableSelected }}</div>
                        </div>
                        <i class="mdi mdi-chevron-down" style="color: rgba(255,255,255,0.4); font-size: 1.4em;"></i>
                        <select
                            v-model.number="tableSelected"
                            style="position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; font-size: 16px;">
                            <option v-for="tableEl in gameSelectedObject" :value="Number(tableEl.tableNum)" style="background: #1a1640; color: #fff;">
                                Стол {{ tableEl.tableNum }}
                            </option>
                        </select>
                    </div>

                    <!-- Инфо: один стол -->
                    <div v-if="gameSelectedObject && gameSelectedObject.length === 1" class="selection-card mt-10" style="cursor: default; background: rgba(255,255,255,0.03); opacity: 0.7;">
                        <div class="selection-icon">
                            <i class="mdi mdi-table-chair" style="color: var(--maf-accent-color, #a855f7);"></i>
                        </div>
                        <div class="selection-info">
                            <div style="font-weight: 700; font-size: 1em;">Стол {{ gameSelectedObject[0]?.tableNum }}</div>
                            <div style="font-size: 0.8em; color: rgba(255,255,255,0.4);">Единственный стол в этой игре</div>
                        </div>
                    </div>
                </template>

                <button class="glass-btn w-full mt-16 btn-primary" @click="confirmGameTable(); window.haptic.impact('medium');">
                    <i class="fa fa-check" style="margin-right: 8px;"></i>
                    Начать
                </button>
                <button class="glass-btn w-full mt-10" style="opacity: 0.5; font-size: 0.9em;" @click="showGameTableModal = false; tournament = undefined; showMainMenu = true; window.haptic.impact('light');">
                    <i class="fa fa-arrow-left" style="margin-right: 8px;"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Модальное окно выбора победителя -->
        <div v-if="showWinnerModal" class="modal">
            <div class="modal-content">
                <h2>Выберите победителя</h2>
                <div class="winner-selection-grid">
                    <div class="winner-card civilians" @click="setWinnerTeam('civilians'); window.haptic.notification('success');">
                        <div class="winner-icon">
                            <i class="mdi mdi-account-group"></i>
                        </div>
                        <div class="winner-info">
                            <div class="winner-title">Победа мирных</div>
                            <div class="winner-desc">Красная команда</div>
                        </div>
                    </div>

                    <div class="winner-card mafia" @click="setWinnerTeam('mafia'); window.haptic.notification('success');">
                        <div class="winner-icon">
                            <i class="mdi mdi-skull"></i>
                        </div>
                        <div class="winner-info">
                            <div class="winner-title">Победа мафии</div>
                            <div class="winner-desc">Черная команда</div>
                        </div>
                    </div>

                    <div class="winner-card draw" @click="setWinnerTeam('draw'); window.haptic.notification('success');">
                        <div class="winner-icon">
                            <i class="fa fa-handshake"></i>
                        </div>
                        <div class="winner-info">
                            <div class="winner-title">Ничья</div>
                            <div class="winner-desc">Равный результат</div>
                        </div>
                    </div>
                </div>
                <button class="glass-btn btn-danger mt-16 w-full" @click="showWinnerModal = false; window.haptic.impact('light');">
                    Отмена
                </button>
            </div>
        </div>

        <!-- Интерфейс подсчета баллов (показывается если выбран победитель) -->
        <div v-if="winnerTeam && tableOut?.length" class="scores-list">
            <div class="text-center font-bold text-large mb-20" style="text-shadow: 0 0 15px rgba(255,255,255,0.3);">
                Победили: <span :style="{color: winnerTeam === 'civilians' ? '#ff5252' : (winnerTeam === 'mafia' ? '#4fc3f7' : '#fff')}">
                    {{ winnerTeam === 'civilians' ? 'Мирные' : (winnerTeam === 'mafia' ? 'Мафия' : 'Ничья') }}
                </span>
            </div>

            <div v-for="(playerData, index) in tableOut"
                 :key="playerData.roleKey"
                 class="score-card"
                 :class="{ 'highlighted': highlightedPlayer === playerData.roleKey }"
                 @click="toggleHighlight(playerData.roleKey, $event); window.haptic.selection();">

                <div class="player-row-content">
                    <b class="flex-fixed player-num">{{index + 1}}</b>
                    <div class="avatar-uploader flex-fixed">
                        <div class="avatar" :style="{backgroundImage: playerData.avatarCss}"></div>
                    </div>
                    <div class="text-ellipsis player-name">{{playerData.login}}</div>
                    <div class="role-badges-right">
                        <span class="role-tag" :class="playerData.role || 'peace'">
                            {{ getRoleLabel(playerData.role) }}
                        </span>
                        <b style="font-size: 1.2em; margin-left: 10px; min-width: 30px; text-align: right;">{{ calculatePlayerScore(playerData.roleKey) }}</b>
                    </div>
                </div>

                <transition name="slide-fade">
                    <div v-if="highlightedPlayer === playerData.roleKey" class="score-content" @click.stop>
                        <div class="score-dashboard-grid">
                            <!-- Ряд 1: Протокол | Мнение (скрыто в городской мафии) -->
                            <template v-if="!cityMode">
                            <div class="dashboard-cell">
                                <div class="cell-label">Протокол</div>
                                <div class="info-list">
                                    <div v-if="checkProtocol(playerData.roleKey)">
                                        <div v-for="(res, idx) in checkProtocol(playerData.roleKey)" :key="'prot'+idx" class="info-item">
                                            <span>#{{ idx }}</span>
                                            <div class="flex align-center">
                                                <span :class="'text-' + res.role" style="margin-right:4px;">{{ getRoleLabel(res.role) }}</span>
                                                <i :class="res.correct ? 'fa fa-check check-icon' : 'fa fa-times cross-icon'"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="empty-data">Пусто</div>
                                </div>
                            </div>

                            <div class="dashboard-cell">
                                <div class="cell-label">Мнение</div>
                                <div class="info-list">
                                    <div v-if="checkOpinion(playerData.roleKey)">
                                        <div v-for="(res, idx) in checkOpinion(playerData.roleKey)" :key="'opin'+idx" class="info-item">
                                            <span>#{{ idx }}</span>
                                            <div class="flex align-center">
                                                <span :class="'text-' + res.role" style="margin-right:4px;">{{ getRoleLabel(res.role) }}</span>
                                                <i :class="res.correct ? 'fa fa-check check-icon' : 'fa fa-times cross-icon'"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="empty-data">Пусто</div>
                                </div>
                            </div>

                            <!-- Ряд 2: Текстовое мнение (если есть) -->
                            <div v-if="getOpinionText(playerData.roleKey)" class="dashboard-cell full-width">
                                <div class="cell-label">Текст мнения</div>
                                <div class="info-text-mini">
                                    "{{ getOpinionText(playerData.roleKey) }}"
                                </div>
                            </div>
                            </template>

                            <!-- Ряд: Ночные проверки (для Дона / Шерифа) -->
                            <div v-if="(playerData.role === 'don' || playerData.role === 'sheriff') && getNightCheckHistoryFor(playerData.roleKey).length > 0" class="dashboard-cell full-width">
                                <div class="cell-label">
                                    {{ playerData.role === 'don' ? '🔍 Проверки Дона' : '🔍 Проверки Шерифа' }}
                                </div>
                                <div class="info-list">
                                    <div v-for="(check, ci) in getNightCheckHistoryFor(playerData.roleKey)" :key="'nch'+ci" class="info-item">
                                        <span style="color: rgba(255,255,255,0.45);">Ночь {{ check.night }}</span>
                                        <div class="flex align-center">
                                            <span style="margin-right:6px;">→ №{{ check.target }}</span>
                                            <span :style="{ color: check.found ? '#30d158' : '#ff453a', fontWeight: 700 }">{{ check.result }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ряд 3: Доп | Штраф -->
                            <div class="dashboard-cell">
                                <div class="cell-label" style="color:#4caf50;"><i class="fa fa-plus"></i> Доп</div>
                                <div class="math-input-container">
                                    <div class="math-input-wrapper">
                                        <button class="math-btn minus" @click="adjustScore(playerData.roleKey, 'bonus', -0.1); window.haptic.impact('light');">-</button>
                                        <input type="number" step="0.1" class="math-input positive"
                                               placeholder="0"
                                               :value="playerScores[playerData.roleKey]?.bonus || ''"
                                               @input="updatePlayerScore(playerData.roleKey, 'bonus', $event.target.value)">
                                        <button class="math-btn plus" @click="adjustScore(playerData.roleKey, 'bonus', 0.1); window.haptic.impact('light');">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="dashboard-cell">
                                <div class="cell-label" style="color:#f44336;"><i class="fa fa-minus"></i> Штраф</div>
                                <div class="math-input-container">
                                    <div class="math-input-wrapper">
                                        <button class="math-btn minus" @click="adjustScore(playerData.roleKey, 'penalty', -0.1); window.haptic.impact('light');">-</button>
                                        <input type="number" step="0.1" class="math-input negative"
                                               placeholder="0"
                                               :value="playerScores[playerData.roleKey]?.penalty || ''"
                                               @input="updatePlayerScore(playerData.roleKey, 'penalty', $event.target.value)">
                                        <button class="math-btn plus" @click="adjustScore(playerData.roleKey, 'penalty', 0.1); window.haptic.impact('light');">+</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Ряд 4: Вскрытие | Итого -->
                            <div class="dashboard-cell">
                                <div class="cell-label">Статус</div>
                                <div class="status-content">
                                    <div class="status-row">
                                        <span class="status-text">Вскрытие</span>
                                        <button class="reveal-btn"
                                                :class="{ 'active': playerScores[playerData.roleKey]?.reveal }"
                                                @click="toggleReveal(playerData.roleKey); window.haptic.impact('light');">
                                            {{ playerScores[playerData.roleKey]?.reveal ? 'Да' : 'Нет' }}
                                        </button>
                                    </div>
                                    <div v-if="(playerData.role === 'don' || playerData.role === 'black') && playerData.action === 'killed'" class="self-kill-status">
                                        <i class="mdi mdi-skull" style="margin-right: 6px;"></i> САМОСТРЕЛ
                                    </div>
                                </div>
                            </div>

                            <div class="dashboard-cell" style="background: rgba(var(--maf-accent-color-rgb), 0.05); border-color: rgba(var(--maf-accent-color-rgb), 0.2);">
                                <div class="cell-label" style="color: var(--maf-accent-color);">Итого</div>
                                <div class="total-content">
                                    <span class="total-value">{{ calculatePlayerScore(playerData.roleKey) }}</span>
                                    <div v-if="(winnerTeam === 'civilians' && (!playerData.role || playerData.role === 'sheriff')) || (winnerTeam === 'mafia' && (playerData.role === 'don' || playerData.role === 'black'))" class="win-badge">
                                        +1 Победа
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>

            <div style="margin-top:20px; width:100%;">
                <button class="glass-btn funky-back-btn" style="width:100%; margin-bottom:12px;" @click="setWinnerTeam(null); window.haptic.impact('light');">
                    <i class="fa fa-arrow-left" style="margin-right:6px;"></i>
                    <span>Назад</span>
                </button>
                <div class="slide-confirm slide-confirm--save" ref="slider_save_results">
                    <div class="slide-confirm__progress"></div>
                    <div class="slide-confirm__text">Сохранить результаты</div>
                    <div class="slide-confirm__thumb">
                        <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Таблица игроков (скрывается если выбран победитель или идёт раздача ролей) -->
        <div v-else-if="tableOut?.length && rolesDistributed" class="players-list">
            <!-- Phase label above the table (Discussion / Free Seating) -->
            <div v-if="(gamePhase==='discussion' || gamePhase==='freeSeating') && !winnerTeam" class="phase-label-above-table">
                {{ gamePhase==='discussion' ? (cityMode ? 'Знакомство' : 'Договорка') : 'Свободная посадка' }}
            </div>
            <div v-for="(playerData, index) in tableOut"
                 :key="playerData.roleKey"
                 class="player-row"
                 :class="{
                    'highlighted': highlightedPlayer === playerData.roleKey && gamePhase !== 'discussion' && gamePhase !== 'freeSeating',
                    'killed': playerData.action === 'killed',
                    'voted': playerData.action === 'voted',
                    'removed': playerData.action === 'removed',
                    'tech-fall-removed': playerData.action === 'tech_fall_removed',
                    'fall-removed': playerData.action === 'fall_removed',
                    'mode-day': currentMode==='day',
                    'mode-night': currentMode==='night',
                    'mode-old': currentMode==='old',
                    'foul-4': currentMode==='day' && playerData.foul===4,
                    'player-inactive': ['removed','voted','tech_fall_removed','fall_removed'].includes(playerData.action) || (playerData.action==='killed' && protocolAccepted[playerData.roleKey]),
                    'killed-blink': killedPlayerBlink[playerData.roleKey],
                    'night-don-pulse': currentMode==='night' && nightPhase==='don' && roles[playerData.roleKey]==='don',
                    'night-sheriff-pulse': currentMode==='night' && nightPhase==='sheriff' && roles[playerData.roleKey]==='sheriff',
                    'night-doctor-pulse': currentMode==='night' && nightPhase==='doctor' && roles[playerData.roleKey]==='doctor'
                 }"
                 :style="{'--i':index}"
                 onclick="void(0)"
                 @click="toggleHighlight(playerData.roleKey, $event); window.haptic.selection();"
            >
                <div class="player-row-content">
                    <b class="flex-fixed player-num">{{index + 1}}</b>
                    <div class="avatar-uploader flex-fixed">
                        <div class="avatar" :style="{backgroundImage: playerData.avatarCss}"></div>
                        <div v-if="avatarExHas(playerData.roleKey)" class="avatar-x" @click.stop="avatarExSet(playerData.roleKey); window.haptic.impact('light');">
                            <i class="fa fa-times"></i>
                        </div>
                        <div class="hovered" @click.stop="avatarExLoad(playerData.roleKey)">
                            <i class="fa fa-camera"></i>
                            <input type="file" accept="image/*" @change="onAvatarExUpload($event, playerData.roleKey)" ref="fileInputs" />
                        </div>
                    </div>
                    <template v-if="manualMode && !funkyMode && !cityMode">
                        <template v-if="manualGameSelected === 1">
                            <input class="input-compact" v-model="manualPlayers[index].login" placeholder="Имя игрока">
                        </template>
                        <template v-else>
                            <select v-model="manualPlayers[index].login" @change="onManualSelectPlayer(index)">
                                <option value="">— Новый игрок —</option>
                                <option v-for="(p, idx) in firstGamePlayers" :value="p.login">{{p.login}}</option>
                            </select>
                        </template>
                    </template>
                    <div v-else class="text-ellipsis player-name">{{playerData.login}}</div>
                    <div class="role-badges-right">
                        <!-- Удалённый/убитый игрок: кнопка Вернуть (с удержанием) -->
                        <template v-if="['removed','killed','voted','tech_fall_removed','fall_removed'].includes(playerData.action)">
                            <span class="day-status-label" v-if="playerData.action==='killed'">Убит</span>
                            <span class="day-status-label" v-else-if="playerData.action==='voted'">Голосование</span>
                            <span class="day-status-label" v-else-if="playerData.action==='fall_removed'">4 фола</span>
                            <span class="day-status-label" v-else-if="playerData.action==='tech_fall_removed'">2 ТФ</span>
                            <span class="day-status-label" v-else>Удалён</span>
                            <button class="day-return-btn"
                                    @click.stop.prevent
                                    @touchstart.prevent.stop="startDayHold(playerData.roleKey, 'return', $event)"
                                    @touchend.prevent.stop="cancelDayHold()"
                                    @touchcancel.prevent.stop="cancelDayHold()"
                                    @mousedown.prevent.stop="startDayHold(playerData.roleKey, 'return', $event)"
                                    @mouseup.prevent.stop="cancelDayHold()"
                                    @mouseleave.stop="cancelDayHold()">
                                <i class="mdi mdi-heart"></i>
                            </button>
                        </template>
                        <template v-else>
                        <!-- Режим День -->
                        <template v-if="currentMode==='day'">
                            <!-- Фол: тап +1, удержание -1 -->
                            <button class="day-foul-pill"
                                    :class="{ 'foul-warn': playerData.foul >= 3, 'foul-hot': playerData.foul >= 2 }"
                                    @click.stop.prevent
                                    @touchstart.prevent.stop="startDayHold(playerData.roleKey, 'foul', $event)"
                                    @touchend.prevent.stop="cancelDayHold()"
                                    @touchcancel.prevent.stop="cancelDayHold()"
                                    @mousedown.prevent.stop="startDayHold(playerData.roleKey, 'foul', $event)"
                                    @mouseup.prevent.stop="cancelDayHold()"
                                    @mouseleave.stop="cancelDayHold()">
                                <span class="pill-label">Ф</span><span class="pill-count">{{playerData.foul}}</span>
                            </button>
                            <!-- Тех.фол: тап +1, удержание -1 (не используется в городской мафии) -->
                            <button v-if="!cityMode" class="day-techfoul-pill"
                                    :class="{ 'tf-warn': playerData.techFoul >= 1 }"
                                    @click.stop.prevent
                                    @touchstart.prevent.stop="startDayHold(playerData.roleKey, 'techfoul', $event)"
                                    @touchend.prevent.stop="cancelDayHold()"
                                    @touchcancel.prevent.stop="cancelDayHold()"
                                    @mousedown.prevent.stop="startDayHold(playerData.roleKey, 'techfoul', $event)"
                                    @mouseup.prevent.stop="cancelDayHold()"
                                    @mouseleave.stop="cancelDayHold()">
                                <span class="pill-label">ТФ</span><span class="pill-count">{{playerData.techFoul}}</span>
                            </button>
                            <!-- Удалить: только удержание -->
                            <button class="day-remove-btn"
                                    @click.stop.prevent
                                    @touchstart.prevent.stop="startDayHold(playerData.roleKey, 'remove', $event)"
                                    @touchend.prevent.stop="cancelDayHold()"
                                    @touchcancel.prevent.stop="cancelDayHold()"
                                    @mousedown.prevent.stop="startDayHold(playerData.roleKey, 'remove', $event)"
                                    @mouseup.prevent.stop="cancelDayHold()"
                                    @mouseleave.stop="cancelDayHold()">
                                <i class="mdi mdi-account-remove"></i>
                            </button>
                        </template>
                        <!-- Режим Ночь -->
                        <template v-if="currentMode==='night'">
                            <button class="night-kill-btn" @click.stop="actionSet(playerData.roleKey, 'killed', { nightKill: true }); window.haptic.impact('heavy');" :class="{active: playerData.action==='killed'}">
                                Убить
                            </button>
                        </template>
                        </template>
                    </div>
                </div>
                <transition name="slide-fade">
                    <div v-if="highlightedPlayer === playerData.roleKey && gamePhase !== 'discussion' && gamePhase !== 'freeSeating'" class="candidate-menu" @click.stop @touchstart.stop>

                        <!-- ============ НОЧНАЯ ПРОВЕРКА (Дон / Шериф) ============ -->
                        <div v-if="currentMode==='night' && (roles[playerData.roleKey]==='don' || roles[playerData.roleKey]==='sheriff')" class="night-check-section">
                            <div class="section-title" style="margin-bottom:8px;">
                                {{ roles[playerData.roleKey]==='don' ? '🔍 Проверка Дона' : '🔍 Проверка Шерифа' }}
                            </div>
                            <!-- Если Дон/Шериф выбыл раньше — показываем причину и кнопку «Продолжить» -->
                            <div v-if="_wasKilledBeforeThisNight(playerData.roleKey)" class="night-check-dead-msg">
                                <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:10px;">
                                    <i class="mdi mdi-skull" style="font-size:18px;"></i>
                                    <span>{{ _getDeathReasonText(playerData.roleKey) }} — проверка невозможна</span>
                                </div>
                                <button class="night-check-continue-btn" @click.stop="advanceNightPhase(); window.haptic.impact('medium');">
                                    Продолжить ➜
                                </button>
                            </div>
                            <template v-else>
                                <div v-if="!nightChecks[playerData.roleKey]" class="night-check-grid">
                                    <button v-for="n in tableOut.length" :key="'nc'+n"
                                            class="night-check-btn"
                                            @click.stop="performNightCheck(playerData.roleKey, n); window.haptic.impact('medium');">
                                        {{ n }}
                                    </button>
                                </div>
                                <div v-else class="night-check-result" :class="{ positive: nightChecks[playerData.roleKey].result.includes('✅') }">
                                    <div class="night-check-target">Игрок {{ nightChecks[playerData.roleKey].target }}</div>
                                    <div class="night-check-answer">{{ nightChecks[playerData.roleKey].result }}</div>
                                </div>
                            </template>
                        </div>

                        <!-- ============ НОЧНОЕ ЛЕЧЕНИЕ (Доктор — только городская мафия) ============ -->
                        <div v-if="currentMode==='night' && cityMode && roles[playerData.roleKey]==='doctor' && nightPhase==='doctor'" class="night-check-section">
                            <div class="section-title" style="margin-bottom:8px;">
                                💊 Лечение Доктора
                            </div>
                            <!-- Если Доктор выбыл раньше — показываем причину и кнопку «Продолжить» -->
                            <div v-if="_wasKilledBeforeThisNight(playerData.roleKey)" class="night-check-dead-msg">
                                <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:10px;">
                                    <i class="mdi mdi-skull" style="font-size:18px;"></i>
                                    <span>Доктор выбыл — лечение невозможно</span>
                                </div>
                                <button class="night-check-continue-btn" @click.stop="advanceNightPhase(); window.haptic.impact('medium');">
                                    Продолжить ➜
                                </button>
                            </div>
                            <template v-else>
                                <div v-if="!doctorHeal" class="night-check-grid">
                                    <button v-for="n in tableOut.length" :key="'dh'+n"
                                            class="night-check-btn"
                                            :class="{ 'night-check-btn-disabled': !canDoctorHealTarget(n) }"
                                            :disabled="!canDoctorHealTarget(n)"
                                            @click.stop="performDoctorHeal(n); window.haptic.impact('medium');">
                                        {{ n }}
                                    </button>
                                </div>
                                <div v-else class="night-check-result" :class="{ positive: true }">
                                    <div class="night-check-target">Лечит игрока {{ doctorHeal.target }}</div>
                                    <div class="night-check-answer" v-if="doctorHeal.target">Вылечен 💊</div>
                                    <div class="night-check-answer" v-else>Пропуск</div>
                                </div>
                                <button v-if="!doctorHeal" class="night-check-continue-btn" style="margin-top: 10px; opacity: 0.6;" @click.stop="skipDoctorHeal(); window.haptic.impact('light');">
                                    Пропустить лечение
                                </button>
                            </template>
                        </div>

                        <!-- ============ ЖИВОЙ ИГРОК: Таймер + Кандидаты (только День) ============ -->
                        <template v-if="playerData.action !== 'killed' && currentMode==='day'">
                            <div class="timer-section">
                                <div class="timer-status-pill" :class="{
                                    'status-running': getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused,
                                    'status-paused': getTimerDisplay(playerData.roleKey).isPaused,
                                    'status-finished': getTimerDisplay(playerData.roleKey).timeLeft === 0 && !getTimerDisplay(playerData.roleKey).isRunning
                                }">
                                    {{ getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused ? 'Речь идет' : getTimerDisplay(playerData.roleKey).isPaused ? 'Пауза' : getTimerDisplay(playerData.roleKey).timeLeft === 0 ? 'Время вышло' : 'Готов' }}
                                </div>
                                <div class="timer-display" :class="{
                                    normal: getTimerDisplay(playerData.roleKey).timeLeft > 0 && (!getTimerDisplay(playerData.roleKey).isRunning || getTimerDisplay(playerData.roleKey).isPaused),
                                    running: getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused && getTimerDisplay(playerData.roleKey).timeLeft > 10,
                                    warning: getTimerDisplay(playerData.roleKey).timeLeft <= 10 && getTimerDisplay(playerData.roleKey).timeLeft > 0 && getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused,
                                    paused: getTimerDisplay(playerData.roleKey).isPaused,
                                    finished: getTimerDisplay(playerData.roleKey).timeLeft === 0
                                }"
                                    @mousedown.prevent.stop="timerHoldStart(playerData.roleKey)"
                                    @mouseup.prevent.stop="timerHoldEnd(playerData.roleKey, $event)"
                                    @mouseleave.stop="timerHoldCancel(playerData.roleKey)"
                                    @touchstart.prevent.stop="timerHoldStart(playerData.roleKey)"
                                    @touchend.prevent.stop="timerHoldEnd(playerData.roleKey, $event)"
                                    @touchcancel.prevent.stop="timerHoldCancel(playerData.roleKey)">
                                    {{ formatTimerTime(getTimerDisplay(playerData.roleKey).timeLeft) }}
                                </div>
                                <div class="timer-controls">
                                    <button class="timer-btn timer-add"
                                        :disabled="!isAddTimeButtonAvailable(playerData.roleKey)"
                                        @click.stop="addThirtySecondsToTimer(playerData.roleKey); window.haptic.impact('light');">
                                        +30 сек
                                    </button>
                                </div>
                                <div class="timer-hint">Клик: Старт/Пауза | Удержание: Сброс</div>
                            </div>
                            <div v-if="!cityMode" class="candidate-grid">
                                <button v-for="n in tableOut.length" :key="'cand'+n"
                                        class="candidate-btn"
                                        :class="candidateButtonClass(playerData.roleKey, n)"
                                        :disabled="isCandidateButtonDisabled(playerData.roleKey, n)"
                                        @click.stop="toggleNomination(playerData.roleKey, n); window.haptic.selection();">
                                    {{ n }}
                                </button>
                            </div>
                            <div v-if="!cityMode && nominations[playerData.roleKey] && nominations[playerData.roleKey].length" class="text-center text-accent font-bold text-large mt-md">
                                Выставлен: <span style="font-size:1.18em;">{{ nominations[playerData.roleKey][0] }}</span>
                            </div>
                        </template>

                        <!-- ============ УБИТЫЙ ИГРОК: Фазовый UI (только день) ============ -->
                        <template v-if="playerData.action === 'killed' && currentMode==='day'">

                            <!-- ФАЗА: Лучший ход (только первый убитый) -->
                            <div v-if="killedCardPhase[playerData.roleKey] === 'bm' && firstKilledPlayer === playerData.roleKey" class="killed-phase-section">
                                <div class="section-title" style="margin-bottom:8px;">🎯 Лучший ход</div>
                                <div class="bm-grid">
                                    <button v-for="n in tableOut.length" :key="'bm2'+n"
                                            class="bm-btn"
                                            :class="{ selected: bestMove.includes(n) }"
                                            :disabled="tableOut[n-1]?.roleKey === firstKilledPlayer"
                                            @click.stop="toggleBestMove(n); window.haptic.selection();">
                                        {{ n }}
                                    </button>
                                </div>
                                <div v-if="bestMove.length" class="text-center text-accent font-bold mt-md" style="font-size:1.1em;">
                                    ЛХ: {{ bestMove.join(', ') }}
                                </div>
                                <button class="killed-hold-btn accept-btn"
                                        @click.stop.prevent
                                        @touchstart.prevent.stop="startBestMoveHold(playerData.roleKey)"
                                        @touchend.prevent.stop="cancelProtocolHold()"
                                        @touchcancel.prevent.stop="cancelProtocolHold()"
                                        @mousedown.prevent.stop="startBestMoveHold(playerData.roleKey)"
                                        @mouseup.prevent.stop="cancelProtocolHold()"
                                        @mouseleave.stop="cancelProtocolHold()">
                                    <i class="fa fa-check" style="margin-right:6px;"></i> Принять ЛХ
                                    <div class="hold-progress" :class="{ active: dayHoldActive && _dayHoldType === 'accept_bm' }"></div>
                                </button>
                                <div class="hold-hint">Удерживайте для подтверждения</div>
                            </div>

                            <!-- ФАЗА: Таймер + кнопка "Протокол/Мнение" -->
                            <div v-if="killedCardPhase[playerData.roleKey] === 'timer'" class="killed-phase-section">
                                <!-- Кнопка редактирования ЛХ (только первый убитый) -->
                                <button v-if="firstKilledPlayer === playerData.roleKey && bestMoveAccepted" class="killed-hold-btn edit-btn"
                                        @click.stop.prevent
                                        @touchstart.prevent.stop="startEditBestMoveHold(playerData.roleKey)"
                                        @touchend.prevent.stop="cancelProtocolHold()"
                                        @touchcancel.prevent.stop="cancelProtocolHold()"
                                        @mousedown.prevent.stop="startEditBestMoveHold(playerData.roleKey)"
                                        @mouseup.prevent.stop="cancelProtocolHold()"
                                        @mouseleave.stop="cancelProtocolHold()">
                                    <i class="fa fa-pencil-alt" style="margin-right:6px;"></i> Изменить ЛХ
                                    <div class="hold-progress" :class="{ active: dayHoldActive && _dayHoldType === 'edit_bm' }"></div>
                                </button>

                                <div class="timer-section">
                                    <div class="timer-status-pill" :class="{
                                        'status-running': getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused,
                                        'status-paused': getTimerDisplay(playerData.roleKey).isPaused,
                                        'status-finished': getTimerDisplay(playerData.roleKey).timeLeft === 0 && !getTimerDisplay(playerData.roleKey).isRunning
                                    }">
                                        {{ getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused ? 'Речь идет' : getTimerDisplay(playerData.roleKey).isPaused ? 'Пауза' : getTimerDisplay(playerData.roleKey).timeLeft === 0 ? 'Время вышло' : 'Готов' }}
                                    </div>
                                    <div class="timer-display" :class="{
                                        normal: getTimerDisplay(playerData.roleKey).timeLeft > 0 && (!getTimerDisplay(playerData.roleKey).isRunning || getTimerDisplay(playerData.roleKey).isPaused),
                                        running: getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused && getTimerDisplay(playerData.roleKey).timeLeft > 10,
                                        warning: getTimerDisplay(playerData.roleKey).timeLeft <= 10 && getTimerDisplay(playerData.roleKey).timeLeft > 0 && getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused,
                                        paused: getTimerDisplay(playerData.roleKey).isPaused,
                                        finished: getTimerDisplay(playerData.roleKey).timeLeft === 0
                                    }"
                                        @mousedown.prevent.stop="timerHoldStart(playerData.roleKey)"
                                        @mouseup.prevent.stop="timerHoldEnd(playerData.roleKey, $event)"
                                        @mouseleave.stop="timerHoldCancel(playerData.roleKey)"
                                        @touchstart.prevent.stop="timerHoldStart(playerData.roleKey)"
                                        @touchend.prevent.stop="timerHoldEnd(playerData.roleKey, $event)"
                                        @touchcancel.prevent.stop="timerHoldCancel(playerData.roleKey)">
                                        {{ formatTimerTime(getTimerDisplay(playerData.roleKey).timeLeft) }}
                                    </div>
                                    <div class="timer-controls">
                                        <button class="timer-btn timer-add"
                                            :disabled="!isAddTimeButtonAvailable(playerData.roleKey)"
                                            @click.stop="addThirtySecondsToTimer(playerData.roleKey); window.haptic.impact('light');">
                                            +30 сек
                                        </button>
                                    </div>
                                    <div class="timer-hint">Клик: Старт/Пауза | Удержание: Сброс</div>
                                </div>
                                <button v-if="!cityMode" class="killed-hold-btn protocol-open-btn" @click.stop="openProtocolForKilled(playerData.roleKey); window.haptic.impact('light');">
                                    <i class="fa fa-file-alt" style="margin-right:6px;"></i> Протокол / Мнение
                                </button>
                            </div>

                            <!-- ФАЗА: Протокол и Мнение (не показываем в городской мафии) -->
                            <div v-if="killedCardPhase[playerData.roleKey] === 'protocol' && !cityMode" class="killed-phase-section">
                                <div class="protocol-section">
                                    <div class="section-title">Протокол</div>
                                    <div class="protocol-grid">
                                        <button v-for="n in tableOut.length" :key="'prot'+n"
                                                class="protocol-btn"
                                                :class="getProtocolRoleClass(playerData.roleKey, n)"
                                                @click.stop="toggleProtocolRole(playerData.roleKey, n); window.haptic.selection();">
                                            <span class="player-num">{{ n }}</span>
                                            <span class="role-label">{{ getProtocolRoleLabel(playerData.roleKey, n) }}</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="opinion-section">
                                    <div class="section-title">Мнение</div>
                                    <div class="opinion-grid">
                                        <button v-for="n in tableOut.length" :key="'opin'+n"
                                                class="opinion-btn"
                                                :class="getOpinionRoleClass(playerData.roleKey, n)"
                                                @click.stop="toggleOpinionRole(playerData.roleKey, n); window.haptic.selection();">
                                            <span class="player-num">{{ n }}</span>
                                            <span class="role-label">{{ getOpinionRoleLabel(playerData.roleKey, n) }}</span>
                                        </button>
                                    </div>
                                    <textarea class="opinion-text" placeholder="Введите мнение..."
                                        :value="opinionText && opinionText[playerData.roleKey]"
                                        @input="updateOpinionText(playerData.roleKey, $event.target.value)"
                                        @click.stop @touchstart.stop></textarea>
                                </div>
                                <button class="killed-hold-btn accept-btn"
                                        @click.stop.prevent
                                        @touchstart.prevent.stop="startProtocolHold(playerData.roleKey)"
                                        @touchend.prevent.stop="cancelProtocolHold()"
                                        @touchcancel.prevent.stop="cancelProtocolHold()"
                                        @mousedown.prevent.stop="startProtocolHold(playerData.roleKey)"
                                        @mouseup.prevent.stop="cancelProtocolHold()"
                                        @mouseleave.stop="cancelProtocolHold()">
                                    <i class="fa fa-check" style="margin-right:6px;"></i> Принять Протокол
                                    <div class="hold-progress" :class="{ active: dayHoldActive && _dayHoldType === 'accept_protocol' }"></div>
                                </button>
                                <div class="hold-hint">Удерживайте для подтверждения</div>
                            </div>

                            <!-- ФАЗА: Готово (только кнопки редактирования) -->
                            <div v-if="killedCardPhase[playerData.roleKey] === 'done'" class="killed-phase-section killed-done-phase">
                                <button v-if="firstKilledPlayer === playerData.roleKey" class="killed-hold-btn edit-btn"
                                        @click.stop.prevent
                                        @touchstart.prevent.stop="startEditBestMoveHold(playerData.roleKey)"
                                        @touchend.prevent.stop="cancelProtocolHold()"
                                        @touchcancel.prevent.stop="cancelProtocolHold()"
                                        @mousedown.prevent.stop="startEditBestMoveHold(playerData.roleKey)"
                                        @mouseup.prevent.stop="cancelProtocolHold()"
                                        @mouseleave.stop="cancelProtocolHold()">
                                    <i class="fa fa-pencil-alt" style="margin-right:6px;"></i> Изменить ЛХ
                                    <div class="hold-progress" :class="{ active: dayHoldActive && _dayHoldType === 'edit_bm' }"></div>
                                </button>
                                <button v-if="!cityMode" class="killed-hold-btn edit-btn"
                                        @click.stop.prevent
                                        @touchstart.prevent.stop="startEditProtocolHold(playerData.roleKey)"
                                        @touchend.prevent.stop="cancelProtocolHold()"
                                        @touchcancel.prevent.stop="cancelProtocolHold()"
                                        @mousedown.prevent.stop="startEditProtocolHold(playerData.roleKey)"
                                        @mouseup.prevent.stop="cancelProtocolHold()"
                                        @mouseleave.stop="cancelProtocolHold()">
                                    <i class="fa fa-pencil-alt" style="margin-right:6px;"></i> Изменить Протокол / Мнение
                                    <div class="hold-progress" :class="{ active: dayHoldActive && _dayHoldType === 'edit_protocol' }"></div>
                                </button>
                            </div>

                            <!-- Fallback: если фаза не установлена — показать кнопку для начала -->
                            <div v-if="!killedCardPhase[playerData.roleKey] && !cityMode" class="killed-phase-section">
                                <button class="killed-hold-btn protocol-open-btn" @click.stop="openProtocolForKilled(playerData.roleKey); window.haptic.impact('light');">
                                    <i class="fa fa-file-alt" style="margin-right:6px;"></i> Протокол / Мнение
                                </button>
                            </div>

                        </template>
                    </div>
                </transition>
            </div>
            <!-- Кнопка Промах (внутри списка игроков, под 10 игроком) -->
            <div v-if="currentMode==='night' && !winnerTeam && rolesDistributed && !cityMode && (!nightPhase || nightPhase==='kill') && !nightMisses[nightNumber]"
                 class="player-row night-miss-row"
                 @click.stop="setNightMiss(); window.haptic.notification('warning');">
                <div class="player-row-content night-miss-row-content">
                    <i class="mdi mdi-close-circle-outline night-miss-row-icon"></i>
                    <span class="night-miss-row-label">Промах</span>
                </div>
            </div>
        </div>

        <!-- Кнопка голосования (под таблицей игроков) -->
        <div v-if="tableOut?.length && !winnerTeam && rolesDistributed && gamePhase==='day'" class="voting-btn-container">
            <button class="glass-btn game-voting-btn" @click="openVotingScreen(); window.haptic.impact('medium');">
                <i class="fa fa-gavel" style="margin-right: 8px;"></i>
                Голосование
            </button>
        </div>

        <!-- Кнопки настроек трансляции, завершения и выхода -->
        <div class="game-actions-container" v-if="tableOut?.length && rolesDistributed">
            <button class="glass-btn game-broadcast-btn" @click="openBroadcastSettings(); window.haptic.impact('light');">
                <i class="fa fa-sliders-h" style="margin-right: 8px;"></i>
                Настройки трансляции
            </button>
            <div v-if="!winnerTeam && (gamePhase==='day' || gamePhase==='night')" style="width:100%; max-width:400px;">
                <div class="slide-confirm" ref="slider_finish_game">
                    <div class="slide-confirm__progress"></div>
                    <div class="slide-confirm__text">Завершить игру</div>
                    <div class="slide-confirm__thumb">
                        <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                    </div>
                </div>
            </div>
            <div style="width:100%; max-width:400px; margin-top:10px;">
                <div class="slide-confirm slide-confirm--compact slide-confirm--danger" ref="slider_exit_game">
                    <div class="slide-confirm__progress"></div>
                    <div class="slide-confirm__text">Выход в меню</div>
                    <div class="slide-confirm__thumb">
                        <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Панель выбора игры (только для ручного режима) -->
        <div v-if="tableOut?.length && manualMode && !funkyMode && !cityMode && rolesDistributed" class="game-table-panel">
            <div class="flex">
                <!-- Карточка Игры -->
                <div class="game-option-card">
                    <div class="label">Игра</div>
                    <select
                        v-model.number="manualGameSelected"
                        @change="onGameSelectChange($event)">
                        <option v-for="game in manualGames" :value="game.num">
                            {{game.num}}
                        </option>
                        <option value="new">+ Новая</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Экран Настройки трансляции (полноэкранный) -->
        <div v-if="showBroadcastSettings" class="fullscreen-page">
            <div class="fullscreen-page-container">
                <div class="fullscreen-page-header">
                    <button class="fullscreen-back-btn" @click="cancelBroadcastSettings(); window.haptic.impact('light');">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h1 class="fullscreen-page-title">Настройки трансляции</h1>
                    <div style="width: 40px;"></div>
                </div>

                <div class="broadcast-settings-body">
                    <div class="broadcast-section-title">Отображение на трансляции</div>
                    <div class="switches-bottom">
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="mainInfoVisible">
                            <span class="slider"></span>
                            <span>Основная информация</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="additionalInfoVisible">
                            <span class="slider"></span>
                            <span>Доп. информация</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideSeating">
                            <span class="slider"></span>
                            <span>Скрыть рассадку</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideLeaveOrder">
                            <span class="slider"></span>
                            <span>Скрыть порядок ухода</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideRolesStatus">
                            <span class="slider"></span>
                            <span>Скрыть роли и статус</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideBestMove">
                            <span class="slider"></span>
                            <span>Скрыть ЛХ</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="showRoomNumber">
                            <span class="slider"></span>
                            <span>Показать номер комнаты</span>
                        </label>
                    </div>

                    <div class="broadcast-section-title" style="margin-top: 24px;">Привязка к трансляции</div>
                    <div class="broadcast-room-field">
                        <label class="profile-field-label">Номер комнаты</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="profile-field-input"
                               v-model="roomInput" maxlength="4" placeholder="1234"
                               @input="roomInput = roomInput.replace(/[^0-9]/g, '')">
                        <div class="profile-field-hint">Для привязки игровой панели к roles.html</div>
                    </div>
                </div>

                <button class="glass-btn w-full btn-primary mt-20" @click="saveBroadcastSettings(); window.haptic.notification('success');">
                    <i class="fa fa-check" style="margin-right: 8px;"></i>
                    Сохранить
                </button>
                <button class="glass-btn w-full mt-10" style="opacity: 0.6;" @click="cancelBroadcastSettings(); window.haptic.impact('light');">
                    <i class="fa fa-arrow-left" style="margin-right: 8px;"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- ============ ПОЛНОЭКРАННАЯ СТРАНИЦА ГОЛОСОВАНИЯ ============ -->
        <div v-if="showVotingScreen" class="voting-fullscreen-page">

            <!-- ===== ВКЛАДКА: ГОЛОСОВАНИЕ ===== -->
            <div v-if="votingScreenTab === 'voting'" class="voting-screen-content voting-screen-content--no-scroll">

                <!-- Состояние: нет выставленных кандидатур и нет активного голосования -->
                <div v-if="!showVotingModal && !hasNominatedCandidates() && !cityMode" class="voting-empty-state">
                    <div class="voting-empty-icon">🗳️</div>
                    <div class="voting-empty-title">Нет кандидатур</div>
                    <div class="voting-empty-text">На голосование не выставлена ни одна кандидатура</div>
                    <button class="glass-btn btn-primary voting-empty-night-btn" @click="goToNightFromVoting(); window.haptic.impact('medium');">
                        <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i>
                        Перейти в ночь
                    </button>
                </div>

                <!-- City mode: день 0 — голосование не проводится -->
                <div v-if="!showVotingModal && cityMode && dayNumber === 0" class="voting-empty-state">
                    <div class="voting-empty-icon">🚫</div>
                    <div class="voting-empty-title">В первый день голосование не проводится</div>
                    <button class="glass-btn btn-primary voting-empty-night-btn" @click="goToNightFromVoting(); window.haptic.impact('medium');">
                        <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i>
                        Перейти в ночь
                    </button>
                </div>

                <!-- City mode: стартовый экран — начать голосование (день > 0) -->
                <div v-if="!showVotingModal && cityMode && dayNumber > 0" class="voting-empty-state">
                    <div class="voting-empty-icon">🗳️</div>
                    <div class="voting-empty-title">Голосование</div>
                    <button class="glass-btn btn-primary voting-empty-night-btn" @click="startCityVoting(); window.haptic.impact('medium');" style="margin-bottom: 12px;">
                        <i class="mdi mdi-vote" style="margin-right:8px;"></i>
                        Начать голосование
                    </button>
                    <button class="glass-btn voting-empty-night-btn" @click="goToNightFromVoting(); window.haptic.impact('medium');">
                        <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i>
                        Перейти в ночь
                    </button>
                </div>

                <!-- Состояние: активное голосование -->
                <div v-if="showVotingModal" class="voting-active-content voting-active-content--compact">

                    <!-- === ЭКРАН: День 0 — один кандидат, голосование не проводится === -->
                    <template v-if="votingDay0SingleCandidate">
                        <div class="voting-finish-screen">
                            <div class="voting-empty-icon">☝️</div>
                            <div class="voting-finish-title">Выставлен 1 кандидат — №{{ votingDay0SingleCandidate }}</div>
                            <div class="voting-empty-text" style="margin-bottom:16px;">
                                На нулевом голосовании выставлен только один игрок.<br>Голосование не проводится.
                            </div>
                            <button class="glass-btn voting-action-btn voting-action-btn--primary" @click="dismissDay0VotingAndGoToNight(); window.haptic.impact('medium');">
                                <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i> Перейти в ночь
                            </button>
                        </div>
                    </template>

                    <!-- === ЭКРАН: День 0 — ничья 3+ кандидатов, деление невозможно === -->
                    <template v-else-if="votingDay0TripleTie">
                        <div class="voting-finish-screen">
                            <div class="voting-empty-icon">⚖️</div>
                            <div class="voting-finish-title">Ничья {{ votingDay0TripleTiePlayers.length }} игроков</div>
                            <div class="voting-day0-tie-cards">
                                <span v-for="p in votingDay0TripleTiePlayers" :key="'d0t_'+p" class="voting-day0-tie-badge">{{ p }}</span>
                            </div>
                            <div class="voting-empty-text" style="margin-bottom:16px;">
                                На нулевом голосовании невозможно деление {{ votingDay0TripleTiePlayers.length }} игроков.
                            </div>
                            <button class="glass-btn voting-action-btn voting-action-btn--primary" @click="dismissDay0VotingAndGoToNight(); window.haptic.impact('medium');">
                                <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i> Перейти в ночь
                            </button>
                        </div>
                    </template>

                    <!-- === ЭКРАН: Основное/повторное голосование (выбор голосов) === -->
                    <template v-else-if="!votingFinished && !votingTieTimerActive">
                        <!-- Выставленные кандидаты (только для стандартного режима) -->
                        <div v-if="!cityMode" class="voting-header-compact">
                            <div class="voting-header-order voting-header-order--large">
                                <span v-for="(candidate, idx) in votingOrder" :key="candidate"
                                      :class="['voting-header-candidate', 'voting-header-candidate--lg', {active: votingCurrentIndex === idx}]">
                                    {{ candidate }}
                                </span>
                            </div>
                        </div>

                        <!-- Вопрос -->
                        <div class="voting-question-compact">
                            <template v-if="votingStage === 'main' || votingStage === 'tie'">
                                <span v-if="votingStage === 'tie'" class="voting-stage-badge">Повторное</span>
                                Кто голосует за <b class="city-accent-num" v-if="cityMode">№{{ votingOrder[votingCurrentIndex] }}</b><b v-else>№{{ votingOrder[votingCurrentIndex] }}</b>
                            </template>
                            <template v-else-if="votingStage === 'lift'">
                                <template v-if="cityMode">Голоса за подъем кандидатов</template>
                                <template v-else>Кто за подъем кандидатов?</template>
                            </template>
                        </div>

                        <!-- City mode: прогресс кандидатов -->
                        <div v-if="cityMode && (votingStage === 'main' || votingStage === 'tie')" class="city-vote-progress">
                            {{ votingCurrentIndex + 1 }} / {{ votingOrder.length }}
                        </div>

                        <!-- === CITY MODE: Выбор количества голосов (main/tie) === -->
                        <template v-if="cityMode && (votingStage === 'main' || votingStage === 'tie')">
                            <div class="city-vote-counter">
                                <div class="city-vote-counter-num" :class="{ 'city-vote-counter-active': (cityVoteCounts[votingOrder[votingCurrentIndex]] || 0) > 0 }">{{ cityVoteCounts[votingOrder[votingCurrentIndex]] || 0 }}</div>
                                <div class="city-vote-counter-sub">
                                    <span v-if="votingCurrentIndex < votingOrder.length - 1">осталось: {{ cityGetMaxVotesForCurrent() - (cityVoteCounts[votingOrder[votingCurrentIndex]] || 0) }}</span>
                                    <span v-else>последний · авто-досып</span>
                                </div>
                            </div>
                            <div class="voting-keypad">
                                <div class="voting-keypad-row" v-for="(rowItems, rowIdx) in cityGetVoteRows(cityGetMaxVotesForCurrent())" :key="'cvr'+rowIdx">
                                    <button v-for="n in rowItems"
                                            :key="'cv'+n"
                                            :class="['modal-btn', { 'selected': (cityVoteCounts[votingOrder[votingCurrentIndex]] || 0) === n }]"
                                            @click="citySetVoteCount(n); window.haptic.selection();">
                                        {{ n }}
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- === CITY MODE: Выбор количества голосов (lift) === -->
                        <template v-else-if="cityMode && votingStage === 'lift'">
                            <div class="city-vote-counter">
                                <div class="city-vote-counter-num" :class="{ 'city-vote-counter-active': votingLiftResults.length > 0 }">{{ votingLiftResults.length }}</div>
                                <div class="city-vote-counter-sub">голосов за подъём</div>
                            </div>
                            <div class="voting-keypad">
                                <div class="voting-keypad-row" v-for="(rowItems, rowIdx) in cityGetVoteRows(cityGetAliveCount())" :key="'clr'+rowIdx">
                                    <button v-for="n in rowItems"
                                            :key="'cl'+n"
                                            :class="['modal-btn', { 'selected': votingLiftResults.length === n }]"
                                            @click="citySetLiftVoteCount(n); window.haptic.selection();">
                                        {{ n }}
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- === STANDARD MODE: Кнопки игроков (main/tie) === -->
                        <template v-else>
                        <div v-if="votingStage === 'main' || votingStage === 'tie'" class="voting-keypad">
                            <div class="voting-keypad-row">
                                <button v-for="n in [1,2,3]" :key="'vote'+n" :class="getVotingButtonClass(n)" :disabled="!isVotingButtonEnabled(n)" @click="toggleVotingSelection(n); window.haptic.selection();">{{ n }}</button>
                            </div>
                            <div class="voting-keypad-row">
                                <button v-for="n in [4,5,6]" :key="'vote'+n" :class="getVotingButtonClass(n)" :disabled="!isVotingButtonEnabled(n)" @click="toggleVotingSelection(n); window.haptic.selection();">{{ n }}</button>
                            </div>
                            <div class="voting-keypad-row">
                                <button v-for="n in [7,8,9]" :key="'vote'+n" :class="getVotingButtonClass(n)" :disabled="!isVotingButtonEnabled(n)" @click="toggleVotingSelection(n); window.haptic.selection();">{{ n }}</button>
                            </div>
                            <div class="voting-keypad-row voting-keypad-row--center">
                                <button :class="getVotingButtonClass(10)" :disabled="!isVotingButtonEnabled(10)" @click="toggleVotingSelection(10); window.haptic.selection();">10</button>
                            </div>
                        </div>

                        <!-- Кнопки игроков (lift) -->
                        <div v-else-if="votingStage === 'lift'" class="voting-keypad">
                            <div class="voting-keypad-row">
                                <button v-for="n in [1,2,3]" :key="'lift'+n" :class="getLiftVotingButtonClass(n)" :disabled="!isLiftVotingButtonEnabled(n)" @click="toggleLiftVotingSelection(n); window.haptic.selection();">{{ n }}</button>
                            </div>
                            <div class="voting-keypad-row">
                                <button v-for="n in [4,5,6]" :key="'lift'+n" :class="getLiftVotingButtonClass(n)" :disabled="!isLiftVotingButtonEnabled(n)" @click="toggleLiftVotingSelection(n); window.haptic.selection();">{{ n }}</button>
                            </div>
                            <div class="voting-keypad-row">
                                <button v-for="n in [7,8,9]" :key="'lift'+n" :class="getLiftVotingButtonClass(n)" :disabled="!isLiftVotingButtonEnabled(n)" @click="toggleLiftVotingSelection(n); window.haptic.selection();">{{ n }}</button>
                            </div>
                            <div class="voting-keypad-row voting-keypad-row--center">
                                <button :class="getLiftVotingButtonClass(10)" :disabled="!isLiftVotingButtonEnabled(10)" @click="toggleLiftVotingSelection(10); window.haptic.selection();">10</button>
                            </div>
                        </div>
                        </template>

                        <!-- Уведомления -->
                        <div v-if="votingNotification" class="text-center font-bold" style="color:var(--status-error);font-size:0.85em;">{{ votingNotification }}</div>

                        <!-- Кнопки действий: Назад + Принять -->
                        <div class="voting-actions-row">
                            <button v-if="votingCurrentIndex > 0 || votingStage === 'lift'" class="glass-btn voting-action-btn voting-action-btn--secondary" @click="prevVoting(); window.haptic.impact('light');">
                                <i class="fa fa-arrow-left" style="margin-right:6px;"></i> Назад
                            </button>
                            <button class="glass-btn voting-action-btn voting-action-btn--primary" @click="acceptCurrentCandidateVotes(); window.haptic.impact('medium');" :disabled="acceptDisabled">
                                Принять
                            </button>
                        </div>
                    </template>

                    <!-- === ЭКРАН: Ничья — карточки игроков с таймером === -->
                    <template v-if="votingTieTimerActive && votingTiePlayers.length > 1">
                        <div class="voting-tie-result-screen">
                            <div class="voting-tie-title">⚖️ Ничья</div>
                            <div class="voting-tie-cards">
                                <div v-for="player in votingTiePlayers" :key="'tie_'+player" class="voting-player-card" :class="{ 'card-active': votingTiePlayers[votingTieTimerPlayerIndex] === player }">
                                    <div class="voting-player-card-num">{{ player }}</div>
                                    <div class="voting-player-card-votes">{{ getVotesForCandidate(player) }} гол.</div>
                                </div>
                            </div>
                            <!-- Таймер -->
                            <div class="voting-tie-timer-block">
                                <div class="timer-status-pill" :class="{
                                    'status-running': votingTieTimerRunning && !votingTieTimerPaused,
                                    'status-paused': votingTieTimerPaused,
                                    'status-finished': votingTieTimerTimeLeft === 0 && !votingTieTimerRunning
                                }">
                                    ⏱ Игрок №{{ votingTiePlayers[votingTieTimerPlayerIndex] }} — {{ votingTieTimerRunning && !votingTieTimerPaused ? 'Речь идет' : votingTieTimerPaused ? 'Пауза' : votingTieTimerTimeLeft === 0 ? 'Время вышло' : 'Готов' }}
                                </div>
                                <div class="voting-timer-display voting-timer-display--compact" :class="{
                                    'running': votingTieTimerRunning && !votingTieTimerPaused && votingTieTimerTimeLeft > 0,
                                    'warning': votingTieTimerTimeLeft <= 10 && votingTieTimerTimeLeft > 0 && votingTieTimerRunning && !votingTieTimerPaused,
                                    'paused': votingTieTimerPaused,
                                    'finished': votingTieTimerTimeLeft === 0
                                }"
                                    @mousedown.prevent.stop="tieTimerHoldStart()"
                                    @mouseup.prevent.stop="tieTimerHoldEnd($event)"
                                    @mouseleave.stop="tieTimerHoldCancel()"
                                    @touchstart.prevent.stop="tieTimerHoldStart()"
                                    @touchend.prevent.stop="tieTimerHoldEnd($event)"
                                    @touchcancel.prevent.stop="tieTimerHoldCancel()">
                                    {{ formatVotingTimerTime(votingTieTimerTimeLeft) }}
                                </div>
                                <div class="timer-controls">
                                    <button class="timer-btn timer-add" @click.stop="addVotingTieTimerTime(30); window.haptic.impact('light');">
                                        +30 сек
                                    </button>
                                </div>
                                <div class="timer-hint">Клик: Старт/Пауза | Удержание: Сброс</div>
                                <div v-if="votingTiePlayers.length > 1" class="voting-timer-nav">
                                    <button class="glass-btn" :disabled="votingTieTimerPlayerIndex <= 0" @click.stop="prevVotingTieTimerPlayer(); window.haptic.impact('light');">
                                        ◀ Пред.
                                    </button>
                                    <span class="voting-timer-player-indicator">
                                        {{ votingTieTimerPlayerIndex + 1 }} / {{ votingTiePlayers.length }}
                                    </span>
                                    <button class="glass-btn" :disabled="votingTieTimerPlayerIndex >= votingTiePlayers.length - 1" @click.stop="nextVotingTieTimerPlayer(); window.haptic.impact('light');">
                                        След. ▶
                                    </button>
                                </div>
                            </div>
                            <button class="glass-btn voting-action-btn voting-action-btn--primary" @click.stop="skipVotingTieTimer(); startTieVoting(); window.haptic.impact('medium');">
                                Повторное голосование
                            </button>
                        </div>
                    </template>

                    <!-- === ЭКРАН: Результат — заголосованные игроки / ночь === -->
                    <template v-if="votingFinished && !votingDay0SingleCandidate && !votingDay0TripleTie">
                        <div class="voting-finish-screen">
                            <!-- Карточки заголосованных игроков с таймером -->
                            <template v-if="votingWinners && votingWinners.length">
                                <div class="voting-finish-title">Заголосованы</div>
                                <div class="voting-winner-cards">
                                    <div v-for="winner in votingWinners" :key="'win_'+winner" class="voting-player-card card-voted" :class="{ 'card-active': votingWinners[votingLastSpeechPlayerIndex] === winner }">
                                        <div class="voting-player-card-num">{{ winner }}</div>
                                    </div>
                                </div>
                                <!-- Таймер крайней речи -->
                                <div v-if="votingLastSpeechTimerActive" class="voting-tie-timer-block">
                                    <div class="timer-status-pill" :class="{
                                        'status-running': votingLastSpeechTimerRunning && !votingLastSpeechTimerPaused,
                                        'status-paused': votingLastSpeechTimerPaused,
                                        'status-finished': votingLastSpeechTimerTimeLeft === 0 && !votingLastSpeechTimerRunning
                                    }">
                                        🎤 №{{ votingWinners[votingLastSpeechPlayerIndex] }} — {{ votingLastSpeechTimerRunning && !votingLastSpeechTimerPaused ? 'Речь идет' : votingLastSpeechTimerPaused ? 'Пауза' : votingLastSpeechTimerTimeLeft === 0 ? 'Время вышло' : 'Готов' }}
                                    </div>
                                    <div class="voting-timer-display voting-timer-display--compact" :class="{
                                        'running': votingLastSpeechTimerRunning && !votingLastSpeechTimerPaused && votingLastSpeechTimerTimeLeft > 0,
                                        'warning': votingLastSpeechTimerTimeLeft <= 10 && votingLastSpeechTimerTimeLeft > 0 && votingLastSpeechTimerRunning && !votingLastSpeechTimerPaused,
                                        'paused': votingLastSpeechTimerPaused,
                                        'finished': votingLastSpeechTimerTimeLeft === 0
                                    }"
                                        @mousedown.prevent.stop="lastSpeechHoldStart()"
                                        @mouseup.prevent.stop="lastSpeechHoldEnd($event)"
                                        @mouseleave.stop="lastSpeechHoldCancel()"
                                        @touchstart.prevent.stop="lastSpeechHoldStart()"
                                        @touchend.prevent.stop="lastSpeechHoldEnd($event)"
                                        @touchcancel.prevent.stop="lastSpeechHoldCancel()">
                                        {{ formatVotingTimerTime(votingLastSpeechTimerTimeLeft) }}
                                    </div>
                                    <div class="timer-controls">
                                        <button class="timer-btn timer-add" @click.stop="addVotingLastSpeechTimerTime(30); window.haptic.impact('light');">
                                            +30 сек
                                        </button>
                                    </div>
                                    <div class="timer-hint">Клик: Старт/Пауза | Удержание: Сброс</div>
                                    <div v-if="votingWinners.length > 1" class="voting-timer-nav">
                                        <button class="glass-btn" :disabled="votingLastSpeechPlayerIndex <= 0" @click.stop="prevVotingLastSpeechPlayer(); window.haptic.impact('light');">
                                            ◀ Пред.
                                        </button>
                                        <span class="voting-timer-player-indicator">
                                            {{ votingLastSpeechPlayerIndex + 1 }} / {{ votingWinners.length }}
                                        </span>
                                        <button class="glass-btn" :disabled="votingLastSpeechPlayerIndex >= votingWinners.length - 1" @click.stop="nextVotingLastSpeechPlayer(); window.haptic.impact('light');">
                                            След. ▶
                                        </button>
                                    </div>
                                </div>
                                <!-- Кнопка перейти в ночь -->
                                <button class="glass-btn voting-action-btn voting-action-btn--primary" @click="finishVotingAndGoToNight(); window.haptic.notification('success');">
                                    <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i> Перейти в ночь
                                </button>
                            </template>

                            <!-- Никого не заголосовали (lift не прошел) — Начать ночь -->
                            <template v-else>
                                <div class="voting-finish-title">Никого не заголосовали</div>
                                <button class="glass-btn voting-action-btn voting-action-btn--primary" @click="finishVotingNoWinnersAndGoToNight(); window.haptic.notification('warning');">
                                    <i class="mdi mdi-moon-waning-crescent" style="margin-right:8px;"></i> Начать ночь
                                </button>
                            </template>
                        </div>
                    </template>

                </div>
            </div>

            <!-- ===== ВКЛАДКА: ИСТОРИЯ ===== -->
            <div v-if="votingScreenTab === 'history'" class="voting-screen-content voting-history-screen">
                <div v-if="votingHistory && votingHistory.length" class="voting-history-container">
                    <!-- Фильтр по дням -->
                    <div class="vh-day-tabs">
                        <button :class="['vh-day-tab', { active: votingHistoryDayFilter === 0 }]"
                                @click="votingHistoryDayFilter = 0; window.haptic.selection();">
                            Все
                        </button>
                        <button v-for="day in getVotingHistoryDays()" :key="'day_' + day"
                                :class="['vh-day-tab', { active: votingHistoryDayFilter === day }]"
                                @click="votingHistoryDayFilter = day; window.haptic.selection();">
                            День {{ day }}
                        </button>
                    </div>

                    <!-- Список голосований -->
                    <div class="vh-list">
                        <div v-for="(voting, vIdx) in getFilteredVotingHistory()" :key="'vh_' + vIdx" class="vh-card">
                            <!-- Шапка карточки -->
                            <div class="vh-card-header">
                                <span class="vh-card-day">День {{ voting.dayNumber }}</span>
                                <span :class="['vh-card-result-badge', (voting.finalWinners && voting.finalWinners.length) ? 'badge-voted' : 'badge-none']">
                                    <template v-if="voting.finalWinners && voting.finalWinners.length">
                                        Заголосованы: {{ voting.finalWinners.join(', ') }}
                                    </template>
                                    <template v-else>Никого не заголосовали</template>
                                </span>
                            </div>

                            <!-- Кандидаты -->
                            <div v-if="voting.nominees && voting.nominees.length" class="vh-nominees">
                                Кандидаты: <b>{{ voting.nominees.join(', ') }}</b>
                            </div>

                            <!-- Этапы -->
                            <div v-for="(stage, sIdx) in voting.stages" :key="'st_' + sIdx" class="vh-stage">
                                <div class="vh-stage-name">
                                    <span v-if="stage.type === 'main'">Голосование</span>
                                    <span v-else-if="stage.type === 'tie'">Повторное</span>
                                    <span v-else-if="stage.type === 'lift'">Подъем</span>
                                </div>

                                <!-- main / tie результаты -->
                                <template v-if="stage.type !== 'lift'">
                                    <div v-for="candidate in stage.order" :key="'gc-'+candidate" class="vh-candidate-row">
                                        <span class="vh-cand-num" :class="{ 'vh-cand-winner': stage.winners && stage.winners.includes(Number(candidate)) }">{{ candidate }}</span>
                                        <span class="vh-cand-votes">{{ stage.results[candidate] ? stage.results[candidate].length : 0 }}</span>
                                        <span v-if="!cityMode" class="vh-cand-voters">{{ stage.results[candidate] && stage.results[candidate].length ? stage.results[candidate].join(', ') : '—' }}</span>
                                    </div>
                                </template>

                                <!-- lift результаты -->
                                <template v-else>
                                    <div class="vh-lift-row">
                                        <span class="vh-lift-label">За подъем:</span>
                                        <span class="vh-lift-count">{{ stage.liftResults ? stage.liftResults.length : 0 }}</span>
                                        <span v-if="!cityMode" class="vh-lift-voters">{{ stage.liftResults && stage.liftResults.length ? stage.liftResults.join(', ') : '—' }}</span>
                                    </div>
                                    <div class="vh-lift-result" :class="stage.winners && stage.winners.length ? 'lift-pass' : 'lift-fail'">
                                        {{ stage.winners && stage.winners.length ? '✓ Заголосованы' : '✗ Остаются в игре' }}
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="voting-empty-state">
                    <div class="voting-empty-icon">📋</div>
                    <div class="voting-empty-title">История пуста</div>
                    <div class="voting-empty-text">Проведите голосование, и оно появится здесь</div>
                </div>
            </div>

            <!-- ===== НИЖНИЙ НАВИГАЦИОННЫЙ БАР ГОЛОСОВАНИЯ ===== -->
            <div class="main-nav-bar">
                <button class="nav-item" :class="{ active: votingScreenTab === 'voting' }"
                        @click="votingScreenTab = 'voting'; window.haptic.selection();">
                    <i class="fa fa-gavel"></i>
                    <span>Голосование</span>
                </button>
                <button class="nav-item" :class="{ active: votingScreenTab === 'history' }"
                        @click="votingScreenTab = 'history'; activeVotingTab = Math.max(0, votingHistory.length - 1); window.haptic.selection();">
                    <i class="fa fa-history"></i>
                    <span>История</span>
                </button>
                <button class="nav-item" @click="closeVotingScreen(); window.haptic.impact('light');" :disabled="showVotingModal">
                    <i class="fa fa-times"></i>
                    <span>Закрыть</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Новая навигация главного меню -->
    <div v-if="showMainMenu" id="main-nav-bar" class="main-nav-bar">
        <button class="nav-item" :class="{ active: activeHistoryTab === 'active' && !showProfileScreen && !showThemesScreen }" @click="showProfileScreen = false; showThemesScreen = false; activeHistoryTab = 'active'; window.haptic.selection();">
            <i class="mdi mdi-play-circle-outline"></i>
            <span>Активные</span>
        </button>
        <button class="nav-item" :class="{ active: activeHistoryTab === 'history' && !showProfileScreen && !showThemesScreen }" @click="showProfileScreen = false; showThemesScreen = false; activeHistoryTab = 'history'; window.haptic.selection();">
            <i class="mdi mdi-history"></i>
            <span>История</span>
        </button>
        <button class="nav-item nav-item--primary" @click="startNewGame(); window.haptic.impact('medium');">
            <i class="mdi mdi-plus"></i>
            <span>Новая</span>
        </button>
        <button class="nav-item" :class="{ active: showThemesScreen }" @click="showProfileScreen = false; showThemesScreen = true; window.haptic.impact('light');">
            <i class="mdi mdi-palette-outline"></i>
            <span>Темы</span>
        </button>
        <button class="nav-item" :class="{ active: showProfileScreen }" @click="showThemesScreen = false; showProfileScreen = true; window.haptic.impact('light');">
            <i class="mdi mdi-account-outline"></i>
            <span>Профиль</span>
        </button>
    </div>

    <!-- Фиксированная нижняя панель режимов (для игры) -->
    <!-- Экран раздачи ролей (показывается после выбора стола, до подтверждения раздачи) -->
    <div v-if="tableOut?.length && !winnerTeam && !rolesDistributed && !showMainMenu && !showModal && !showGameTableModal" class="roles-distribution-overlay">
        <div class="roles-distribution-safe-top"></div>
        <div class="roles-distribution-header">
            <i class="mdi mdi-cards-playing-outline" style="font-size: 1.4em; margin-right: 8px; color: var(--maf-accent-color, #a855f7);"></i>
            Раздача ролей
        </div>
        <div class="roles-distribution-hint">Назначьте роли игрокам. Все без назначения — мирные.</div>

        <!-- Лейблы ролей -->
        <div class="roles-distribution-summary">
            <span class="roles-summary-tag" :class="{ valid: validateRolesDistribution().donCount === 1 }">
                Дон
            </span>
            <span class="roles-summary-tag" :class="{ valid: validateRolesDistribution().blackCount === 2, half: validateRolesDistribution().blackCount === 1 }">
                Мафия
            </span>
            <span class="roles-summary-tag" :class="{ valid: validateRolesDistribution().sheriffCount === 1 }">
                Шериф
            </span>
        </div>

        <div class="roles-distribution-list">
            <div v-for="(playerData, index) in tableOut"
                 :key="'rd-'+playerData.roleKey"
                 class="roles-distribution-row">
                <b class="flex-fixed player-num">{{index + 1}}</b>
                <div class="avatar-uploader flex-fixed">
                    <div class="avatar" :style="{backgroundImage: playerData.avatarCss}"></div>
                </div>
                <div class="text-ellipsis player-name" style="flex:1;">{{playerData.login}}</div>
                <div class="role-badges-right">
                    <button class="role-button" :class="{ active: playerData.role === 'don' }" @click.stop="roleSet(playerData.roleKey, 'don'); window.haptic.impact('light');" title="Дон">Д</button>
                    <button class="role-button" :class="{ active: playerData.role === 'black' }" @click.stop="roleSet(playerData.roleKey, 'black'); window.haptic.impact('light');" title="Мафия">М</button>
                    <button class="role-button" :class="{ active: playerData.role === 'sheriff' }" @click.stop="roleSet(playerData.roleKey, 'sheriff'); window.haptic.impact('light');" title="Шериф">Ш</button>
                </div>
            </div>
        </div>

        <!-- Ошибка валидации -->
        <div v-if="rolesValidationError" class="roles-validation-error">
            <i class="fa fa-exclamation-triangle" style="margin-right: 6px;"></i>
            Проверьте роли
        </div>

        <!-- Слайдер сохранения раздачи -->
        <div class="roles-save-bar">
            <div :class="['slide-confirm', { 'slide-confirm--disabled': !validateRolesDistribution().valid }]"
                 :ref="'slider_roles'">
                <div class="slide-confirm__progress"></div>
                <div class="slide-confirm__text">Сохранить раздачу</div>
                <div class="slide-confirm__thumb">
                    <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                </div>
            </div>
        </div>
        <div class="roles-distribution-safe-bottom"></div>
    </div>

    <!-- ============ DISCUSSION / FREE SEATING PHASE (split timer + slider) ============ -->
    <div v-if="rolesDistributed && (gamePhase==='discussion' || gamePhase==='freeSeating') && !winnerTeam" id="bottom-bar" class="phase-split-bar">
        <!-- Timer pill -->
        <div class="phase-timer-pill">
            <div class="timer-section phase-timer-section">
                <div class="timer-display" :class="{
                    warning: (gamePhase==='discussion' ? discussionTimeLeft : freeSeatingTimeLeft) <= 10 && (gamePhase==='discussion' ? discussionRunning : freeSeatingRunning)
                }">
                    {{ Math.floor((gamePhase==='discussion' ? discussionTimeLeft : freeSeatingTimeLeft) / 60).toString().padStart(2, '0') }}:{{ String((gamePhase==='discussion' ? discussionTimeLeft : freeSeatingTimeLeft) % 60).padStart(2, '0') }}
                </div>
                <div class="timer-controls">
                    <button class="timer-btn timer-start"
                        v-if="gamePhase==='discussion'"
                        :disabled="discussionRunning"
                        @click.stop="startDiscussionTimer(); window.haptic.impact('light');">
                        Старт
                    </button>
                    <button class="timer-btn timer-start"
                        v-if="gamePhase==='freeSeating'"
                        :disabled="freeSeatingRunning"
                        @click.stop="startFreeSeatingTimer(); window.haptic.impact('light');">
                        Старт
                    </button>
                    <button class="timer-btn timer-add"
                        v-if="gamePhase==='discussion'"
                        :disabled="!discussionRunning"
                        @click.stop="stopDiscussionTimer(); window.haptic.impact('light');">
                        Пауза
                    </button>
                    <button class="timer-btn timer-add"
                        v-if="gamePhase==='freeSeating'"
                        :disabled="!freeSeatingRunning"
                        @click.stop="stopFreeSeatingTimer(); window.haptic.impact('light');">
                        Пауза
                    </button>
                </div>
            </div>
        </div>
        <!-- Slider pill -->
        <div class="phase-slider-pill">
            <!-- Discussion slider -->
            <div v-if="gamePhase==='discussion'"
                 key="slider-discussion"
                 class="slide-confirm slide-confirm--compact slide-confirm--warning"
                 ref="slider_skip_discussion">
                <div class="slide-confirm__progress"></div>
                <div class="slide-confirm__text">{{ discussionTimeLeft <= 0 ? (cityMode ? 'Завершить знакомство' : 'Завершить договорку') : (cityMode ? 'Пропустить знакомство' : 'Пропустить договорку') }}</div>
                <div class="slide-confirm__thumb">
                    <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                </div>
            </div>
            <!-- Free seating slider -->
            <div v-if="gamePhase==='freeSeating'"
                 key="slider-freeseating"
                 class="slide-confirm slide-confirm--compact slide-confirm--warning"
                 ref="slider_skip_freeseating">
                <div class="slide-confirm__progress"></div>
                <div class="slide-confirm__text">{{ freeSeatingTimeLeft <= 0 ? 'Утро' : 'Пропустить свободную посадку' }}</div>
                <div class="slide-confirm__thumb">
                    <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ DAY / NIGHT NAVIGATION (SLIDER) ============ -->
    <div v-if="tableOut?.length && !winnerTeam && rolesDistributed && (gamePhase==='day' || gamePhase==='night') && !showVotingScreen" id="bottom-bar" class="phase-split-bar">
        <div class="phase-slider-pill">
            <!-- Day mode → slide to go to night -->
            <div v-if="currentMode==='day'"
                 key="slider-go-night"
                 class="slide-confirm slide-confirm--compact slide-confirm--night"
                 ref="slider_go_night">
                <div class="slide-confirm__progress"></div>
                <div class="slide-confirm__text">Перейти в ночь {{ (nightNumber || 0) + 1 }}</div>
                <div class="slide-confirm__thumb">
                    <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                </div>
            </div>
            <!-- Night mode → slide to go to day (morning) -->
            <div v-if="currentMode==='night'"
                 key="slider-go-day"
                 class="slide-confirm slide-confirm--compact slide-confirm--morning"
                 :class="{ 'slide-confirm--inactive': !nightSequenceComplete, 'slider-pulse-glow': dayButtonBlink && nightSequenceComplete }"
                 ref="slider_go_day"
                 :data-disabled="!nightSequenceComplete ? '1' : ''">
                <div class="slide-confirm__progress"></div>
                <div class="slide-confirm__text">В городе утро</div>
                <div class="slide-confirm__thumb">
                    <svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z"/></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ ALERT: No voting this day ============ -->
    <transition name="fade">
        <div v-if="showNoVotingAlert" class="no-voting-alert-overlay" @click.self="showNoVotingAlert = false">
            <div class="no-voting-alert-card">
                <div class="no-voting-alert-icon"><i class="mdi mdi-alert-circle-outline"></i></div>
                <div class="no-voting-alert-text">В этом дне не было голосования. Вы уверены что хотите начать ночь?</div>
                <div class="no-voting-alert-buttons">
                    <button class="no-voting-alert-btn no-voting-alert-btn--no" @click="showNoVotingAlert = false; window.haptic && window.haptic.impact('light');">Нет</button>
                    <button class="no-voting-alert-btn no-voting-alert-btn--yes" @click="confirmGoToNight(); window.haptic && window.haptic.notification('success');">Да</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- ============ ALERT: Go to night after all speeches ============ -->
    <transition name="fade">
        <div v-if="showGoToNightPrompt" class="no-voting-alert-overlay" @click.self="cancelGoToNightPrompt()">
            <div class="no-voting-alert-card">
                <div class="no-voting-alert-icon"><i class="mdi mdi-moon-waning-crescent"></i></div>
                <div class="no-voting-alert-text">Все игроки высказались. Перейти в ночь?</div>
                <div class="no-voting-alert-buttons">
                    <button class="no-voting-alert-btn no-voting-alert-btn--no" @click="cancelGoToNightPrompt(); window.haptic && window.haptic.impact('light');">Нет</button>
                    <button class="no-voting-alert-btn no-voting-alert-btn--yes" @click="confirmGoToNightPrompt(); window.haptic && window.haptic.notification('success');">Да</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- ============ Итоги турнира / серии игр ============ -->
    <div v-if="showFunkySummary" class="funky-summary-overlay" style="display:flex; flex-direction:column; height:100vh; height:var(--tg-viewport-height, 100vh);">
        <div class="funky-summary-safe-top"></div>

        <!-- ===== Контент вкладок (скроллируемая область) ===== -->
        <div style="flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:100px;">
            <div class="funky-summary-header">
                <i class="mdi mdi-chart-bar" style="font-size: 1.3em; margin-right: 8px; color: var(--maf-accent-color, #a855f7);"></i>
                Итоги
            </div>
            <div class="funky-summary-subtitle">{{ funkySummaryTournamentName }}</div>
            <div v-if="funkySummaryGames && funkySummaryGames.length" style="text-align:center; font-size:0.8em; color:rgba(255,255,255,0.35); margin-top:-4px; padding-bottom:8px;">
                {{ funkySummaryGames.length }} {{ funkySummaryGames.length === 1 ? 'игра' : (funkySummaryGames.length < 5 ? 'игры' : 'игр') }} · {{ funkySummaryData ? funkySummaryData.length : 0 }} {{ (funkySummaryData && funkySummaryData.length === 1) ? 'игрок' : ((funkySummaryData && funkySummaryData.length < 5) ? 'игрока' : 'игроков') }}
            </div>

            <!-- ===== ВКЛАДКА: ОБЩАЯ ===== -->
            <div v-if="funkySummaryTab === 'overall'">
                <div class="funky-summary-list">
                    <div v-for="(player, rank) in funkySummaryData" :key="'fs-'+player.login"
                         class="score-card"
                         :class="{ 'highlighted': funkySummaryExpanded === player.login, 'top-gold': rank === 0, 'top-silver': rank === 1, 'top-bronze': rank === 2 }"
                         @click="funkySummaryExpanded = (funkySummaryExpanded === player.login ? null : player.login); window.haptic.selection();">

                        <div class="player-row-content">
                            <b class="flex-fixed player-num" :style="rank < 3 ? {color: ['#ffd700','#c0c0c0','#cd7f32'][rank]} : {}">{{ rank + 1 }}</b>
                            <div class="avatar-uploader flex-fixed">
                                <div class="avatar" :style="player.avatar_link ? {backgroundImage: 'url(' + player.avatar_link + ')'} : {}"></div>
                            </div>
                            <div class="text-ellipsis player-name">{{ player.login }}</div>
                            <div class="role-badges-right">
                                <span class="funky-summary-games-badge">{{ player.games }} {{ player.games === 1 ? 'игра' : (player.games < 5 ? 'игры' : 'игр') }}</span>
                                <b style="font-size: 1.25em; margin-left: 8px; min-width: 36px; text-align: right; font-family: 'SF Mono','Cascadia Code','Roboto Mono',monospace; font-weight:900; letter-spacing:-0.5px;">{{ player.totalScore }}</b>
                            </div>
                        </div>

                        <transition name="slide-fade">
                            <div v-if="funkySummaryExpanded === player.login" class="score-content" @click.stop>
                                <div>
                                    <!-- HERO BLOCK -->
                                    <div class="dash-hero">
                                        <div class="dash-hero-main">
                                            <div class="dash-hero-label">
                                                <svg class="dash-icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                                Итого баллов
                                            </div>
                                            <div class="dash-hero-value">{{ player.totalScore }}</div>
                                        </div>
                                        <div style="display:flex; flex-direction:column; flex:1; gap:8px;">
                                            <div class="dash-hero-side">
                                                <div class="dash-hero-side-label">
                                                    <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                                    Игры
                                                </div>
                                                <div class="dash-hero-side-value">{{ player.games }}</div>
                                            </div>
                                            <div class="dash-hero-side">
                                                <div class="dash-hero-side-label">
                                                    <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#30d158" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                                                    Победы
                                                </div>
                                                <div class="dash-hero-side-value" style="color:#30d158;">{{ player.wins }}</div>
                                                <div class="dash-winrate-label">{{ player.games > 0 ? Math.round(player.wins / player.games * 100) : 0 }}%</div>
                                                <div class="dash-progress" style="margin-top:2px;">
                                                    <div class="dash-progress-fill green" :style="{width: (player.games > 0 ? Math.round(player.wins / player.games * 100) : 0) + '%'}"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- MISC STATS ROW -->
                                    <div class="dash-misc-row">
                                        <div class="dash-misc-cell">
                                            <div class="dash-misc-label">
                                                <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                <span style="color:#4caf50;">Доп баллы</span>
                                            </div>
                                            <div class="dash-misc-value">{{ player.bonusTotal }}</div>
                                        </div>
                                        <div class="dash-misc-cell">
                                            <div class="dash-misc-label">
                                                <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#f44336" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                <span style="color:#f44336;">Штрафы</span>
                                            </div>
                                            <div class="dash-misc-value">{{ player.penaltyTotal }}</div>
                                        </div>
                                        <div class="dash-misc-cell">
                                            <div class="dash-misc-label">
                                                <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                                                ПУ
                                            </div>
                                            <div class="dash-misc-value">{{ player.firstKilled }}</div>
                                        </div>
                                        <div class="dash-misc-cell">
                                            <div class="dash-misc-label">
                                                <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12c0-3 2.5-6 2.5-6s2.5 3 2.5 6a2.5 2.5 0 0 1-5 0Z"/><path d="M9.5 17c0-2.5 2.5-5 2.5-5s2.5 2.5 2.5 5a2.5 2.5 0 0 1-5 0Z"/><circle cx="12" cy="2" r="1"/></svg>
                                                Убит ночью
                                            </div>
                                            <div class="dash-misc-value">{{ player.killed }}<span v-if="player.selfKills" style="color:#ff453a; font-size:0.6em;"> ({{ player.selfKills }})</span></div>
                                        </div>
                                    </div>

                                    <!-- ROLE GROUPS -->
                                    <div class="dash-roles">
                                        <!-- Мирный блок -->
                                        <div class="dash-role-group peace-group">
                                            <div class="dash-group-title">
                                                <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                                Мирные
                                            </div>
                                            <div class="dash-role-card" :class="{inactive: player.peacePlayed === 0}">
                                                <div class="dash-role-name" style="color:#ef9a9a;">
                                                    <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#ef9a9a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                                    Мирный
                                                </div>
                                                <div class="dash-role-stats">
                                                    <span class="dash-role-played">{{ player.peacePlayed }}</span>
                                                    <span class="dash-role-wins">/ {{ player.peaceWins }} побед</span>
                                                </div>
                                                <div class="dash-progress">
                                                    <div class="dash-progress-fill red" :style="{width: (player.peacePlayed > 0 ? Math.round(player.peaceWins / player.peacePlayed * 100) : 0) + '%'}"></div>
                                                </div>
                                            </div>
                                            <div class="dash-role-card" :class="{inactive: player.sheriffPlayed === 0}">
                                                <div class="dash-role-name" style="color:#ffd54f;">
                                                    <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#ffd54f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                                    Шериф
                                                </div>
                                                <div class="dash-role-stats">
                                                    <span class="dash-role-played">{{ player.sheriffPlayed }}</span>
                                                    <span class="dash-role-wins">/ {{ player.sheriffWins }} побед</span>
                                                </div>
                                                <div class="dash-progress">
                                                    <div class="dash-progress-fill gold" :style="{width: (player.sheriffPlayed > 0 ? Math.round(player.sheriffWins / player.sheriffPlayed * 100) : 0) + '%'}"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Мафия блок -->
                                        <div class="dash-role-group mafia-group">
                                            <div class="dash-group-title">
                                                <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                                                Мафия
                                            </div>
                                            <div class="dash-role-card" :class="{inactive: player.mafiaPlayed === 0}">
                                                <div class="dash-role-name" style="color:#ef9a9a;">
                                                    <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#ef9a9a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                                    Мафия
                                                </div>
                                                <div class="dash-role-stats">
                                                    <span class="dash-role-played">{{ player.mafiaPlayed }}</span>
                                                    <span class="dash-role-wins">/ {{ player.mafiaWins }} побед</span>
                                                </div>
                                                <div class="dash-progress">
                                                    <div class="dash-progress-fill purple" :style="{width: (player.mafiaPlayed > 0 ? Math.round(player.mafiaWins / player.mafiaPlayed * 100) : 0) + '%'}"></div>
                                                </div>
                                            </div>
                                            <div class="dash-role-card" :class="{inactive: player.donPlayed === 0}">
                                                <div class="dash-role-name" style="color:#e1bee7;">
                                                    <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="#e1bee7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
                                                    Дон
                                                </div>
                                                <div class="dash-role-stats">
                                                    <span class="dash-role-played">{{ player.donPlayed }}</span>
                                                    <span class="dash-role-wins">/ {{ player.donWins }} побед</span>
                                                </div>
                                                <div class="dash-progress">
                                                    <div class="dash-progress-fill purple" :style="{width: (player.donPlayed > 0 ? Math.round(player.donWins / player.donPlayed * 100) : 0) + '%'}"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- DISCIPLINE BAR -->
                                    <div class="dash-discipline">
                                        <div class="dash-disc-item">
                                            <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                            Фолы <span class="disc-val">{{ player.foulsTotal }}</span>
                                        </div>
                                        <div class="dash-disc-dot"></div>
                                        <div class="dash-disc-item">
                                            <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                            Тех <span class="disc-val">{{ player.techFoulsTotal }}</span>
                                        </div>
                                        <div class="dash-disc-dot"></div>
                                        <div class="dash-disc-item">
                                            <svg class="dash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                                            Удал <span class="disc-val">{{ player.removals }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </div>
                </div>

                <div style="padding: 16px 20px 20px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <button class="glass-btn funky-shuffle-btn" style="width: 100%; max-width: 400px;"
                            :disabled="funkySummarySharing"
                            @click="funkyShareSummary(); window.haptic.impact('medium');">
                        <template v-if="funkySummarySharing">
                            <i class="mdi mdi-loading mdi-spin" style="margin-right: 6px;"></i>
                            <span>Сохранение...</span>
                        </template>
                        <template v-else-if="funkySummaryShareUrl">
                            <i class="mdi mdi-share-variant-outline" style="margin-right: 6px;"></i>
                            <span>Поделиться ещё раз</span>
                        </template>
                        <template v-else>
                            <i class="mdi mdi-share-variant-outline" style="margin-right: 6px;"></i>
                            <span>Поделиться</span>
                        </template>
                    </button>
                </div>
            </div>

            <!-- ===== ВКЛАДКА: ПО ИГРАМ ===== -->
            <div v-if="funkySummaryTab === 'games'">
                <div style="padding: 0 12px; max-width: 600px; margin: 0 auto; box-sizing: border-box;">
                    <div v-for="game in funkySummaryGames" :key="'sg-'+game.gameNumber" class="score-card" :style="game.winnerTeam === 'civilians' ? {boxShadow: 'inset 0 0 0 1px rgba(255,82,82,0.25), 0 0 16px rgba(255,82,82,0.08)'} : (game.winnerTeam === 'mafia' ? {boxShadow: 'inset 0 0 0 1px rgba(79,195,247,0.25), 0 0 16px rgba(79,195,247,0.08)'} : {})" style="margin-bottom: 12px;">
                        <!-- Заголовок игры -->
                        <div class="player-row-content" style="cursor:pointer;" @click="funkySummaryGameExpanded = (funkySummaryGameExpanded === game.gameNumber ? null : game.gameNumber); funkySummaryPlayerExpanded = null; window.haptic.selection();">
                            <div style="display:flex; align-items:center; flex:1; gap:10px;">
                                <div style="width:36px; height:36px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:1.1em; flex-shrink:0; font-family:'SF Mono','Cascadia Code','Roboto Mono',monospace; backdrop-filter:blur(8px);"
                                     :style="{background: game.winnerTeam === 'civilians' ? 'rgba(255,82,82,0.15)' : (game.winnerTeam === 'mafia' ? 'rgba(79,195,247,0.15)' : 'rgba(255,255,255,0.08)'), color: game.winnerTeam === 'civilians' ? '#ff5252' : (game.winnerTeam === 'mafia' ? '#4fc3f7' : '#fff')}">
                                    {{ game.gameNumber }}
                                </div>
                                <div>
                                    <div style="font-weight:700; font-size:0.95em;">Игра {{ game.gameNumber }}</div>
                                    <div style="font-size:0.8em; color:rgba(255,255,255,0.5);">
                                        Победа: <span :style="{color: game.winnerTeam === 'civilians' ? '#ff5252' : (game.winnerTeam === 'mafia' ? '#4fc3f7' : '#fff')}">
                                            {{ game.winnerTeam === 'civilians' ? 'Мирных' : (game.winnerTeam === 'mafia' ? 'Мафии' : 'Ничья') }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <i class="mdi" :class="funkySummaryGameExpanded === game.gameNumber ? 'mdi-chevron-up' : 'mdi-chevron-down'" style="font-size:1.4em; color:rgba(255,255,255,0.4);"></i>
                        </div>

                        <!-- Содержимое раскрытой игры -->
                        <transition name="slide-fade">
                            <div v-if="funkySummaryGameExpanded === game.gameNumber" style="padding:0;">
                                <!-- Лучший ход -->
                                <div v-if="game.bestMove && game.bestMove.length" style="padding:8px 16px; background:rgba(255,255,255,0.03); border-top:1px solid rgba(255,255,255,0.06); font-size:0.85em; color:rgba(255,255,255,0.6); backdrop-filter:blur(8px);">
                                    <svg style="width:12px;height:12px;margin-right:4px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="#ffd54f" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                                    Лучший ход: <b style="color:#fff; font-family:'SF Mono','Roboto Mono',monospace;">{{ game.bestMove.join(', ') }}</b>
                                </div>

                                <!-- Список игроков -->
                                <div v-for="p in game.players" :key="'sgp-'+p.roleKey" style="border-top:1px solid rgba(255,255,255,0.06);">
                                    <div class="player-row-content" style="cursor:pointer;" @click.stop="funkySummaryPlayerExpanded = (funkySummaryPlayerExpanded === p.roleKey ? null : p.roleKey); window.haptic.selection();">
                                        <b class="flex-fixed player-num" style="min-width:24px;">{{ p.num }}</b>
                                        <div class="avatar-uploader flex-fixed">
                                            <div class="avatar" :style="p.avatar_link ? {backgroundImage: 'url(' + p.avatar_link + ')'} : {}"></div>
                                        </div>
                                        <div class="text-ellipsis player-name" :style="p.action === 'killed' || p.action === 'voted' || p.action === 'removed' || p.action === 'tech_fall_removed' || p.action === 'fall_removed' ? {opacity:0.5, textDecoration:'line-through'} : {}">{{ p.login }}</div>
                                        <div class="role-badges-right">
                                            <span class="role-tag" :class="getSummaryRoleClass(p.role)">{{ getRoleLabel(p.role) }}</span>
                                            <b style="font-size: 1.1em; margin-left: 8px; min-width: 30px; text-align: right; font-family:'SF Mono','Roboto Mono',monospace; font-weight:900;">{{ p.totalScore }}</b>
                                        </div>
                                    </div>

                                    <!-- Раскрытая карточка игрока -->
                                    <transition name="slide-fade">
                                        <div v-if="funkySummaryPlayerExpanded === p.roleKey" class="score-content" @click.stop>
                                            <div class="score-dashboard-grid">
                                                <!-- Протокол -->
                                                <div class="dashboard-cell">
                                                    <div class="cell-label">Протокол</div>
                                                    <div class="info-list">
                                                        <template v-if="p.protocolResults">
                                                            <div v-for="(res, idx) in p.protocolResults" :key="'prt'+idx" class="info-item">
                                                                <span>#{{ idx }}</span>
                                                                <div class="flex align-center">
                                                                    <span :class="'text-' + res.role" style="margin-right:4px;">{{ getRoleLabel(res.role) }}</span>
                                                                    <i :class="res.correct ? 'fa fa-check check-icon' : 'fa fa-times cross-icon'"></i>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <div v-else class="empty-data">Пусто</div>
                                                    </div>
                                                </div>
                                                <!-- Мнение -->
                                                <div class="dashboard-cell">
                                                    <div class="cell-label">Мнение</div>
                                                    <div class="info-list">
                                                        <template v-if="p.opinionResults">
                                                            <div v-for="(res, idx) in p.opinionResults" :key="'opn'+idx" class="info-item">
                                                                <span>#{{ idx }}</span>
                                                                <div class="flex align-center">
                                                                    <span :class="'text-' + res.role" style="margin-right:4px;">{{ getRoleLabel(res.role) }}</span>
                                                                    <i :class="res.correct ? 'fa fa-check check-icon' : 'fa fa-times cross-icon'"></i>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <div v-else class="empty-data">Пусто</div>
                                                    </div>
                                                </div>
                                                <!-- Текст мнения -->
                                                <div v-if="p.opinionText" class="dashboard-cell full-width">
                                                    <div class="cell-label">Текст мнения</div>
                                                    <div class="info-text-mini">"{{ p.opinionText }}"</div>
                                                </div>
                                                <!-- Ночные проверки -->
                                                <div v-if="p.nightChecks && p.nightChecks.length" class="dashboard-cell full-width">
                                                    <div class="cell-label"><svg style="width:12px;height:12px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>{{ p.role === 'don' ? 'Проверки Дона' : 'Проверки Шерифа' }}</div>
                                                    <div class="info-list">
                                                        <div v-for="(check, ci) in p.nightChecks" :key="'nch2'+ci" class="info-item">
                                                            <span style="color: rgba(255,255,255,0.45);">Ночь {{ check.night }}</span>
                                                            <div class="flex align-center">
                                                                <span style="margin-right:6px;">→ №{{ check.target }}</span>
                                                                <span :style="{ color: check.found ? '#30d158' : '#ff453a', fontWeight: 700 }">{{ check.result }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Glowing Total block -->
                                                <div class="dashboard-cell full-width" style="background: linear-gradient(135deg, rgba(var(--maf-accent-color-rgb, 168,85,247),0.12) 0%, rgba(var(--maf-accent-color-rgb, 168,85,247),0.04) 100%); border-color: rgba(var(--maf-accent-color-rgb, 168,85,247),0.30); box-shadow: 0 0 24px rgba(var(--maf-accent-color-rgb, 168,85,247),0.15), inset 0 1px 0 rgba(255,255,255,0.08);">
                                                    <div class="cell-label" style="color: var(--maf-accent-color);">Итого</div>
                                                    <div class="total-content">
                                                        <span class="total-value">{{ p.totalScore }}</span>
                                                        <div v-if="p.won" class="win-badge">+1 Победа</div>
                                                    </div>
                                                </div>
                                                <!-- Symmetric Доп / Штраф -->
                                                <div class="dashboard-cell">
                                                    <div class="cell-label" style="color:#4caf50;">
                                                        <svg style="width:12px;height:12px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                        Доп
                                                    </div>
                                                    <div class="funky-stat-value">{{ p.bonus }}</div>
                                                </div>
                                                <div class="dashboard-cell">
                                                    <div class="cell-label" style="color:#f44336;">
                                                        <svg style="width:12px;height:12px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="#f44336" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                        Штраф
                                                    </div>
                                                    <div class="funky-stat-value">{{ p.penalty }}</div>
                                                </div>
                                                <!-- Compact Status bar -->
                                                <div class="dashboard-cell full-width" style="min-height:auto; padding:8px 10px;">
                                                    <div style="font-size:0.8em; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                                                        <span>Вскрытие: <b :style="{color: p.reveal ? '#30d158' : 'rgba(255,255,255,0.35)'}">{{ p.reveal ? 'Да' : 'Нет' }}</b></span>
                                                        <span v-if="p.isSelfKill" style="color:#ff453a; font-weight:700; text-shadow: 0 0 8px rgba(255,69,58,0.4);"><i class="mdi mdi-skull"></i> САМОСТРЕЛ</span>
                                                        <span v-if="p.isFirstKilled" style="color:#ffd700;">
                                                            <svg style="width:12px;height:12px;margin-right:2px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                                                            ПУ
                                                        </span>
                                                        <span style="color:rgba(255,255,255,0.35); font-family:'SF Mono','Roboto Mono',monospace;">Ф:{{ p.foul }} · ТФ:{{ p.techFoul }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </transition>
                                </div>

                                <!-- ===== Хронология ночей ===== -->
                                <div v-if="buildGameNightTimeline(game).length" style="border-top:1px solid rgba(255,255,255,0.08); padding:12px 16px; background:rgba(255,255,255,0.02);">
                                    <div style="font-weight:700; font-size:0.85em; margin-bottom:10px; color:rgba(255,255,255,0.5);">
                                        <svg style="width:14px;height:14px;margin-right:4px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                                        Хронология ночей
                                    </div>
                                    <div v-for="nightItem in buildGameNightTimeline(game)" :key="'nt-'+nightItem.night" style="margin-bottom:8px;">
                                        <div style="font-size:0.75em; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.3); margin-bottom:4px;">Ночь {{ nightItem.night }}</div>
                                        <div v-for="(evt, ei) in nightItem.events" :key="'ne-'+ei" class="info-item" style="margin-bottom:3px;">
                                            <span>{{ evt.icon }}</span>
                                            <span style="flex:1; margin-left:8px; font-size:0.85em;">{{ evt.text }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- ===== История голосования ===== -->
                                <div v-if="game.votingHistory && game.votingHistory.length" style="border-top:1px solid rgba(255,255,255,0.08); padding:12px 16px; background:rgba(255,255,255,0.02);">
                                    <div style="font-weight:700; font-size:0.85em; margin-bottom:10px; color:rgba(255,255,255,0.5);">
                                        <svg style="width:14px;height:14px;margin-right:4px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                        История голосования
                                    </div>
                                    <div v-for="(voting, vIdx) in game.votingHistory" :key="'gvh-'+vIdx" class="vh-card" style="margin-bottom:8px;">
                                        <div class="vh-card-header">
                                            <span class="vh-card-day">День {{ voting.dayNumber || vIdx + 1 }}</span>
                                            <span :class="['vh-card-result-badge', (voting.finalWinners && voting.finalWinners.length) ? 'badge-voted' : 'badge-none']">
                                                <template v-if="voting.finalWinners && voting.finalWinners.length">Заголосованы: {{ voting.finalWinners.join(', ') }}</template>
                                                <template v-else>Никого не заголосовали</template>
                                            </span>
                                        </div>
                                        <div v-if="voting.nominees && voting.nominees.length" class="vh-nominees">
                                            Кандидаты: <b>{{ voting.nominees.join(', ') }}</b>
                                        </div>
                                        <div v-for="(stage, sIdx) in voting.stages" :key="'gst-'+sIdx" class="vh-stage">
                                            <div class="vh-stage-name">
                                                <span v-if="stage.type === 'main'">Голосование</span>
                                                <span v-else-if="stage.type === 'tie'">Повторное</span>
                                                <span v-else-if="stage.type === 'lift'">Подъем</span>
                                            </div>
                                            <template v-if="stage.type !== 'lift'">
                                                <div v-for="candidate in stage.order" :key="'gc-'+candidate" class="vh-candidate-row">
                                                    <span class="vh-cand-num" :class="{ 'vh-cand-winner': stage.winners && stage.winners.includes(Number(candidate)) }">{{ candidate }}</span>
                                                    <span class="vh-cand-votes">{{ stage.results[candidate] ? stage.results[candidate].length : 0 }}</span>
                                                    <span class="vh-cand-voters">{{ stage.results[candidate] && stage.results[candidate].length ? stage.results[candidate].join(', ') : '—' }}</span>
                                                </div>
                                            </template>
                                            <template v-else>
                                                <div class="vh-lift-row">
                                                    <span class="vh-lift-label">За подъем:</span>
                                                    <span class="vh-lift-count">{{ stage.liftResults ? stage.liftResults.length : 0 }}</span>
                                                    <span class="vh-lift-voters">{{ stage.liftResults && stage.liftResults.length ? stage.liftResults.join(', ') : '—' }}</span>
                                                </div>
                                                <div class="vh-lift-result" :class="stage.winners && stage.winners.length ? 'lift-pass' : 'lift-fail'">
                                                    {{ stage.winners && stage.winners.length ? '✓ Заголосованы' : '✗ Остаются в игре' }}
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </div>

                    <!-- Пустое состояние -->
                    <div v-if="!funkySummaryGames || !funkySummaryGames.length" style="text-align:center; padding:40px 20px; color:rgba(255,255,255,0.3);">
                        <div style="margin-bottom:8px;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="8" cy="8" r="1.2"/><circle cx="16" cy="8" r="1.2"/><circle cx="8" cy="16" r="1.2"/><circle cx="16" cy="16" r="1.2"/><circle cx="12" cy="12" r="1.2"/></svg></div>
                        Нет завершённых игр
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Нижний навигационный бар итогов ===== -->
        <div class="main-nav-bar">
            <button class="nav-item" :class="{ active: funkySummaryTab === 'overall' }"
                    @click="funkySummaryTab = 'overall'; window.haptic.selection();">
                <i class="mdi mdi-podium"></i>
                <span>Общая</span>
            </button>
            <button class="nav-item" :class="{ active: funkySummaryTab === 'games' }"
                    @click="funkySummaryTab = 'games'; window.haptic.selection();">
                <i class="mdi mdi-format-list-numbered"></i>
                <span>По играм</span>
            </button>
            <button class="nav-item" @click="showFunkySummary = false; showMainMenu = true; funkySummaryShareUrl = ''; window.haptic.impact('light');">
                <i class="fa fa-times"></i>
                <span>Закрыть</span>
            </button>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
<script>
// Динамическая загрузка локальных JS с cache-busting
[
    './voting.js',
    './timer.js',
    './session-manager.js',
    './app-connector.js',
    './app-data.js',
    './app-sessions.js',
    './app-game-logic.js',
    './app-ui-integration.js',
    './app-core.js',
    './assets/panel-notification.js'
].forEach(function(src) {
    document.write('<script src="' + src + '?v=' + window.__v + '"><\/script>');
});
</script>
<script>
// Гарантируем, что editVotingHistory определён в основном Vue-инстансе
if (window.app && typeof window.app.editVotingHistory === 'undefined') {
    window.app.editVotingHistory = false;
}

if (window.app) {
  // Заглушки функций для совместимости (модальное окно отключено)
  window.app.showReturnPlayerModal = function(number, roleKey) {
    console.log('showReturnPlayerModal отключено');
    // Гарантируем, что модальное окно остается скрытым
    this.showReturnPlayerModal = false;
  };
  window.app.confirmReturnPlayer = function() {
    console.log('confirmReturnPlayer отключено');
    this.showReturnPlayerModal = false;
  };
}

// Финальная инициализация Telegram Web App
if (window.Telegram && window.Telegram.WebApp && window.app) {
    console.log('Финализация инициализации Telegram Web App');
    // Убираем индикатор загрузки
    window.Telegram.WebApp.ready();
    // Глобальная переменная для доступа к приложению
    window.telegramApp = window.app;
}
</script>
</body>
</html>
