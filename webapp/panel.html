<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Maf roles control panel</title>
    <script>
        // Обработка ошибок Telegram WebApp
        window.addEventListener('error', (e) => {
            if (e.filename && e.filename.includes('telegram-web-app.js')) {
                console.warn('⚠️ Ошибка в Telegram WebApp скрипте (игнорируется):', e.message);
                e.preventDefault();
            }
        });
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js" onerror="console.warn('⚠️ Не удалось загрузить Telegram WebApp скрипт')"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script><link rel="stylesheet" href="../assets/font-akrobat/css.css">
    <link rel="stylesheet" href="../assets/flex.css">    <link rel="stylesheet" href="./styles-panel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css">
    
    <!-- Стили для отключения зума и адаптации под Telegram Mini Apps -->
    <style>
        /* Отключение зума и жестов */
        * {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Разрешаем выделение текста в input полях */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        
        /* Предотвращение зума при двойном тапе */
        body {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        /* Telegram Mini Apps специфичные стили */
        .tg-app {
            height: 100vh;
            overflow-x: hidden;
        }
        
        /* Адаптация под безопасные зоны */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
<!-- 
ИЗМЕНЕНИЕ: Автоматическое применение темы Telegram ОТКЛЮЧЕНО
Теперь приложение использует только темы из панели выбора тем.
Telegram больше не переопределяет цвета приложения автоматически.
-->
<script>
// Инициализация Telegram Web App
if (window.Telegram && window.Telegram.WebApp) {
    const tg = window.Telegram.WebApp;
    
    // Расширяем приложение на весь экран
    tg.expand();
      // Отключаем zoom
    tg.disableVerticalSwipes();
    
    // Добавляем класс для Telegram приложения
    document.body.classList.add('tg-app');
      // Настройки темы отключены - используем только тему из панели
    // document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#18122b');
    // document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#f4eeff');
    // document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#b9a6e5');
    // document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#ae8cff');
    // document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#ae8cff');
    // document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
    
    // Показываем, что приложение готово
    tg.ready();
    
    // Включаем ведение журнала для отладки
    tg.enableClosingConfirmation();
    
    // Функции для работы с сессиями
    window.sessionManager = {
        // Ключ для хранения данных сессии
        SESSION_KEY: 'maf_panel_session_data',
        
        // Сохранение данных сессии
        saveSession: function(data) {
            try {
                const sessionData = {
                    ...data,
                    timestamp: Date.now()
                };
                
                // Сохраняем в localStorage
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                
                // Также сохраняем в Telegram CloudStorage если доступно
                if (tg.CloudStorage) {
                    tg.CloudStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                }
            } catch (error) {
                console.error('Ошибка сохранения сессии:', error);
            }
        },
        
        // Получение данных сессии
        getSession: function() {
            try {
                const localData = localStorage.getItem(this.SESSION_KEY);
                if (localData) {
                    return JSON.parse(localData);
                }
                return null;
            } catch (error) {
                console.error('Ошибка загрузки сессии:', error);
                return null;
            }
        },
        
        // Проверка валидности сессии (3 часа)
        isSessionValid: function(sessionData) {
            if (!sessionData || !sessionData.timestamp) {
                return false;
            }
            
            const now = Date.now();
            const sessionTime = sessionData.timestamp;
            const threeHours = 3 * 60 * 60 * 1000; // 3 часа в миллисекундах
            
            return (now - sessionTime) < threeHours;
        },
        
        // Проверка, есть ли значимые данные в сессии
        hasSignificantData: function(sessionData) {
            if (!sessionData) return false;
            
            // Проверяем, что есть комната И (турнир ИЛИ ручной режим с игроками)
            return sessionData.roomId && (
                sessionData.tournamentId || 
                (sessionData.manualMode && sessionData.manualPlayers && sessionData.manualPlayers.length > 0)
            );
        },
        
        // Очистка сессии
        clearSession: function() {
            try {
                localStorage.removeItem(this.SESSION_KEY);
                if (tg.CloudStorage) {
                    tg.CloudStorage.removeItem(this.SESSION_KEY);
                }
            } catch (error) {
                console.error('Ошибка очистки сессии:', error);
            }
        }
    };
}
</script>
<div id="app" :class="{ 'obs-cef': isObs }">
    <!-- Баннер о неактивной панели -->
    <div v-if="!isActivePanel && activePanelId && roomId"
         style="background:#e63946;color:#fff;padding:18px 10px;text-align:center;z-index:999;position:fixed;top:0;left:0;right:0;">
        <b>Внимание!</b> В этой комнате уже есть активная панель.<br>
        <button @click="activateThisPanel"
                style="margin-top:10px;padding:8px 18px;background:var(--maf-accent-color);color:#fff;border:none;border-radius:6px;cursor:pointer;">
            Сделать эту панель главной
        </button>
    </div>    <div :style="(!isActivePanel && activePanelId && roomId) ? 'margin-top:70px;' : ''">
        <!-- Модальное окно восстановления сессии -->
        <div v-if="showSessionRestoreModal" class="modal" style="z-index: 100000;">
            <div class="modal-content">
                <h2 style="text-align:center;margin-bottom:20px;color:var(--maf-accent-color);">Восстановить предыдущую сессию?</h2>
                <div style="text-align:center;margin-bottom:24px;color:#b9a6e5;font-size:1.08em;">
                    Обнаружена сессия от {{ formatSessionTime(previousSession.timestamp) }}
                </div>
                <div v-if="previousSession.roomId" style="text-align:center;margin-bottom:16px;padding:12px;background:rgba(174,140,255,0.1);border-radius:8px;">
                    <div style="color:#fff;font-weight:600;margin-bottom:8px;">Данные сессии:</div>
                    <div style="color:#b9a6e5;">Комната: <span style="color:#fff;font-weight:600;">{{ previousSession.roomId }}</span></div>
                    <div v-if="previousSession.tournamentId" style="color:#b9a6e5;">Турнир: <span style="color:#fff;font-weight:600;">{{ previousSession.tournamentId }}</span></div>
                    <div v-if="previousSession.gameSelected" style="color:#b9a6e5;">Игра: <span style="color:#fff;font-weight:600;">{{ previousSession.gameSelected }}</span></div>
                </div>
                <div class="modal-actions" style="display:flex;gap:12px;">
                    <button class="glass-btn" @click="restoreSession" style="flex:1;background:var(--maf-accent-color);border-color:var(--maf-accent-color);color:#fff;">
                        <i class="fa fa-undo" style="margin-right:8px;"></i>
                        Да, восстановить
                    </button>
                    <button class="glass-btn" @click="skipSessionRestore" style="flex:1;">
                        <i class="fa fa-times" style="margin-right:8px;"></i>
                        Нет, начать заново
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно выбора комнаты -->
        <div v-if="showRoomModal" class="modal">            <div class="modal-content">
                <h2>Введите код комнаты</h2>
                <div class="modal-fields" style="margin-top:24px;">
                    <input
                        type="text"
                        inputmode="numeric"
                        pattern="[0-9]*"
                        v-model="roomInput"
                        maxlength="4"
                        placeholder="1234"
                        style="text-align:center;"
                        @keydown.enter="joinRoom"
                        @input="roomInput = roomInput.replace(/[^0-9]/g, '')"
                    />
                    <button class="glass-btn" @click="joinRoom">Войти</button>
                </div>
            </div>
        </div>
        <!-- Модальное окно выбора режима -->        <div v-else-if="showModal" class="modal">
            <div class="modal-content">
                <h2>Добро пожаловать!</h2>
                <div class="mode-select-buttons">
                    <div
                        class="mode-btn"
                        :class="{selected: inputMode === 'gomafia'}"
                        tabindex="0"
                        @click="inputMode = 'gomafia'"
                        @keydown.enter.space="inputMode = 'gomafia'"
                        role="button"
                        aria-label="Gomafia турнир"
                    >
                        <img src="./icon/gomafia.png" alt="Gomafia турнир" />
                    </div>
                    <div
                        class="mode-btn"
                        :class="{selected: inputMode === 'manual'}"
                        tabindex="0"
                        @click="inputMode = 'manual'"
                        @keydown.enter.space="inputMode = 'manual'"
                        role="button"
                        aria-label="Ручная рассадка"
                    >
                        <img src="./icon/goruchkami.png" alt="Ручная рассадка" />
                    </div>
                </div>
                <div v-if="inputMode === 'gomafia'" class="modal-fields">
                    <input
                        type="text"
                        inputmode="numeric"
                        pattern="[0-9]*"
                        v-model="tournamentId"
                        placeholder="Номер турнира"
                        @keydown.enter="loadTournament"
                        @input="tournamentId = tournamentId.replace(/[^0-9]/g, '')"
                    >
                    <button class="glass-btn" @click="loadTournament()">Загрузить турнир</button>
                </div>
                <div v-else-if="inputMode === 'manual'" class="modal-fields">
                    <input type="number" min="1" max="15" v-model.number="manualPlayersCount" placeholder="Кол-во игроков (1-15)">
                    <button class="glass-btn" @click="createManualTable()">Создать стол</button>
                </div>
            </div>
        </div>        <!-- Модальное окно для выбора Лучшего Хода -->        <div v-if="showBestMoveModal" class="modal">
            <div class="best-move-modal-content">
                <h2>Лучший ход</h2>
                <p>Выберите трех игроков:</p>
                <div class="modal-grid">
                    <button v-for="n in 9" :key="'bm'+n"
                            class="modal-btn"
                            :class="{ selected: bestMove.includes(n) }"
                            :disabled="tableOut[n-1]?.roleKey === firstKilledPlayer"
                            @click="toggleBestMove(n)">
                        {{ n }}
                    </button>
                    <button v-if="tableOut.length >= 10"
                            class="modal-btn"
                            :class="{ selected: bestMove.includes(10) }"
                            :disabled="tableOut[9]?.roleKey === firstKilledPlayer"
                            @click="toggleBestMove(10)">
                        10
                    </button>
                </div>
                <div class="modal-actions">
                    <button class="glass-btn" @click="confirmBestMove">Принять ЛХ</button>
                </div>
            </div>
        </div>        <!-- Таблица игроков -->
        <div v-if="tableOut?.length" class="players-list">
            <div v-for="(playerData, index) in tableOut"
                 :key="playerData.roleKey"
                 class="player-row"
                 :class="{
                    'highlighted': highlightedPlayer === playerData.roleKey,
                    'killed': playerData.action === 'killed',
                    'voted': playerData.action === 'voted',
                    'removed': playerData.action === 'removed',
                    'tech-fall-removed': playerData.action === 'tech_fall_removed',
                    'fall-removed': playerData.action === 'fall_removed',
                    'mode-day': currentMode==='day',
                    'mode-night': currentMode==='night',
                    'mode-old': currentMode==='old',
                    'foul-4': currentMode==='day' && playerData.foul===4,
                    'player-inactive': ['removed','killed','voted','tech_fall_removed','fall_removed'].includes(playerData.action)
                 }"
                 :style="{'--i':index}"
                 @click="toggleHighlight(playerData.roleKey, $event)"
                 @mousedown="removeFocus($event)"
                 @touchstart="removeFocus($event)"
            >
                <div class="player-row-content">
                    <b class="flex-fixed player-num">{{index + 1}}</b>
                    <div class="avatar-uploader flex-fixed">
                        <div class="avatar" :style="{backgroundImage: playerData.avatarCss}"></div>
                        <div v-if="avatarExHas(playerData.roleKey)" class="avatar-x" @click.stop="avatarExSet(playerData.roleKey)">
                            <i class="fa fa-times"></i>
                        </div>
                        <div class="hovered" @click.stop="avatarExLoad(playerData.roleKey)">
                            <i class="fa fa-camera"></i>
                            <input type="file" accept="image/*" @change="onAvatarExUpload($event, playerData.roleKey)" ref="fileInputs" />
                        </div>
                    </div>
                    <template v-if="manualMode">
                        <template v-if="manualGameSelected === 1">
                            <input class="input-compact" v-model="manualPlayers[index].login" placeholder="Имя игрока">
                        </template>
                        <template v-else>
                            <select v-model="manualPlayers[index].login" @change="onManualSelectPlayer(index)">
                                <option value="">— Новый игрок —</option>
                                <option v-for="(p, idx) in firstGamePlayers" :value="p.login">{{p.login}}</option>
                            </select>
                        </template>
                    </template>
                    <div v-else class="text-ellipsis player-name">{{playerData.login}}</div>
                    <div class="role-badges-right">
                        <!-- Кнопка Вернуть игрока для удалённого -->
                        <template v-if="['removed','killed','voted','tech_fall_removed','fall_removed'].includes(playerData.action)">
                            <button class="role-button return-player-btn return-btn" @click.stop="clearPlayerStatus(playerData.roleKey)" title="Вернуть игрока">❤️</button>
                        </template>
                        <template v-else>
                        <!-- Режим Роли -->
                        <template v-if="currentMode==='roles'">
                            <button class="glass-btn role-button" :class="{ active: playerData.role === 'don' }" @click.stop="roleSet(playerData.roleKey, 'don')" title="Дон">Д</button>
                            <button class="glass-btn role-button" :class="{ active: playerData.role === 'black' }" @click.stop="roleSet(playerData.roleKey, 'black')" title="Мафия">М</button>
                            <button class="glass-btn role-button" :class="{ active: playerData.role === 'sheriff' }" @click.stop="roleSet(playerData.roleKey, 'sheriff')" title="Шериф">Ш</button>
                        </template>
                        <!-- Режим День -->
                        <template v-if="currentMode==='day'">
                            <button class="role-button day-tools" @click.stop="toggleRemove(playerData.roleKey)" :title="playerData.action==='removed'?'Вернуть':'Удалить'">
                                <i class="fa fa-ban"></i>
                            </button>
                            <button class="role-button day-tools" @click.stop="toggleTechFoul(playerData.roleKey)" :title="playerData.techFoul===0?'Тех.фол':'ТФ'+playerData.techFoul">
                                ⚡<span v-if="playerData.techFoul>0">{{playerData.techFoul}}</span>
                            </button>
                            <button class="role-button day-tools" @click.stop="toggleFoul(playerData.roleKey)" :title="'Фол ('+playerData.foul+')'">
                                ⚠️<span v-if="playerData.foul>0">{{playerData.foul}}</span>
                            </button>
                        </template>
                        <!-- Режим Ночь -->
                        <template v-if="currentMode==='night'">
                            <button class="role-button night-tools" @click.stop="actionSet(playerData.roleKey, 'killed', { nightKill: true })" :class="{active: playerData.action==='killed'}" title="Убить">
                                <i class="mdi mdi-crosshairs-gps"></i>
                            </button>
                        </template>
                        </template>
                    </div>
                </div>                <transition name="slide-fade">
                    <div v-if="highlightedPlayer === playerData.roleKey" class="candidate-menu">                        <!-- Таймер секция -->
                        <div class="timer-section">
                            <div class="timer-display" :class="{ 
                                running: getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused,
                                warning: getTimerDisplay(playerData.roleKey).timeLeft <= 10 && getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused
                            }">
                                {{ formatTimerTime(getTimerDisplay(playerData.roleKey).timeLeft) }}
                            </div>
                            <div class="timer-controls">
                                <button 
                                    class="timer-btn timer-start"
                                    :disabled="getTimerDisplay(playerData.roleKey).isRunning && !getTimerDisplay(playerData.roleKey).isPaused"
                                    @click.stop="handleTimerStart(playerData.roleKey)"
                                    :title="getTimerDisplay(playerData.roleKey).isPaused ? 'Продолжить' : 'Старт'">
                                    <i class="fa fa-play"></i>
                                </button>
                                <button 
                                    class="timer-btn timer-pause"
                                    :disabled="!getTimerDisplay(playerData.roleKey).isRunning || getTimerDisplay(playerData.roleKey).isPaused"
                                    @click.stop="pausePlayerTimer(playerData.roleKey)"
                                    title="Пауза">
                                    <i class="fa fa-pause"></i>
                                </button>
                                <button 
                                    class="timer-btn timer-add"
                                    :class="{ disabled: !isAddTimeButtonAvailable(playerData.roleKey) }"
                                    :disabled="!isAddTimeButtonAvailable(playerData.roleKey)"
                                    @click.stop="addThirtySecondsToTimer(playerData.roleKey)"
                                    title="Добавить 30 секунд">
                                    +30
                                </button>
                                <button 
                                    class="timer-btn timer-stop"
                                    @click.stop="stopPlayerTimer(playerData.roleKey)"
                                    title="Стоп">
                                    <i class="fa fa-stop"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Сетка кандидатов -->
                        <div class="candidate-grid">
                            <button v-for="n in tableOut.length"
                                    :key="'cand'+n"
                                    class="candidate-btn"
                                    :class="candidateButtonClass(playerData.roleKey, n)"
                                    :disabled="isCandidateButtonDisabled(playerData.roleKey, n)"
                                    @click.stop="toggleNomination(playerData.roleKey, n)">
                                {{ n }}
                            </button>
                        </div>
                        <div v-if="nominations[playerData.roleKey] && nominations[playerData.roleKey].length" style="margin-top:10px;text-align:center;font-weight:600;color:var(--maf-accent-color);font-size:1.08em;">
                            Выставлен: <span style="font-size:1.18em;">{{ nominations[playerData.roleKey][0] }}</span>
                        </div>
                    </div>
                </transition>
            </div>
        </div>
        <!-- Заголовок голосования -->
        <div v-if="tableOut?.length" style="text-align:center;font-weight:700;font-size:1.18em;margin:18px 0 6px 0;">Голосование</div>
        <!-- Кнопки истории и начала голосования -->
        <div v-if="tableOut?.length" style="display:flex;justify-content:center;gap:2px;margin:0 0 18px 0;">
            <button class="glass-btn" @click="showVotingHistory = true; activeVotingTab = Math.max(0, votingHistory.length - 1)" style="flex:1 1 0;min-width:0;">
                <i class="fa fa-history" style="margin-right:8px;"></i>
                История
            </button>
            <button class="glass-btn" @click="startVoting" style="flex:1 1 0;min-width:0;">
                <i class="fa fa-thumbs-up" style="margin-right:8px;"></i>
                Начать
            </button>
        </div>
        <!-- Заголовок победителей -->
        <div v-if="tableOut?.length" style="text-align:center;font-weight:700;font-size:1.18em;margin:18px 0 6px 0;">Победили</div>
        <!-- Кнопки победившей команды -->
        <div v-if="tableOut?.length" class="winner-team-row"
             style="display:flex;justify-content:center;gap:18px;padding:10px 0 10px 0;box-shadow:0 -2px 18px 0 rgba(0,0,0,0.08);margin-bottom:8px;">
            <button :class="['glass-btn', winnerTeam === 'civilians' ? 'active' : '']" @click="setWinnerTeam('civilians')" style="min-width:120px;">
                <i class="mdi mdi-account-group" style="margin-right:8px;"></i>
                Мирные
            </button>
            <button :class="['glass-btn', winnerTeam === 'mafia' ? 'active' : '']" @click="setWinnerTeam('mafia')" style="min-width:120px;">
                <i class="mdi mdi-skull" style="margin-right:8px;"></i>
                Мафия
            </button>
            <button v-if="winnerTeam" class="glass-btn" @click="setWinnerTeam(null)" style="min-width:60px;background:#ff5370;border-color:#ff5370;" title="Сбросить">
                <i class="fa fa-times"></i>
            </button>
        </div>        <!-- Кнопки настроек и тем -->
        <div class="settings-btn-container" v-if="tableOut?.length" style="display:flex;justify-content:center;gap:18px;margin-bottom:18px;">
            <button class="settings-btn" @click="showSettingsModal = true" title="Настройки">
                <i class="fa fa-cog" style="color:#b9a6e5;font-size:1.45em;"></i>
            </button>
            <button class="themes-btn" @click="showThemeModal = true" title="Темы" style="margin-left:18px;">
                <i class="fa fa-palette" style="color:#ffd700;font-size:1.45em;"></i>
            </button>
        </div>
        
        <!-- Панель выбора игры и стола (исправлена логика и изменен порядок) -->
        <div v-if="tableOut?.length" class="game-table-panel">
            <div class="flex flex-center">
                <!-- Сначала стол -->
                <div v-if="!manualMode && gameSelectedObject && gameSelectedObject.length" class="flex flex-center">
                    <span class="label">Стол:</span>
                    <select v-model.number="tableSelected">
                        <option v-for="(tableEl, index) in gameSelectedObject" :value="Number(tableEl.tableNum)">
                            Стол {{tableEl.tableNum}}
                        </option>
                    </select>
                </div>                <!-- Потом игра -->
                <div class="flex flex-center">
                    <span class="label">Игра:</span>
                    <select
                        v-if="manualMode"
                        v-model.number="manualGameSelected"
                        @change="onGameSelectChange($event)">
                        <option v-for="game in manualGames" :value="game.num">
                            Игра {{game.num}}
                        </option>
                        <option value="new">+ Новая игра</option>
                    </select>
                    <select
                        v-else
                        v-model.number="gameSelected"
                        @change="onGameSelectChange($event)">
                        <option v-for="game in games" :value="game.gameNum">
                            Игра {{game.gameNum}}
                        </option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно настроек -->        <div v-if="showSettingsModal" class="modal" @click.self="showSettingsModal = false">
            <div class="settings-modal-content">
                <h2>Настройки</h2>
                <div class="settings-modal-scroll">
                    <div class="switches-bottom" style="margin-bottom:16px;">
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="mainInfoVisible" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Основная информация</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="additionalInfoVisible" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Доп. информация</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideSeating" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Скрыть рассадку</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideLeaveOrder" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Скрыть порядок ухода</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideRolesStatus" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Скрыть роли и статус</span>
                        </label>
                        <label class="m3e-switch">
                            <input type="checkbox" v-model="hideBestMove" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Скрыть ЛХ</span>
                        </label>                        <label class="m3e-switch">                            <input type="checkbox" v-model="showRoomNumber" @change="panelStateChanged">
                            <span class="slider"></span>
                            <span>Показать номер комнаты</span>
                        </label>
                    </div><div class="modal-actions" style="flex-direction:column;gap:8px;">
                        <button class="glass-btn" @click="playersLoad()">Загрузить данные игроков</button>
                        <button class="glass-btn" @click="playersLoadOnline()">Перезагрузить аватары</button>
                        <button class="glass-btn" @click="refreshPage()">Обновить страницу</button>
                        <button class="glass-btn" style="background:#ff5370;border-color:#ff5370;" @click="reset()">Сбросить</button>
                    </div>
                    <div v-if="tableOut?.length && manualMode" class="modal-actions">
                        <button class="glass-btn" @click="resetManualMode()">Вернуться к выбору режима</button>
                    </div>
                </div>
            </div>
        </div>        <!-- Модальное окно Темы -->        <div v-if="showThemeModal" class="modal" @click.self="showThemeModal = false" style="z-index:99999;">
            <div class="theme-modal-content">
                <div style="text-align:center;font-size:1.18em;font-weight:700;margin-bottom:12px;letter-spacing:.02em;color:#b9a6e5;">
                    {{ colorSchemes.find(s=>s.key===selectedColorScheme)?.name || '' }}
                </div>
                <div class="theme-modal-scroll" style="max-height:48vh;overflow-y:auto;">
                    <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; width:100%;">                        <div v-for="scheme in colorSchemes"
                             :key="scheme.key"
                             :title="scheme.name"
                             @click="applyColorSchemeAndSave(scheme.key)"
                             :style="{
                                border: selectedColorScheme === scheme.key ? '4px solid #fff' : '2px solid var(--maf-accent-color)',
                                borderRadius: '14px',
                                cursor: 'pointer',
                                width: '54px',
                                height: '54px',
                                boxShadow: selectedColorScheme === scheme.key
                                    ? '0 0 18px 5px #fff, 0 0 0 4px ' + scheme.accent + ', 0 0 8px 1px var(--maf-accent-color-44)'
                                    : '0 0 8px 1px var(--maf-acцент-color-44)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                background: scheme.preview,
                                position: 'relative',
                                outline: selectedColorScheme === scheme.key ? '3px solid ' + scheme.accent : 'none',
                                outlineOffset: selectedColorScheme === scheme.key ? '2px' : '0'
                             }">
                            <span style="font-size:1.1em; color:#fff; text-shadow:0 1px 4px #0008; font-weight:700;">
                                {{scheme.icon || '★'}}
                            </span>
                            <span v-if="selectedColorScheme === scheme.key"
                                  style="position:absolute;bottom:3px;right:6px;font-size:1.25em;color:#fff;text-shadow:0 0 8px #000;">✔</span>
                        </div>
                    </div>
                </div>
                <div style="margin:18px 0 8px 0;text-align:center;font-size:1.08em;font-weight:600;color:#b9a6e5;">
                    Фон панели и элементов
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; width:100%;margin-bottom:10px;">
                    <div v-for="theme in backgroundThemes"                         :key="theme.key"
                         :title="theme.name"
                         @click="applyBackgroundThemeAndSave(theme.key)"
                         :style="{
                            border: selectedBackgroundTheme === theme.key ? '4px solid #fff' : '2px solid var(--maf-accent-color)',
                            borderRadius: '14px',
                            cursor: 'pointer',
                            width: '54px',
                            height: '54px',
                            boxShadow: selectedBackgroundTheme === theme.key
                                ? '0 0 18px 5px #fff, 0 0 0 4px var(--maf-accent-color), 0 0 8px 1px var(--maf-acцент-color-44)'
                                : '0 0 8px 1px var(--maf-acцент-color-44)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            background: theme.bgMain,
                            position: 'relative',
                            outline: selectedBackgroundTheme === theme.key ? '3px solid var(--maf-accent-color)' : 'none',
                            outlineOffset: selectedBackgroundTheme === theme.key ? '2px' : '0'
                         }">
                        <span style="font-size:1.1em; color:#fff; text-shadow:0 1px 4px #0008; font-weight:700;">
                            {{theme.icon}}
                        </span>
                        <span v-if="selectedBackgroundTheme === theme.key"
                              style="position:absolute;bottom:3px;right:6px;font-size:1.25em;color:#fff;text-shadow:0 0 8px #000;">✔</span>
                    </div>
                </div>                <div class="modal-actions">
                    <button class="glass-btn" @click="showThemeModal = false">Закрыть</button>
                </div>
            </div>
        </div>        <!-- Модальное окно голосования --><div v-if="showVotingModal" class="modal">
            <div class="voting-modal-content">
                <div class="voting-header" style="width:100%;">
                    <div class="voting-header-title">Выставленны:</div>
                    <div class="voting-header-order">
                        <span v-for="(candidate, idx) in votingOrder" :key="candidate"
                              :class="['voting-header-candidate', {active: votingCurrentIndex === idx}]">
                            {{ candidate }}
                        </span>
                    </div>
                </div>
                <div class="voting-question">
                    <template v-if="votingStage === 'main'">
                        Кто голосует за <b>№{{ votingOrder[votingCurrentIndex] }}</b>
                    </template>
                    <template v-else-if="votingStage === 'tie'">
                        <span style="font-size:1.08em;font-weight:700;">Повторное голосование</span><br>
                        Кто голосует за <b>№{{ votingOrder[votingCurrentIndex] }}</b>
                    </template>
                    <template v-else-if="votingStage === 'lift'">
                        Кто за подъем кандидатов?
                    </template>
                </div>                <div v-if="votingStage === 'main' || votingStage === 'tie'" class="modal-grid">
                    <button v-for="n in 10"
                            :key="'vote'+n"
                            :class="getVotingButtonClass(n)"
                            :disabled="!isVotingButtonEnabled(n)"
                            @click="toggleVotingSelection(n)">
                        {{ n }}
                    </button>
                </div>
                <div v-else-if="votingStage === 'lift'" class="modal-grid">
                    <button v-for="n in 10"
                            :key="'lift'+n"
                            class="modal-btn"
                            :class="{selected: votingLiftResults.includes(n)}"
                            :disabled="!isLiftVotingButtonEnabled(n)"
                            @click="toggleLiftVotingSelection(n)">
                        {{ n }}
                    </button>
                </div>
                <div v-if="votingNotification" style="color:var(--md3-error);margin-bottom:8px;text-align:center;font-weight:700;">{{ votingNotification }}</div>
                <div class="modal-actions">
                    <button v-if="votingCurrentIndex > 0" class="glass-btn" @click="prevVoting">
                        Назад
                    </button>
                    <button class="glass-btn" @click="acceptCurrentCandidateVotes" :disabled="acceptDisabled">
                        Принять
                    </button>
                </div>                <div v-if="shouldShowFinishButton" style="margin-top: 12px;">
                    <!-- Если есть победители - показываем кнопку завершения -->
                    <button v-if="votingWinners && votingWinners.length" 
                            class="glass-btn" 
                            style="background:var(--maf-accent-color);color:#fff;width:100%;" 
                            @click="closeVotingModalAndApplyResults">
                        Завершить голосование
                    </button>
                    
                    <!-- Если никто не получил голосов -->
                    <button v-else 
                            class="glass-btn" 
                            style="background:var(--md3-error);color:#fff;width:100%;" 
                            @click="closeVotingModalAndApplyResults">
                        Завершить голосование (никого не заголосовали)
                    </button>
                </div>                <div class="voting-result">
                    <div v-if="votingWinners && votingWinners.length">
                        Заголосовали: {{ votingWinners.join(', ') }}
                    </div>
                    <div v-else-if="votingStage !== 'main' && votingTiePlayers && votingTiePlayers.length > 1">
                        {{ votingStage === 'tie' ? 'Повторное голосование' : 'Голосование за подъем' }} среди: {{ votingTiePlayers.join(', ') }}
                    </div>
                    <div v-else>
                        Никого не заголосовали
                    </div>
                </div>
            </div>
        </div>        <!-- Модальное окно истории голосования -->        <div v-if="showVotingHistory" class="modal">
            <div class="modal-content">
                <h2>История голосований</h2>
                
                <div v-if="votingHistory && votingHistory.length">                    <!-- Вкладки для каждого голосования в стиле браузерных вкладок -->
                    <div class="voting-tabs-container">
                        <div class="voting-tabs">
                            <button 
                                v-for="(voting, index) in votingHistory" 
                                :key="'tab_' + index"
                                @click="activeVotingTab = index"
                                :class="['voting-tab', { 'active': activeVotingTab === index }]"
                            >
                                <span class="tab-title">#{{ voting.votingNumber }}</span>
                                <span class="tab-close" v-if="false">×</span>
                            </button>
                        </div>
                    </div>
                      <!-- Содержимое активной вкладки -->
                    <div class="modal-scroll" v-if="votingHistory[activeVotingTab]">
                        <div class="voting-session" style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <h3 style="color: var(--maf-accent-color); margin-bottom: 15px; text-align: center;">
                                Голосование {{ votingHistory[activeVotingTab].votingNumber }}
                            </h3>
                            
                            <!-- Список выставленных кандидатов -->
                            <div v-if="votingHistory[activeVotingTab].nominees && votingHistory[activeVotingTab].nominees.length" 
                                 style="margin-bottom: 20px; padding: 12px; background: rgba(174,140,255,0.1); border-radius: 8px; border-left: 4px solid var(--maf-accent-color);">
                                <h4 style="color: var(--maf-acцент-color); margin-bottom: 8px; font-size: 1em; font-weight: 600;">
                                    📋 Выставленные кандидаты:
                                </h4>
                                <div style="color: #fff; font-size: 1.1em; font-weight: 500;">
                                    {{ votingHistory[activeVotingTab].nominees.join(', ') }}
                                </div>
                            </div>
                            
                            <!-- Перебираем все этапы голосования -->
                            <div v-for="(stage, stageIndex) in votingHistory[activeVotingTab].stages" :key="'stage_' + stageIndex" class="voting-stage" style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px; border-left: 4px solid var(--maf-accent-color);">
                                <h4 style="color: #b9a6e5; font-size: 1.2em; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                                    <span style="margin-right: 10px;">{{ stage.stageName }}</span>
                                    <span style="background: rgba(174,140,255,0.3); padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                                        Этап {{ stageIndex + 1 }}
                                    </span>
                                </h4>
                                
                                <!-- Результаты голосования (для main и tie) -->
                                <div v-if="stage.type !== 'lift'" style="margin-left: 10px;">
                                    <div v-for="candidate in stage.order" :key="'candidate_' + candidate" style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <strong style="color: var(--maf-accent-color); font-size: 1.1em;">Игрок №{{ candidate }}</strong>
                                            <span style="background: rgba(174,140,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.9em; color: white;">
                                                {{ stage.results[candidate] ? stage.results[candidate].length : 0 }} голосов
                                            </span>
                                        </div>
                                        <div style="color: #fff; font-size: 0.95em;">
                                            <span style="color: #b9a6e5;">Голосовали:</span>
                                            {{ stage.results[candidate] && stage.results[candidate].length ? stage.results[candidate].join(', ') : 'Никто' }}
                                        </div>                                        <!-- Показываем, если этот кандидат победил на данном этапе -->
                                        <div v-if="stage.winners && stage.winners.includes(candidate)" style="margin-top: 8px; color: var(--md3-success); font-weight: 600; font-size: 0.9em;">
                                            ✓ Заголосованный игрок
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Результаты голосования за подъем -->
                                <div v-else style="margin-left: 10px;">
                                    <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <strong style="color: var(--maf-accent-color); font-size: 1.1em;">Голосование за подъем</strong>
                                            <span style="background: rgba(174,140,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.9em; color: white;">
                                                {{ stage.liftResults ? stage.liftResults.length : 0 }} голосов
                                            </span>
                                        </div>
                                        <div style="color: #fff; font-size: 0.95em;">
                                            <span style="color: #b9a6e5;">За подъем голосовали:</span>
                                            {{ stage.liftResults && stage.liftResults.length ? stage.liftResults.join(', ') : 'Никто' }}
                                        </div>
                                        <!-- Показываем результат голосования за подъем -->
                                        <div v-if="stage.winners && stage.winners.length" style="margin-top: 8px; color: var(--md3-success); font-weight: 600; font-size: 0.9em;">
                                            ✓ Игроки {{ stage.order.join(', ') }} заголосованы
                                        </div>
                                        <div v-else style="margin-top: 8px; color: var(--md3-error); font-weight: 600; font-size: 0.9em;">
                                            ✗ Игроки {{ stage.order.join(', ') }} остаются в игре
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Финальный результат голосования -->
                            <div class="final-result" style="margin-top: 25px; padding: 15px; border-radius: 12px; text-align: center;" 
                                 :style="votingHistory[activeVotingTab].finalWinners && votingHistory[activeVotingTab].finalWinners.length ? 
                                         'background: rgba(111,231,183,0.2); border: 2px solid var(--md3-success);' : 
                                         'background: rgba(255,83,112,0.2); border: 2px solid var(--md3-error);'">
                                <h4 style="margin-bottom: 10px;" 
                                    :style="votingHistory[activeVotingTab].finalWinners && votingHistory[activeVotingTab].finalWinners.length ? 
                                            'color: var(--md3-success);' : 'color: var(--md3-error);'">
                                    🏆 ИТОГОВЫЙ РЕЗУЛЬТАТ
                                </h4>
                                <div v-if="votingHistory[activeVotingTab].finalWinners && votingHistory[activeVotingTab].finalWinners.length" 
                                     style="color: #fff; font-weight: 600; font-size: 1.1em;">
                                    Заголосованы игроки: {{ votingHistory[activeVotingTab].finalWinners.join(', ') }}
                                </div>
                                <div v-else style="color: #fff; font-weight: 600; font-size: 1.1em;">
                                    Никого не заголосовали
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else style="text-align: center; color: #b9a6e5; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">📋</div>
                    <div style="font-size: 1.2em;">История голосований пуста</div>
                    <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.7;">Проведите первое голосование, и оно появится здесь</div>
                </div>
                <div class="modal-actions">
                    <button class="glass-btn" @click="showVotingHistory = false">Закрыть</button>
                </div>
            </div>        </div>    </div>
    
    <!-- Фиксированная нижняя панель режимов -->
    <!-- Liquid Glass Navigation Bar -->
    <div v-if="tableOut?.length" id="bottom-bar" class="glass-content glass-content--nav">
        <button :class="['glass-item', { 'glass-item--active': currentMode==='roles' }]" @click="setMode('roles')">
            <span>Роли</span>
        </button>
        <button :class="['glass-item', { 'glass-item--active': currentMode==='day' }]" @click="setMode('day')">
            <span>День</span>
        </button>
        <button :class="['glass-item', { 'glass-item--active': currentMode==='night' }]" @click="setMode('night')">
            <span>Ночь</span>
        </button>    </div>

    <!-- Модальное окно подтверждения возврата игрока - УДАЛЕНО -->

</div>
<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
<script src="./voting.js"></script>
<script src="./timer.js"></script>
<script src="./session-manager.js"></script>

<!-- Модульная система приложения - загружаем в правильном порядке -->
<script src="./app-connector.js"></script>
<script src="./app-data.js"></script>
<script src="./app-sessions.js"></script>
<script src="./app-game-logic.js"></script>
<script src="./app-ui-integration.js"></script>
<script src="./app-core.js"></script>

<script src="./assets/panel-notification.js"></script>
<script>
// Гарантируем, что editVotingHistory определён в основном Vue-инстансе
if (window.app && typeof window.app.editVotingHistory === 'undefined') {
    window.app.editVotingHistory = false;
}

if (window.app) {
  // Заглушки функций для совместимости (модальное окно отключено)
  window.app.showReturnPlayerModal = function(number, roleKey) {
    console.log('showReturnPlayerModal отключено');
    // Гарантируем, что модальное окно остается скрытым
    this.showReturnPlayerModal = false;
  };
  window.app.confirmReturnPlayer = function() {
    console.log('confirmReturnPlayer отключено');
    this.showReturnPlayerModal = false;
  };
}

// Финальная инициализация Telegram Web App
if (window.Telegram && window.Telegram.WebApp && window.app) {
    console.log('Финализация инициализации Telegram Web App');
    // Убираем индикатор загрузки
    window.Telegram.WebApp.ready();
    // Глобальная переменная для доступа к приложению
    window.telegramApp = window.app;
}
</script>
</body>
</html>